# 実践用メモ

## 関与媒質

- ローカル
  - 密度テクスチャあり/なし[@Hillaire2015]
  - 3Dテクスチャ付きOBB[@Lagarde2018]
- グローバル
  - 高さフォグ[@Wronski2014; @Hillaire2015]
    - 重い粒子を表現する
    - 指数分布に従って地表面付近に集まる
  - 深さフォグ[@Hillaire2015]
  - 境界なし[@Lagarde2018]
- プロシージャル
  - 1オクターブのパーリンノイズ[@Wronski2014]
    - 風による揺れを表現する
    - 1オクターブ以上にもできるが、増加するコストに対して見た目の変化が少ない

## ストレージ

- 160x90x64または160x90x128のRGBA16F[@Wronski2014]
  - RGB：in-scatteringのライティング結果
  - A：散乱係数
- 8x8タイル、64深度スライスのRGBA16F[@Hillaire2015]
  - 720pでは160x90x64、1080pでは240x135x64
  - Vバッファ：関与媒質の特性を格納する2つのRGBA16F
    - RGB：散乱係数の総和、A：消散係数の総和
    - RGB：Emissiveの総和、A：位相$g$の平均
  - 散乱光と透過率を格納する1つのRGBA16F
    - RGB：カメラへの散乱光
    - A：消散
- 192x108x64(PS4)または240x135x64(PS4 Pro)[@Caurant2018]

## 深度分布

- 対数分布と線形分布の間をパラメータで調整できる[@Lagarde2018]

## 位相関数

- アートドリブン[@Wronski2014]
  - 互いに反対方向を向く2色（太陽方向とその反対方向）から成る
  - 完全に等方的
- Henyey-Greensteinの位相関数[@Hillaire2015]
  - Zonal SHに展開できる
    - Zonal SHの回転は自明
- Cornette-Shanksの異方的位相関数[@Lagarde2018]
  - HG位相関数と比べてMie散乱の真の位相関数により良い一致を見せる
  - グローバルなパラメータを使う[@Lagarde2018]

## ライティング

- 間接光
  - 位相関数とGIのSH乗法的積分を計算する[@Wronski2014; @Hillaire2015]
    - HG位相関数を視線ベクトルで回転させる
    - ボリューム中心にあるライトプロブ1つを用いる[@Hillaire2015]
- 太陽光
  - カスケードシャドウマップをサンプルする[@Hillaire2015]
- ローカルライト
  - タイルベース[@Hillaire2015]
    - カリング済みライトリストを再利用する

## 積分

- froxel内の散乱光を解析的に積分する[@Hillaire2015]
  - $\int_0^D e^{-\sigma_t x} \times S dx = \frac{S - S \times e^{\sigma_t D}}{\sigma_t}$
- ライトリークを修正する[@Caurant2018]
  - タイルごとの最小最大深度でボクセルの厚さをクランプする
  - サンプリングにZバイアスを適用する（しきい値はタイル深度の分散より小さい）
- モンテカルロ積分[@Lagarde2018]
  - 重点サンプリングで分散低減を図る
    - ディレクショナルライト：解析的自由工程サンプリング
    - パンクチュアルライト：等角サンプリング
    - エリアライト：nullサンプリング

## テンポラル積分

- テンポラル積分[@Hillaire2015]
  - Halton列を用いてサンプルをジッタリングする
  - 前回の散乱光と消散を再投影して5%だけブレンドする
    - 指数移動平均[@Karis2014]を用いる
- 青色ノイズでジッタリングするTAA[@Caurant2018]
- テンポラル積分[@Lagarde2018]
  - 1フレームにボクセルあたり1サンプルを取る
  - 前のフレームと指数加重平均で組み合わせる
