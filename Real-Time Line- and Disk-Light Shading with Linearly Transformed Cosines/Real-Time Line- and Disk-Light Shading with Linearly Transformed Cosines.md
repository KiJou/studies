---
title: Real-Time Line- and Disk-Light Shading with Linearly Transformed Cosines [@Heitz2017]
---
# Real-Time Line- and Disk-Light Shading with Linearly Transformed Cosines

# はじめに

# はじめに

昨年: **LTC**を用いたリアルタイム多角形ライトのシェーディング

Real-Time Polygonal-Light Shading with Linearly Transformed Cosines (理論)
Real-Time Area Lighting: a Journey from Research to Production (実践)

# はじめに

今年: LTCを用いたリアルタイムエリアライトの新種

# はじめに

昨年: 多角形に対するLTCの積分

球面の多角形
LTCによって近似されるBRDF
解析的積分

そのシェーディングはライトによってカバーされる球面領域[spherical domain]上でのBRDFの積分の計算である。LTCの主な特性は球面の多角形上で解析的に積分できることである。これは、多角形ライトのシェーディングのための有用なツールとなる。

これは直観とLTCの式がどのようにして発明されたかを示す。我々は多角形光源上で積分しやすいであろうことを確実にするためにこの分布を作り上げた。この分布はこの固有のライトタイプに対するものであることを元来は意味していた。

# はじめに

今年: その他のプリミティブに対するLTC積分

球面の線分
LTCによって近似されるBRDF
解析的積分

より多くのライトタイプをサポートするため、我々はLTCが他の種類の球面領域上で積分することもできるかどうかを調査しなければならなかった。

このスライドでは、我々は線ライトの場合を確認できる。これは、球面の線分を生成する。線分は概念的に多角形に近く、すなわち、多数ではなく2つの頂点で定義されるが、線上でLTCを積分することは多角形上と同様の方法では行えない。

我々はこのケースのための解析的な積分の式を解くことができた。これは、多角形に対する積分の式のように見えるが、幾分か異なる。

# はじめに

今年: 他のプリミティブに対するLTC積分

球面の楕円
LTCによって近似されるBRDF
近似的な解析的積分

球や円板のライティングの場合、考慮すべき球面鏡域は球面の楕円である。この問題は多角形や線に対するそれと非常に似ているように見えるのだが、球面の楕円はある種の非常に難しい計算を伴う。

この場合では、我々は厳密な解析的な積分の式を見つけることができなかったが、十分に正確なものを解いた。

# はじめに

このトークの構成

- LTCの復習(さらなる詳細は昨年の資料を参照のこと)
- 線ライト
- 球/円板ライト

# LTCの復習

# LTCの復習

分布$D$ $\Leftrightarrow$ 線$L$

LTCがどのように定義されるかを理解するために、我々は以下の直観を用いる。球面分布はこの分布から選択できるサンプルの無限集合と等価である。

- 球面分布を持つならば、この分布における無数のサンプルを生成できる。
- 無数のサンプルを持つならば、任意の精度にその分布を再構築できる。

分布とサンプルは説明の仕方が異なるだけで同じ数学的対象[mathematical object]である。

注意: 図示するために、図には5つのサンプルだけを描いたが、概念的に我々はサンプルの無限集合について話していることを覚えていて欲しい。以下では、$5=\infty$と単に仮定する。 :-)

# LTCの復習

分布$D$ $\Leftrightarrow$ 線$L$

これらは同じ対象であるので、片方を変更すればもう一方も変化する。分布のパラメータを変更すれば、サンプルはそれに従う。対称的に、サンプルを動かせば、再構築される分布はそれに従う。

分布とサンプルは同じ数学的対象の二重の説明であるので、分布に関連する特性は通常サンプルに関連する二重の特性を持つことを意味し、逆もまた真である。

LTCのアイデアはサンプルの方向、それ即ち、分布を変更する線形変換(3x3行列)を用いることである。

# LTCの復習

コサイン

まず、我々はこの古典的なコサイン分布から始める。この図では、線形変換の効果を可視化することを用意にするために5つのサンプルを重ね書きした。

# LTCの復習

コサイン

ラフネス
$\left[ \begin{array}{ccc} \lambda & 0 & 0 \\ 0 & \lambda & 0 \\ 0 & 0 & 1 \end{array} \right]$

xy平面上のみのスケーリング変換を適用する場合、サンプルが分布の平均の方向に向かって集まってゆくことを確認できる。これはコサインから始めてPhong的な分布を作る方法である。

可視化を促すため、同じ線形変換を適用させている単位立方体も示す。

# LTCの復習

コサイン

ラフネス
$\left[ \begin{array}{ccc} \lambda & 0 & 0 \\ 0 & \lambda & 0 \\ 0 & 0 & 1 \end{array} \right]$

異方性
$\left[ \begin{array}{ccc} \lambda_x & 0 & 0 \\ 0 & \lambda_y & 0 \\ 0 & 0 & 1 \end{array} \right]$

xとy方向に異なる大きさでスケーリング変換を適用すると、サンプルがひとつの方向にさらに集まってゆくことを確認できる。これは、分布の異方性を引き起こす。

# LTCの復習

コサイン

ラフネス
$\left[ \begin{array}{ccc} \lambda & 0 & 0 \\ 0 & \lambda & 0 \\ 0 & 0 & 1 \end{array} \right]$

異方性
$\left[ \begin{array}{ccc} \lambda_x & 0 & 0 \\ 0 & \lambda_y & 0 \\ 0 & 0 & 1 \end{array} \right]$

スキュー
$\left[ \begin{array}{ccc} 1 & 0 & 0 \\ 0 & 1 & 0 \\ \lambda & 0 & 1 \end{array} \right]$

せん断[shear]変換を適用すると、分布のある側ではサンプルを広げ、その反対側ではサンプルを集める。これは分布のスキュー[skewness]を引き起こしている。

# LTCの復習

コサイン

ラフネス
$\left[ \begin{array}{ccc} \lambda & 0 & 0 \\ 0 & \lambda & 0 \\ 0 & 0 & 1 \end{array} \right]$

異方性
$\left[ \begin{array}{ccc} \lambda_x & 0 & 0 \\ 0 & \lambda_y & 0 \\ 0 & 0 & 1 \end{array} \right]$

スキュー
$\left[ \begin{array}{ccc} 1 & 0 & 0 \\ 0 & 1 & 0 \\ \lambda & 0 & 1 \end{array} \right]$

ランダム

最後に、ランダム行列でこれらすべての効果を組み合わせることによって、おかしな形状を持つ洗練された球面分布を作ることができる。

# LTCの復習

BRDF (Smith GGX)

Linearly Transformed Cosines (フィッティング済み)

この定義により、Linearly Transformed Cosinesは物理ベースBRDF、特にこんにちの多くのゲームエンジンで使われるGGXのそれを効率的に近似するのに使える広い表現の幅[wide appearance space]を提供する。もちろん、その近似は完璧ではないが、様々なラフネスや入射光の構成に対してBRDFの主な特徴を再現する。

# LTCの復習

コサイン✓ ← $M^{-1}$ ← Linearly Transformed Cosine

この定義から、多角形上でLTCを積分するためのアルゴリズムも得る。$M$がコサインからこのLTC分布を得るために用いる線形変換である場合、LTC分布と多角形の両方に逆線形変換$M^{-1}$を適用する。オリジナルのコサインと新しい多角形を得る。

# LTCの復習

$M^{-1} P$ $\overset{M^{-1}}{\leftarrow}$ $P$

$\int_{M^{-1} P} \text{cosine}(\omega) d\omega = \int_{P} \text{LTC}(\omega) d\omega$

その重要な特性は多角形上のLTCの積分がちょうど$M^{-1}$で変換された多角形の積分とそのコサインとなることである。これは、解析的に計算できる(これは新しい多角形の放射照度であり、このための閉形式が存在する)。

これが昨年発表した通りのLTCの復習である。

この時点で、未解決の問題は、他のライトタイプに対して似たような事をできるか、であった。

# 線ライト

# 線ライト

線ライト＝線のような形状のライト

# 線ライト

"リニアライト"との混同(リニア vs. ガンマライティング)

Jonathan Blow
用語がもう滅茶苦茶や

Eric Heitz
おう、フィードバックあんがとな

その本の章では、我々はその項目において既存の文献との一貫性を取るためにこれらを"リニアライト"と呼ぶことに注意する。しかし、我々がそれをリリースしたとき、幾人かが名前が紛らわしいと訴えた(彼らはガンマライティングの反対としてリニアライティングを理解している)。

その本の章ではそれを変更するには遅すぎたが、今からは、この紛らわしさを避けるため、代わりにこれらを"線ライト"と呼ぶことを提案する。

# 線ライト

線ライト＝無限に薄い円柱[cylinder]ライト

ライン
円柱の半径$R$

$= \lim_{R \to 0} \frac{1}{R}$

線ライトは無限に薄い円柱ライトとして定義される。正式には、線ライトで得られるシェーディングは円柱で得られるシェーディングと円柱の半径の比の
半径を0に近づけるときの極限である。

# 線ライト

線ライトは円柱ライトに対する近似として用いることができる

ライン
円柱の半径$R$

$\times R \approx$

→ 粗いマテリアルおよび/または薄い/遠い円柱ライトで上手く機能する

これは円柱ライトのシェーディングが線ライトのシェーディングと円柱の半径とのかけ算によって近似できることを意味する。これは球面領域の中心の値に基づく円柱のシェーディングの一次近似[first-order approximation]である。

故に、この近似は分布の変化が円柱によってカバーされる球面領域内で小さいときに上手く機能するのみである。すなわち、以下のいずれかのときである。

- 円柱が薄い
- 円柱がシェーディングポイントから離れている
- マテリアルが粗い

# 線ライト

円柱ライトに対する近似

GGX $\alpha = 0.10$

以下の例では、円柱上のMC積分で得られる参考結果と解析的な線近似を比較する。

マテリアルが粗くなる、円柱が薄くなる、または、シェーディングポイントが遠くなるほど、近似がより良くなることが確認できる。

# 線ライト

円柱ライトに対する近似

GGX $\alpha = 0.20$

# 線ライト

円柱ライトに対する近似

GGX $\alpha = 0.50$

# 線ライト

LTC線ライト積分

$L$

$ = \int_L \text{LTC}(\omega) d\omega$
解析解？

我々のLTCフレームワークで線ライトを用いるため、解決すべき技術的問題は線ライト上でのLTCの積分である。

# 線ライト

LTC多角形ライト積分

コサイン✓ ← $M^{-1}$ ← Linearly Transformed Cosine

多角形ライトでは、元のコサイン構成に戻すために逆行列$M^{-1}$で多角形をかけ算することがキモである。

# 線ライト

LTC多角形ライト積分

$M^{-1} P$ $\overset{M^{-1}}{\leftarrow}$ $P$

$\int_{M^{-1} P} \text{cosine}(\omega) d\omega = \int_{P} \text{LTC}(\omega) d\omega$

元のコサイン構成では、コサイン上で多角形を積分する必要のみがある。これは、コレに対する解析解が存在するので、単純に行うことができる。

# 線ライト

LTC線ライト積分

コサイン✓ ← $M^{-1}$ ← Linearly Transformed Cosine

線ライト上の積分は同様の方法で処理される。すなわち、線ライトに逆線形変換を適用し、コサイン構成におけるもうひとつの線ライトを得る。

# 線ライト

LTC線ライト積分(上手くいかない！)

$M^{-1} L$ $\overset{M^{-1}}{\leftarrow}$ $L$

$\int_{M^{-1} L} \text{cosine}(\omega) d\omega \neq \int_{L} \text{LTC}(\omega) d\omega$

しかし、これは上手くいかない。コサイン構成における積分はLTC構成における積分と一致しない。

# 線ライト

LTC線ライト積分(極小の薄さの変化)

$M^{-1} L$ $\overset{M^{-1}}{\leftarrow}$ $L$

$\frac{1}{M^T \omega_{\perp}} \int_{M^{-1} L} \text{cosine}(\omega) d\omega = \int_{L} \text{LTC}(\omega) d\omega$

微妙な違い[subtlety]がひとつある。すなわち、我々が探している結果は単なる変換された線ライト上でのコサインの積分ではない。その問題は線ライトが無限に薄いのに、線形変換によって影響を受ける、仮想的な無限小の薄さを持つ、ということである。正しい答えを得るためにこの変化を計算に入れる必要がある。幸いにも、因数$\frac{1}{\|M^{T} \omega_{\perp}\|}$を結果にかけることで得られる。ここで、$\omega_{\perp}$はライトとライトに向かう方向の両方に正規直交している方向である。この方向$\omega_{\perp}$が線形変換によって影響を受ける量は無限小の薄さの変化量を生む。

この結果やその証明に関するさらなる詳細は関連する本の章にて提供される。

# 線ライト

薄い矩形[rectangle]ライトに対する近似

円柱 矩形

追加の内積を伴う円柱近似と同じ等式

円柱に加えて、線ライトは薄い矩形ライトに対する近似として使われることもある。薄い矩形ライトの向きのコサインを用いて円柱ライトのシェーディングを調整[modulate]することで得る。

薄い矩形ライトに対する線ライト近似は円柱に対するときと同じ条件下で最も上手く機能する。すなわち、高いラフネス、薄いライト、または、遠いライトである。

# 線ライト

薄い矩形ライトに対する近似

GGX $\alpha = 0.10$

以下の例では、矩形ライト上のMC積分で得られる参考結果と解析的な線近似を比較する。

マテリアルが粗くなる、矩形が薄くなる、または、シェーディングポイントが遠くなるほど、近似がより良くなることが確認できる。

# 線ライト

薄い矩形ライトに対する近似

GGX $\alpha = 0.20$

# 線ライト

薄い矩形ライトに対する近似

GGX $\alpha = 0.50$

# 球/円板ライト

# 球/円板ライト

球、円板、楕円[ellipse]、および、楕円体[ellipsoid]

# 球/円板ライト

球は円板として扱うことができる

球ライト $\overset{単純な式}{\rightarrow}$ 同じ立体角をカバーする円板ライト

第1の観察結果として、球ライトを解くことは円板ライトを解くことの部分集合である。実際に[indeed]、球は同じ立体角をカバーする円板で常に置き換えることができる。コレを行う単純な解析的な式が存在する。

# 球/円板ライト

楕円体は楕円として扱うことができる

楕円体 $\overset{L^{-1}}{\rightarrow}$ 球  $\rightarrow$ 円板  $\overset{L}{\rightarrow}$ 楕円

第2の観察結果として、同様に、楕円体ライトを解くことは楕円ライトを解くことの部分集合である。実際に[indeed]、楕円体は同じ立体角をカバーする楕円で常に置き換えることができる。

我々は*Nuclear Instruments and Methods in Physics Research*というジャーナルでこの楕円を計算するための手法を最近発表した。この論文の査読前原稿[preprint]は[ここ](https://labs.unity.com/article/analytical-calculation-solid-angle-subtended-arbitrarily-positioned-ellipsoid-point-source)から入手できる。

その解法はLTCの直観に直接的に触発されていることに注意する。すなわち、解法が既知のより単純な問題へ線形に変換して、後に、変換し直す。

# 球/円板ライト

球、円板、楕円、および、楕円体

- 球は円板として扱うことができる
- 円板は楕円の特殊なケースである
- 楕円体は楕円として扱うことができる

→ すべては詰まるところ楕円となる

# 球/円板ライト

LTC楕円ライト積分

コサイン ← $M^{-1}$ ← Linearly Transformed Cosine

我々は多角形や線に対するものと同じトリックを使う。すなわち、元のコサイン構成に戻すために楕円へ逆線形変換$M^{-1}$を適用する。

線形変換された楕円は楕円のままであることに注意する。

# 球/円板ライト

LTC楕円ライト積分

$M^{-1} E$ $\overset{M^{-1}}{\leftarrow}$ $E$

$\int_{M^{-1} E} \text{cosine}(\omega) d\omega = \int_{E} \text{LTC}(\omega) d\omega$

多角形に対するときと同様に、楕円上でのLTCの積分は新しい楕円上でのコサインの積分である。これは、球面の楕円を定義する。

# 球/円板ライト

問題: ディフューズ楕円の積分は閉形式を持たない

$E$

$= \int_E \text{cosine}(\omega)d\omega$
解析解なし✗

しかしながら問題がある。すなわち、そのコサイン分布は、球面の多角形に対して持っているような、球面の楕円上での解析的な積分を持たない。

(特殊なケースを除く。詳しくはこの後で)

# 球/円板ライト

トリック: 楕円を球で置き換える

解析解なし✗ $\approx$ 解析解あり✓ 同じ立体角と平均方向を持つ球

この問題を克服するため、同じ範囲の立体角領域をカバーし、同じ平均方向を持つ球で楕円を近似する。その利点はコサインが球上で解析的に積分できることである。

この近似は行列$M^{-1}$による楕円の線形変換の後に発生する必要があることに注意する。once コサイン楕円積分問題を解いている。

注意: 最適化用途では、厳密な解析的積分を用いるより安価であるので、多角形に対して同じ近似をすでに用いた(これは、一般的なケースで、クリッピングを伴う)。さらなる詳細は我々のプレゼンテーションを参照のこと。

# 球/円板ライト

トリック: 楕円を球で置き換える

近似 参考 近似 参考

実践では、この近似によって引き起こされるバイアスはほぼ無視できる。

これはコサイン分布が非常に低周波であることによる。そのため、その積分領域の精密な形状は、積分領域の位置や範囲が維持されている限り、それほど問題にならない。

# 球/円板ライト

トリック: 楕円を球で置き換える

任意の方向を向いた楕円 = 真正面を向いた楕円 $\approx$ 球の近似

近似的な球を計算するための中間の手順は同じ立体角領域をカバーする正面を向いた楕円を計算することである。

# 球/円板ライト: 実践

# 球/円板ライト: 実践

$M^{-1}$で中心$C$とスケールされた軸$V_1$および$V_2$を変換する

先程述べた通り、処理における第1工程は逆線形変換$M^{-1}$で円板を変換することである。そうした後、我々はコサイン構成における楕円を得る。

ここで実際に行うことは場園のスケールされた軸$V_1$および$V_2$とその中心$C$を変換することである。

# 球/円板ライト: 実践

問題: $V_1$と$V_2$はもはや直交ではない

# 球/円板ライト: 実践

解法: 2Dの固有系[eigensystem]を解く → 新しい軸

結果の固有値と固有ベクトルから、新しい楕円の軸を定めることができる

# 球/円板ライト: 実践

正面を向く楕円を計算する

次に、以前の楕円と同様に同じ立体角を持つ正面を向く楕円を求める。

少し前に述べたように、これは中間の工程である。

# 球/円板ライト: 実践

球で近似する → ライティング結果

正面を向いた楕円は同じ平均方向と共に同じ立体角を(再び)持つ球を定めることを可能にする。

これにより、我々はLTC楕円ライト積分を計算することができる。(または、それの近似)

# 球/円板ライト: 実践

手順2: 2Dの固有系を解く

# 球/円板ライト: 実践

手順2: 2Dの固有系を解く

$$
Q = \left[ \begin{array}{cc}
V_1 \cdot V_1 & V_1 \cdot V_2 \\
V_1 \cdot V_2 & V_2 \cdot V_2
\end{array} \right] = \left[ \begin{array}{cc}
q_{11} & q_{12} \\
q_{12} & q_{22}
\end{array} \right]
$$

固有値:

$$
\begin{align}
e_1 &= \frac{1}{2} \left( \text{tr}(Q) - \sqrt{\text{tr}(Q)^2 - 4\text{det(Q)}} \right), \\
e_2 &= \frac{1}{2} \left( \text{tr}(Q) - \sqrt{\text{tr}(Q)^2 - 4\text{det(Q)}} \right)
\end{align}
$$

問題: $\|V_1\| \gg \|V_2\|$の場合(または、その逆) → 精度の欠落

まず、我々は$V_1$と$V_2$による内積の行列を形成する。その後、固有値を計算し、そこから、固有ベクトルを計算する(この後すぐに説明する)。これらによって、新しい軸を定めることができる。

しかし、$V_1$の長さが$V_2$より非常に大きい、または、その逆であるとき、問題が浮かび上がる。これらの長さは二乗されるが、これは行列の主対角要素[leading diagonal elements] ($q_{11}$と$q_{22}$)の間の何桁にもなる差を引き起こす。

その大きな値は後続の計算をあふれさせる[swamp]ので、混乱が生じる[chaos ensues]。その巻末として、最終的に小さな固有値が真の値ではなく0になり得る。

# 球/円板ライト: 実践

ここにはこの状況において発生し得るアーティファクトの例がある。

この場合、ライトはビュアーのほぼ垂直にある。

注意: 問題を明らかにするために露出を増幅[boost]した。

# 球/円板ライト: 実践

解: かわりに$\sqrt{Q}$を用いて機能させることができる

$$
\sqrt{Q} = \frac{1}{t} \left[ \begin{array}{cc}
q_{11} + d & q_{12} \\
q_{12} & q_{22} + d
\end{array} \right]
$$

ここで

$$
\begin{align}
t &= \sqrt{\text{tr}(Q)+2d} = \text{tr}(\sqrt{Q}), \\
d &= \sqrt{\text{det}(Q)} = \text{det}(\sqrt{Q})
\end{align}
$$

固有ベクトル:

$$
\begin{align}
\sqrt{e_1} &= \frac{1}{2} \left( t - \sqrt{t^2 - 4d} \right), \\
\sqrt{e_2} &= \frac{1}{2} \left( t + \sqrt{t^2 - 4d} \right)
\end{align}
$$

幸いにも、ここで使える巧みなトリックが存在する。すなわち、直接的に$Q$から固有値を抽出するのではなく、代わりに$\sqrt{Q}$を使うことができる。$Q$は正定値[positive definite]であるので、だだ1つの解が存在する。

期待している通り、二乗根の行列でやると、主対角値の両方をより近づけ、結果的にさらに安定的な計算になる。

その後、我々は$Q$の固有値を得るために$\sqrt{Q}$の固有値の二乗を単純に必要とする。

豆知識[fun fact]: ここでの中間の項$t$と$d$は$\sqrt{Q}$の対角和[trace]と行列式[determinant]である。なので、それ自身の観点で$\sqrt{Q}$を実際に説明できる。

# 球/円板ライト: 実践

より高速でより安定:

$$
\begin{align}
\sqrt{e_1} &= (u - v)^2, \\
\sqrt{e_2} &= (u + v)^2
\end{align}
$$

ここで

$$
\begin{align}
u &= \frac{1}{2}\sqrt{\text{tr}(Q) - 2\sqrt{\text{det}(Q)}}, \\
v &= \frac{1}{2}\sqrt{\text{tr}(Q) + 2\sqrt{\text{det}(Q)}}
\end{align}
$$

であり

$$
\begin{align}
\text{tr}(Q) &= q_{11} + q_{22}, \\
\text{det}(Q) &= q_{11} q_{22} - q_{12}^2
\end{align}
$$

実践では、$e_1$と$e_2$を計算するために、元の行列$Q$の対角和と行列式の観点で説明される、以下を用いる。これはいくつかの操作を節約し、精度をさらに改善する。

# 球/円板ライト: 実践

固有ベクトル:

$$
\begin{align}
E_1 &= q_{12} V_1 + (e_1 - q_{11}) V_2, \\
E_2 &= q_{12} V_1 + (e_2 - q_{11}) V_2
\end{align}
$$

→ 軸

$$
\begin{align}
V_x = E_1 / \| E_1 \|, \\
V_y = E_2 / \| E_2 \|
\end{align}
$$

→ 大きさ

$$
\begin{align}
l_x = 1 / \sqrt{e_1}, \\
l_y = 1 / \sqrt{e_2}
\end{align}
$$

ひとたび固有値を手に入れれば、固有ベクトルを定めることができる。

そこから固有系からの軸と大きさを抽出するのは単純なことである。

# 球/円板ライト: 実践

より安定:

$q_{11} > q_{22}$でれば

$$
\begin{align}
E_1 &= q_{12} V_1 + (e_1 - q_{11}) V_2, \\
E_2 &= q_{12} V_1 + (e_2 - q_{11}) V_2
\end{align}
$$

そうでなければ

$$
\begin{align}
E_1 &= q_{12} V_2 + (e_1 - q_{11}) V_1, \\
E_2 &= q_{12} V_2 + (e_2 - q_{11}) V_1
\end{align}
$$

**実際には、これだけでほとんどの問題は直る！**

実践では、固有ベクトルの計算に関しても注意が必要である。$q_{11}$と$q_{22}$の相対的な大きさに依存して、一連の等式を使い分ける。

これだけでこの処理ステージで見つけていた多くの安定性の問題を修正できるが、前に示した特定の失敗ケースを修正できない。

# 球/円板ライト: 実践

そういえば、ここに再びアーティファクトがある…

# 球/円板ライト: 実践

…そして、ここに$\sqrt{Q}$を用いた結果がある。失敗ケースはなくなり、期待通りのなめらかな結果を得ることができた。

# 球/円板ライト: 実践

実績が解除されました！

そうして、"実績が解除された"。すなわち、我々には今やコサイン構成における有効な楕円がある。

処理の次の部分は同じ立体角を持つ正面を向く楕円を求めることである。現在の楕円と正面を向く楕円の両方は、ここでは淡い灰色で示される、(シェーディングポイントに頂点[apex]を持つ)円錐[cone]の円錐断面[conic sections]である。

# 球/円板ライト: 実践

円錐 = [spherical quadric]

$$
\left[ \begin{array}{ccc}
x & y & z
\end{array} \right] Q \left[ \begin{array}{c}
x \\
y \\
z
\end{array} \right] = 0
$$

$Q$の固有分解[eigendecomposition]を行う

$$
Q = \left[ \begin{array}{ccc}
V_1^+ & V_2^+ & V^-
\end{array} \right] \left[ \begin{array}{ccc}
e_1^+ & 0 & 0 \\
0 & e_2^+ & 0 \\
0 & 0 & e^-
\end{array} \right] \left[ \begin{array}{ccc}
V_1^+ & V_2^+ & V^-
\end{array} \right]^T
$$

$V^-$ → 新しい楕円の中心への方向 = 平均方向

$e_1^+, e_2^+, e^-$ → 新しい楕円の大きさ → 立体角

この円錐はspherical quadricによって説明される。これを再び$Q$と呼ぶことにするけど、紛らわしいだけだね。我々は、このプレゼンテーションでは特に重要ではないので、ここでは$Q$の計算の詳細に入らないだろう。代わりに、前に言及した技術報告書やスライドの最後を参照ください。

重要な点は、我々が再び固有分解を行う場合、今回は3x3行列だが、正面を向く楕円の軸と大きさを求めることができる、という所である。しかし、我々が注目しているのは、軸ではなく、正面を向く楕円の中心を通る方向、すなわち、平均方向である。これは第3の固有ベクトル$V^-$によって与えられる。

その大きさから、我々は楕円の立体角を計算できる。そして、正面を向く楕円を、ライティングを計算できる、同じ平均方向および立体角を持つ球で置き換える。

# 球/円板ライト: 実践

問題: シェーダにおける固有分解は扱いにくい[tricky]！

インターネットからコードをコピーしないで

残念ながら、3Dの固有分解は前に扱った2Dの場合よりずっと素直でない。

ここに示したスニペットは、Wikipediaから持ってきたものだが、我々が見つけた他のいくつかの実装と比べてかなりコンパクトであるので、好ましい[appealing]ように見えた。悲しいことに、この文脈において堅牢ではなかった。

# 球/円板ライト: 実践

TODO
