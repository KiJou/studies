---
title: The Devil is in the Details_ idTech 666 [@Sousa2016]
numberSections: false
---
# 初期の必須条件[Initial Requirements]

- パフォーマンス: 60Hz @ 1080p
- アートワークフローの高速化
- マルチプラットフォームのスケーラビリティ
- KISS
    - ミニマリスト的なコード
    - シェーダ順列が狂ったような数ではない: ~100シェーダ、~350パイプラインステート
- 次世代ビジュアル
    - HDR、PBR
    - 動的で一様なライティング、シャドウ、反射
    - 良好なアンチエイリアシングとVFX

# フレームの解剖[Anatomy of a Frame]

- シャドウキャッシング: ~3.0ms
- Pre-Z: ~0.5ms
- 不透明フォワードパス: ~6.5ms
    - クラスタデータの準備
    - テクスチャコンポジット、ライティング計算
    - 出力: Lバッファ、薄いGバッファ、フィードバックUAV
- ディファードパス: ~2.0ms
    - 反射、AO、フォグ、最終コンポジット
- 透明: ~1.5ms
    - パーティクルライトキャッシング、パーティクル/VFX、草
- ポストプロセス(非同期): ~2.5ms

# ライティング＆シェーディングのためのデータ構造[Data Structure for Lighting & Shading]

- 以下からの派生
    - "Clustered Deferred and Forward Shading" [@Olson2012]
    - "Practical Clustered Shading" [@Person2013]
- Just works™
        - 透明な表面
            - 追加のパスも処理も必要なし
        - 深度バッファから独立
        - 深度の非連続性にわたって偽陽性なし
        - 次のスライドでよりJust Works™する

# クラスタ構造の準備[Preparing Clustered Structure]

- 錐台型のボクセル化/ラスタライゼーション処理
    - 深度スライスあたり1つのCPUジョブで行われる
- 対数関数的な深度分布
    - 拡張されたニア面とファー面
    - $ZSlice = Near_z \cdot \left( \frac{Far_z}{Near_z} \right)^{\frac{slice}{num slices}}$
- 各アイテムをボクセル化する
    - アイテムは以下があり得る: ライト、環境プロブ、デカール
    - アイテムの形状は: OBB、錐台(プロジェクター)
    - スクリーン空間の$min_{xy}$、$max_{xy}$、深度境界で括った[bounded]ラスタライゼーション

<!-- p.6 -->

- refinementはクリップ空間で行われる
    - クリップ空間でのセルはAABBである
    - N個の平面 VS セルのAABB
    - OBBは平面が6つ、錐台は平面が5つ
    - すべてのボリュームに対して同じコード
    - SIMD

```cpp
for (y = MinY; y < MaxY; ++y) {
    for (x = MinX; x < MaxX; ++x) {
        intersects = N個の平面 vs セルのAABB
        if (intersects) {
            アイテムを登録する
        }
    }
}
```

<!-- p.7 -->

- 構造
    - オフセットリスト:
        - 64ビット x グリッドの大きさX x グリッドの大きさY x グリッドの大きさZ
    - アイテムリスト:
        - 32ビット x 256 x ワーストケース(グリッドの大きさX x グリッドの大きさY x グリッドの大きさZ)
- オフセットリスト、要素ごと
    - アイテムリストへのオフセット、ライト/デカール/プロブの数
- アイテムリスト、要素ごと
    - 12ビット: ライトリストへのインデックス
    - 12ビット: デカールリストへのインデックス
    - 8ビット: プロブリストへのインデックス
- グリッドの解像度はかなり低解像度: 16 x 8 x 24
    - フォールスポジティブ: 早期脱出[early out]が軽減＋アイテムリストの読み込みが一様(GCN)

<!-- p.8 -->

ホットスポット: ~300個の光源、~1.2kのデカール

# 世界の描き込み[Detailing the World]

TODO
