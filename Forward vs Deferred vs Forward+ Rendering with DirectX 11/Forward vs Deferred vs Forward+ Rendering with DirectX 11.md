# Forward vs Deferred vs Forward+ Rendering with DirectX 11

https://www.3dgep.com/forward-plus/

## Introduction

### Forward Rendering

Forward Renderingは、ジオメトリオブジェクトごとにラスタライズすることでシーンを描画する手法である。
この手法では、ジオメトリオブジェクトを1つ描画するごとに、そのオブジェクトのライティング処理に必要なすべての光源を列挙する必要があるため、取り扱う数が大きくなるとその変化に対する計算量の変化量が大きくなる傾向がある。そのため、計算負荷を抑える目的で計算対象となる光源数に上限を設けることが多い。

### Deferred Rendering

Deferred Renderingは、ジオメトリ情報を格納した2D画像バッファ(G-buffer)を用いてスクリーン空間でライティング計算を行う手法である。ジオメトリ処理とライティング処理が分離しているため、オブジェクト数の増加に対する計算負荷の増加が比較的小さくなる。
G-bufferは、1ピクセルが32ビットのフルHD(1920x1080)サイズのテクスチャを用いるとすると、1枚につき約8MBになる。通常のG-bufferは4枚程度で構成されることが多いので、30から40MBのメモリ消費を見越しておかなければならない。
Deferred Renderingは不透明オブジェクトしか扱えないという欠点がある。これはG-bufferが1ピクセルに1つの情報しか保存できないために、透明オブジェクトを介して見るオブジェクトが正しくライティングされなくなるためである。この問題は透明オブジェクトを通常のforward renderingで描画することで回避する。
また、ライティングパスが基本的には単一のピクセルシェーダで動作するという都合上、ライティングモデルを動的に切り替えるシステムとうまく噛み合わない場合がある。

### Forward+

Forward+ (Tiled Forward Shading)は、考慮しなければならない光源数を削減するTiled Light CullingとForward Renderingを組み合わせた手法である。はじめに、スクリーン空間を等間隔のタイルに分割して、そのタイルごとに計算を行うであろう光源のリストを作成する。そして、シェーディングを行うピクセルを含むタイルの光源リストを参照してForward Renderingを行う。
これにより、計算する必要のない光源を大幅に取り除くことができ、パフォーマンスが飛躍的に向上する。また、本質的にはForward Renderingなので、不透明と透明の両方を同じ処理系で扱うことができるし、複数のマテリアルやライティングモデルを取り扱うこともできる。

## Definitions

以下の定義は基本的に一般的な解釈に基づくが、この記事中でのみ有効なニュアンスを含むことがあることに注意する。

シーン(scene)
: レンダリングされるオブジェクト群。
  シーングラフ(scene graph)と呼ばれるノードによる階層構造を構成することが多い。

パス(pass)
: レンダリングテクニックを構成する操作(operation)の基本単位。
  例えば、Deferred Renderingではジオメトリ情報を書き込むジオメトリパスとライティングを計算するライティングパスがある。

テクニック(technique)
: (主として、レンダリングアルゴリズムを実装するための)パスの組み合わせ。

パイプラインステート(pipeline state)
: レンダリングパイプラインの構成要素をまとめたもの。シェーダ、ラスタライザステート、ブレンドステート、デプスステンシルステート、レンダターゲットを含む。
  DirectX12のものとは若干異なる。

フォワードレンダリング(Forward Rendering)
: 伝統的なレンダリングテクニック。不透明(opaque)パス、透明(transparent)パスの2パスから成る。

遅延レンダリング(Deferred Rendering)
: 不透明オブジェクトをG-bufferに書き込むジオメトリパス、スクリーン空間でライティングを計算するライティングパスの2パスとForward Renderingと同じ方法で行う透明パスから成る。

Forward+ または Tiled Forward Rendering
: スクリーン空間のタイルごとに光源のリストを作成するライトカリング(light culling)パス、不透明パス、透明パスの3パスから成る。
  光源リストは不透明オブジェクト用と透明オブジェクト用にそれぞれ作られる。光源はその形を指定でき、Point、Spot、Directionalなどがある。

減衰(attenuation)
: ポイントライトやスポットライトで光源との距離に応じてその光量が減少すること。

## Forward Rendering

Forward Renderingは今回取り上げる3つの中では一番シンプルであり、ゲームなどのリアルタイム系でよく使われているテクニックである。このテクニックではライティング計算は比較的高価であるため、大量の動的な光源を扱えなくしてある場合が多い。一方で、光源が静的ならば、lightmappingやlight probesによりその寄与を事前計算することができるため、大量に取り扱うことができる。

本実験では、Forward Renderingは他のテクニックの比較を行うためのground truth[^ground_truth]として用いる。また、他のテクニックのパフォーマンスを比較するための基準値としても用いる。

[^ground_truth]: 実際のシステムを直接観察することで得た情報。計算機科学界隈では、アルゴリズムの特性を調べるために用意された正解データを指す。

Forward Renderingで用いられた多くの機能(functions)はDeferred RenderingやForward+でも引き続き利用されている。たとえば、頂点シェーダはほぼそのまま用いられるし、ライティングやシェーディングの計算方法はあらゆるレンダリングテクニックで再利用されている。

### Vertex Shader

頂点シェーダは色んなレンダリングテクニックで共通している。本実験では、静的なジオメトリのみを扱い、異なる頂点シェーダが必要になる骨格(skeletal)アニメーションや地形(terrain)は扱わない。

```hlsl
struct AppData {
    float3 position : POSITION;
    float3 tangent : TANGENT;
    float3 binormal : BONORMAL;
    float3 normal : NORMAL;
    float2 texcood : TEXCOORD0;
};
```

`AppData`はアプリケーションから頂点シェーダへ送られるデータの構造を定義する。それぞれ頂点に対して、`position`は位置、`normal`は法線、`tangent`は接線、`binormal`従法線、`texcood`はテクスチャ座標が格納される。従法線は法線と接線の外積として求められるため、通常は必要はない。
