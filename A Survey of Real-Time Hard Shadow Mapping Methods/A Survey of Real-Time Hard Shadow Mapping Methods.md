---
title: A Survey of Real-Time Hard Shadow Mapping Methods [@Scherzer2011]
---
# はじめに {id="sec:1"}

シャドウはシーンにおける光輸送の重要な結果である。これらはオブジェクト同士やオブジェクトと光源の幾何的な関係を明確にするための見た目の手がかりを与える。面光源[area light sources]によるソフトシャドウはゲームのようなアプリケーションにおいてますます人気になっている一方、多くのアプリケーションは依然として、ポイントライトやディレクショナルライトによってもたらされる、ハードシャドウを用いている。アプリケーションにおいていくつかの光源にソフトシャドウが用いられている場合でも、多くの光源はハードシャドウやフィルタリング技術を用いて若干ソフト化されたシャドウをもたらすポイントライトとして許容できる程度にモデル化することができる(太陽によってもたらされる影がこの例に当たる)。我々の調査では、最も広く使われているシャドウアルゴリズムであるので、ハードシャドウに注目したいが、これらのポテンシャルは、この問題に関する論文が大量に存在するが故に、特定のアプリケーションに対して最適なアルゴリズムを選ぶことが難しく、滅多にフル活用されることがない。

ある点が光源の視点から見えないとき、この点は影の中にある。この点に光線が到達するのを遮るオブジェクトはシャドウキャスター[shadow caster]、オクルーダー[occluder]、ブロッカー[blocker]と呼ばれる。影の中にある点を持つオブジェクトはシャドウレシーバー[shadow receiver]と呼ばれる([@fig:1]を参照)。リアルタイムハードシャドウには*ジオメトリベース*と*イメージベース*の2つの主要なアプローチが存在する。

![シャドウキャスティングの図解](){#fig:1}

シャドウアルゴリズムはコンピューターグラフィクスそれ自体とほぼ同じくらい前から存在しているにも関わらず、堅牢で効率的なハードシャドウ生成は未だに未解決の問題である。ジオメトリベースのアルゴリズムはピクセルパーフェクトな結果を生み出す一方、異なるビュアーおよびライトの配置[constellations]による堅牢性の問題に悩まされる。これらの汎用性[versatility]により、ジオメトリベースのアルゴリズムにおけるほぼすべての研究は*シャドウボリューム*に注目している[@Cro77]。この技術の主なデメリットはすべてのシャドウボリュームをレンダリングするのに必要な大量のフィルレートである。加えて、輪郭検出を行わなければならず、ポリゴンが豊富[polygon-rich]なシーンでは、これは別のパフォーマンスペナルティを意味する。最後に、エッジを検出して押し出す[extrude]単純な方法が必要とされるので、ポリゴンデータのみで処理できる。

その一方で、イメージベースのアルゴリズムは、これらの複雑さが標準のシーンレンダリングと同様であるため、非常に高速である。*シャドウマッピング*[@Wil78]は任意のキャスターおよびレシーバーの配置を扱うことができ、セルフシャドウを計算に含めることができ、ポリゴンでない入力すら処理できるイメージベースのアルゴリズムである。基本のシャドウアルゴリズムは[@sec:2]にて触れる。

残念ながら、シャドウマッピングもまたいくつもの欠点に悩まされる。第1に、オムニディレクショナルライト[omni-directional lights]が単一の錐台を用いてキャプチャーできない。この問題は[@sec:2]で議論される。

第2の、より厳しい問題はシャドウマップのサンプリングとシャドウマップに投影されたイメージピクセルのサンプリングが通常では一致しないために起こるエイリアシングアーティファクトである。[@sec:3]では、このエイリアシングアーティファクトを解析し、この解析からいくつかの異なる誤差の種類を導きたい。一方[@sec:4]では、サンプリング誤差を減らすことができる手法の概要を与える。

第3の問題は、テクセルごとにシャドウマップに格納される深度情報におけるアンダーサンプリングおよび不正確さによって引き起こされる正しくないセルフシャドウである。これは堅牢な結果をもたらすために深度テストをバイアスする(*深度バイアス[depth biasing]*)必要性を生み出す。我々は[@sec:5]においてこの問題への様々なアプローチを議論する。

[@sec:6]では第2パスにおいてシャドウマップ中に格納された情報をより良く再構築するためのサンプリング理論を適用するフィルタリング技術を紹介する。最後に、[@sec:7]では与えられたアプリケーションに対して最適なアルゴリズムを選ぶ方法についてのガイドラインを与える。

# 基本 {id="sec:2"}

シャドウマッピングでは、2パスでシャドウ計算が行われる。まず、(*ライト空間*で)光源から見える現在のシーンの深度イメージ(*シャドウマップ*)がレンダリングされ、格納される([@fig:2]左を参照)。このイメージはテクセルごとに光源に最も近いオブジェクトの深度を含んでいる。この深度の背後にあるすべては光源から見えず、それ故に、影の中にある、という発想である。次のパスでは、そのシーンが(*ビュー空間で*)ビューポートからレンダリングされ、各3Dフラグメントがライト空間に再投影される。再投影されたフラグメントの深度がシャドウマップに格納された深度より遠くある(*深度テスト*)ならば、そのフラグメントは影の中にあり、そのようにシェーディングされる([@fig:2]➡を参照)。

![シャドウマッピング: まず、シーンの深度イメージ(*シャドウマップ*)は光源のビューポートからのレンダリングによって生成される(左)。次に、ビュー空間の各フラグメントの再投影された深度がシャドウマップに格納された深度と比較される(右)。](){#fig:2}

オムニディレクショナルライトはその球状のビューにより複数のバッファを用いて計算されなければならない。単一の錐台ではこれを反映できず、多くのシャドウマップと錐台がこの球状のビューを分割するために構築されるなければならない。最も一般的なアプローチでは6つの錐台(キューブマップの面ごとに1つ)を用いるが、このようなライトに大きなパフォーマンスペナルティを引き起こす。より高速な解決法は放物線[parabolic]マッピング[@BAS02b]を用いることで達成させることができる。これは結果として半球ごとに1つずつの計2つのレンダリングとなるだけでなく、グラフィクスハードフェアにおいて効率的に放物線マッピングを模倣する(線を曲線にする)方法の問題も生み出す。最も単純な解決法では、シーンが頂点だけの放物線マッピングとして事足りるように十分に細切れにされている[tessellated finely]と仮定する。アプローチには、モダンなハードウェアで直接的に曲線を計算するように、より低速で入り組んだものが存在する[@GHFP08]。

# 誤差解析 {id="sec:3"}

シャドウマップをレンダリングするとき、与えられたシーンの離散的サンプリング表現[discretely sampling representation]を生成する。シャドウマップ操作は光源に関する表面の可視性条件を再構築するためにこの表現を後に用いる。故に、シャドウマッピングについてテクスチャマッピングと似た信号の再構築処理として考えると便利である。信号の再構築は以下の手順に従う。

1. 最初に、入力関数を*サンプリング*する。すなわち、レンダリングを用いてシャドウマップを生成する。最初のサンプリングフェーズではエイリアシングを回避するために行える帯域制限は存在しないので、サンプリング周波数は理想的にはその信号のナイキスト周波数より大きい必要がある。深度比較を計算した後の実際のシャドウ信号は鋭いエッジを持ち、それ故に、無制限の周波数を持つことに注意する。
2. そのサンプリング表現から信号を*再構築*(または、補間)する。シャドウマッピングでは、これはフラグメントをシャドウマップ空間に投影して、シャドウマップテストを計算するときに発生する。深度テストの非線形性により、素直なシャドウマッピングに対して最近傍探索[nearest-neighbor lookup]のみが可能である。
3. 対象とする出力解像度では高すぎる周波数を回避するために再構築された信号に*帯域制限*(または、事前フィルタリング)を行う。これは深度テストの非線形性によりシャドウマッピングに対して簡単には[straightforwardly]できない。
4. 再構築された信号を最終ピクセル位置で*リサンプリング*する。

離散的サンプリングのシナリオでは、再構築とリサンプリングが結合しているので、再構築は最終ピクセル位置でのみ発生することに注意する。

上記の手順による信号の再構築処理としてのシャドウマッピングのメンタルモデルを容易にするため、シャドウマッピング操作を特定のオブジェクトがすでに焼き込まれたシャドウテストの結果を持つ投影テクスチャマップ[projective texture map]によるオブジェクトのテクスチャリングとして考えることができる。これは、そのテクセルが光の中にあるフラグメントに対して1に、影の中にあるフラグメントに対して0に塗り潰されていることを意味する。この方法では、再構築とリサンプリングは、再構築が最近傍探索かバイリニア補間で行われる、帯域制限がミップマッピングを用いて行われる、リサンプリングが単なる最終ピクセル位置での関数の計算である、といったところで標準のシャドウマッピングと比較されることができる。

## 誤差の種類 {id="sec:3.1"}

主な誤差の種類として以下が存在する。

- アンダーサンプリングはスクリーンに投影されたシャドウマップのサンプルがスクリーンのピクセルより低いサンプリングレートを持つときに発生する。これは最初のサンプリング周波数が低すぎることに起因する。
- オーバーサンプリングはスクリーンに投影されたシャドウマップのサンプルがスクリーンのピクセルより高いサンプリングレートを持つときに発生する。この場合、テクスチャサンプリングで知られる古典的なエイリアシングが発生する。これは、最初のサンプリングレートを適応させる、後に議論する帯域制限または事前フィルタリングを行う、のいずれかによって修正できる([@sec:6]を参照)。
- 再構築の誤差、または、階段状のアーティファクトは最近傍再構築に起因する。これはより優れた再構築フィルタによって修正できる([@sec:6]を参照)。
- 時間的[temporal]エイリアシング、または、ちらつき[flickering]アーティファクトは、シャドウマップのラスタライゼーションがフレームごとに変化する場合に発生する。これらのアーティファクトは特にアンダーサンプリングが発生する場合に最適でない再構築が行われると現れるだろう。改善案に関しては[@sec:4.6]を参照のこと。

信号処理、特にテクスチャマッピングとの最も重要な差異はシャドウマッピング処理が最初のサンプリング手順に関するいくつかの制御権を得ていることである。最初のサンプリングを変更すると、すべての種類の誤差の効果を減少させるため、シャドウマッピングに関するほとんどの文献[publications]ではこのアプローチを取っている。故に、[@sec:3.2]と[@sec:3.3]では、より詳細な*サンプリング誤差*とこのエラーの種類を特徴付けるための2つの手法を議論したい。具体的にシャドウマッピングの文脈におけるオーバーサンプリングと再構築を扱うことを対象としたアプローチもいくつか存在するが、これは[@sec:6]で説明したい。

## 単純化されたサンプリング誤差解析 {id="sec:3.2}

シャドウマップのサンプリング誤差を減らすほとんどのアルゴリズムの根底にはシーンにおける誤差分布の解析がある。単純化された誤差解析はPerspective Shadow MapsのためにStammingerとDrettakis[@SD02]によって初めて導入され、同じ式が多くの後続のアプローチに使われている。その解析は頭上にあるディレクショナルライトを仮定し、視錐台のZ軸上のどこかに位置する表面要素を調べる。[@fig:3]は小さなエッジに対する構成を示している。

![シャドウマッピングにおけるエイリアシング](){#fig:3}

シャドウマップにおけるピクセルはそれを通過する光線のシャフト[a shaft of light rays]を表現し、シャドウマップの局所的パラメーター化[local parametrization]における大きさ$ds \times ds$を持つ。我々はビュアーのニアおよびファー面の間を0から1とするシャドウマップの局所的パラメーター化を仮定する --- これは、シーンの見えない箇所でいずれの解像度も無駄にせず、シャドウマップが視錐台へ適切に注目していることをすでに仮定している([@sec:4]を参照)。ワールド空間では、光線のシャフトは例えばユニフォームシャドウマップに対して長さ$dz = (z_f - z_n) ds$を持つ。

そのシャフトは$dz / \cos \beta$の長さに沿って小さなエッジに当たる。これはアイ[eye]空間では$dy = dz \frac{\cos\alpha}{\cos\beta}$の長さを表し、スクリーンで$dp = dy / z$に投影される(ニア面の距離を1とする)。我々は小さなエッジが$z$軸に沿って並行移動できる、すなわち、$z$が解析の自由パラメーターであると仮定していることに注意する。そして、このシャドウマップのエイリアシング誤差$dp / ds$は以下となる。

$$
\frac{dp}{ds} = \frac{1}{z} \frac{\cos\alpha}{\cos\beta}
$$ {#eq:1}

シャドウマップの*アンダーサンプリング*は、$dp$がピクセルのサイズより大きいとき、または、高さ1のニア面にあるビューポートに対して、$dp/ds$が$res_{shadowmap}/res_{screen}$より大きいときに発生する。StammingerとDrettakis[@SD02]がすでに示したように、これは、$\frac{dz}{zds}$が大きいときの*遠近によるエイリアシング[perspective aliasing]*と、$\cos\alpha / \cos\beta$が大きいときの*投影によるエイリアシング[projection aliasing]*、の2つの理由により発生し得る。

![左図において、投影によるエイリアシングの原因は木の表面の向きである。これはシャドウマップでは小さな範囲に投影されるが、カメラ空間では大きな範囲に投影される。右図での遠近によるエイリアシングはシャドウマップが遠近による短縮[perspective foreshortening]に無関係であるために発生し、それゆえに、(カメラに関して)遠くの範囲も近くの範囲も同じ解像度でか格納されるが、カメラ空間では非常に異なる大きさに投影される。](){#fig:4}

投影によるエイリアシングは光の方向にほぼ並行な表面で発生する局所的な減少である([@fig:4]の左を参照)。この種の誤差を減らすには、そのような範囲でのサンプリング密度を高くする必要がある。シーン解析に基づいて局所的にサンプリング密度を適合させるアプローチでのみこれを達成できる([@sec:4.3.3]から[@sec:4.6])。

一方、遠近によるエイリアシングはビュアーの透視投影によって引き起こされる([@fig:4]の右を参照)。遠近による短縮効果がシャドウマップの軸のひとつに沿って発生する場合、*シャドウマップのパラメーター化*によって影響を受ける可能性がある。異なるパラメーター化が選ばれる場合、これはシャドウマップに沿って異なるサンプリング密度分布をもたらすだろう。標準の一様なパラメーター化は定数の$dz/ds$を持ち、それゆえに、サンプリング誤差$dp/ds$は$1/z$が大きくなると大きくなり、ニア面に近くなると発生するようになる。これは結果としてカメラ近くのオブジェクトに費やされるサンプル数が少なくなり、この誤差の効果を非常に目立たせてしまう([@fig:5]を比較参照)。遠近によるエイリアシングを減らすため、異なるパラメーター化を用いる、シャドウマップを小分けにする、のいずれかによって、ビュアー近くにより多くのシャドウマップサンプルを分布させるアプローチがいくつか存在する([@sec:4.2]および[@sec:4.3])。

![ワールド空間における一様な分布(左)では遠近による短縮によって観測者の近くで劣化する。この効果はポストパースペクティブ空間で確認することができる(右)。すぐ近くの要素に費やされるサンプルはほとんどない。](){#fig:5}

## 正確なサンプリング誤差解析 {id="sec:3.3}

サンプリング誤差の正確な解析は複雑であり、Brandon Lloydの論文[article]および学位論文[thesis]において研究される[@Llo07; @LGQ*08]。ここでは結果だけを用意する。一般的な構成では、エイリアシング誤差$m$は以下のようになる。

$$
m = \frac{r_j}{r_t} \frac{dG}{dt} \frac{W_l}{W_e} \frac{n_e}{n_l} \frac{d_l}{d_e} \frac{\cos\phi_l}{\cos\phi_e} \frac{\cos\psi_e}{\cos\psi_l}
$$ {#eq:2}

この数式において、

![正確なエイリアシングの説明に用いられる表記法(画像はBrandon Lloydの好意によるもの)](){#fig:6}

- $\frac{r_j}{r_t}$はスクリーンとシャドウマップの解像度の比である
- $\frac{dG}{dt}$はシャドウマップのパラメーター化のは生物である(上記では$dz/ds$と呼ばれる)
- $\frac{W_l}{W_e}$はライトとアイのビューポートのワールド空間での大きさの比である
- $\frac{n_e}{n_l}$はアイとライトのニア空間の距離の比である
- $\frac{d_l}{d_e}$はライトとアイからのパッチ距離の比である($d_e$は上記の$z$に対応する)
- $\phi_l, \phi_e$はイメージ面およびシャドウマップ面の法線からのライトおよびアイ光線の角度である
- $\psi_l, \psi_e$はパッチの面法線からのライトおよびアイ光線の間の角度である(上記での$alpha$と$\beta$に対応する)

単純化された解析と比較して、この数式は表面要素が視錐台の中心にないときのサンプリング誤差における、任意のライト位置または方向に対する変化を計算に入れている。ポイントライトについても正確に計算に入っている。ディレクショナルライトでは、$n_l/d_l$は1に収束し、$\cos\phi_l$は定数となるだろう。シャドウマップのアンダーサンプリングは$m > 1$のときに発生する。

考慮すべき重要な点はこれらの数式がひとつのシャドウマップ軸のみを扱うことである。しかし、透視変換を用いた$z$軸の再パラメーター化は他のシャドウマップ軸に沿ったサンプリング誤差にも影響を与える。[@fig:5]を見た場合、これはこの論文が印刷されている平面に直交する軸である。この軸に沿ったテクセルもまた再パラメーター化を通じて引き伸ばされ、同様にサンプリング誤差に影響を与える。我々は[@sec:4.4.2]でこの効果を簡単に検討する。

# サンプリング誤差を減らすための戦略 {id="sec:4"}

一般に入力イメージの解像度が事前に定まっているテクスチャマッピングと異なり、シャドウマッピングでは、元々のサンプリング手順への大きな制御権が存在する。それ故に、投影されるシャドウマップサンプルが素のシャドウマッピングより優れたスクリーン空間のサンプリングレートに対応するようにサンプリングを適合させることが可能である。

特に、*拡大*シナリオにおいて、テクスチャマッピングでは、負担のほとんどが再構築フィルタにかかっているのに対して、シャドウマッピングでは、この負担がサンプリングレートを増やすこと、すなわち、影響を受ける範囲から拡大(または、アンダーサンプリング)を取り除くことで減らすことができるので、最近傍再構築が時折良好な品質をもたらす可能性がある。さらに、*縮小*シナリオにおいて、例えばスクリーン上で小さく現れる範囲では、最初のサンプリングレートを減らすことができ、それによって、高価な帯域制限フィルタの必要性を回避する。

サンプリング誤差削減技術における大量の文献のため、我々はサンプリング誤差を取り除こうとするアプローチを、*フォーカシング[focusing]*、*湾曲ベース[warping-based]*、*分割ベース[partitioning-based]*、*不規則サンプリングベース[irregular sampling-based]*のアルゴリズムへさらに細分化する。

## フォーカシング {id="sec:4.1"}

サンプリングレートを改善できる最も素直な方法のひとつは、見えないシーン部分でシャドウマップのスペースを無駄していないこと確かめることである。特に屋外のシーンでは、単一のシャドウマップがシーン全体に使われる場合、視錐台に対する当該部分はシャドウマップの一部分のみとなるだろう。故に、フィッティングまたはフォーカシングの技術は、Barabec et al.[@BAS02a]によって初めて導入され、視錐台を取り囲むようにシャドウマップの錐台を一致させる。

幾何的な解法では、視錐台とライト位置(ディレクショナルライトではこの位置は無限遠にある)の凸包を計算して、その後、この物体[body]をシーンの境界ボリュームとライトの錐台でクリップする(詳細は[@WSP04; @WS06]を参照)。こんにちでは非常に大きな視錐台が一般的であり、定期的にシーン境界の外側へと拡張するため、シーンの境界ボリュームとのクリッピングは必須である。我々はその結果の物体を交差物体B[intersection body B]と呼ぶ([@fig:7]を参照)。

![より良いシャドウマップフォーカシングは、ライト錐台$L$、シーンの境界ボックス$S$、視錐台$V$を境界ボリューム$B$と組み合わせることで利用可能なシャドウマップ解像度を活用する。ここでは、左にポイントライトのものを、右にディレクショナルライト源のものを示す](){#fig:7}

交差物体は可視性アルゴリズムを用いることでさらに削減できる。シャドウマップが生成される前に、最初の深度のみのパスがCoherent Hierarchical Culling (CHC) [@MBW08]のようなオンライン可視性アルゴリズムでレンダリングされる場合、ファー面の距離は最も遠い可視オブジェクトをカバーするように減らすことができる。

一般に、フィッティングは、シャドウマップのラスタライゼーションがフレームごとに変化するので、時間的エイリアシングを引き起こす。特に可視性情報が用いられるとき、強烈な時間的不連続性が発生するので、この場合では優れた再構築フィルタが非常に重要になる。

フィッティングによる時間的エイリアシングはワールド空間でテクセル境界を一定に保とうとすることでも幾分か減らすことができる。まず、シャドウマップはビュアーが回転しても投影されたシャドウマップテクセルが形状を変化させないようにするためにワールド空間で一定の向きを維持する必要がある。このため、シャドウマップは交差物体の軸並行な境界ボックス[axis-aligned bounding box]に焦点を合わせる必要がある。シャドウマップビューにおける視錐台の平行移動によるエイリアシングを回避するため、シャドウマップは1テクセルの境界付きで生成され、視錐台がテクセル全体を動かす場合にのみ改める[refit]必要がある。しかし、ビュアーの移動のほとんどはシャドウマップビューにおける視錐台のスケーリングも引き起こすため、多くのシャドウマップスペースを無駄にせずに制御することはより難しい。この詳細は[@ZZB09]を参照のこと。

## 湾曲 {id="sec:4.2"}

視錐台をシャドウマップに投影するとき、視点[viewpoint]近くでは高いサンプリング密度が必要となり、視点から遠くでは低いサンプリング密度が必要となることが明らかとなる。いくつかのケースでは、サンプリング密度が有用な方法で大局的に変化するようなシャドウマップに投影する前にシーンへ単一の変換を適用することが可能である([@fig:8]を参照)。元のアルゴリズムにおいて、湾曲は単一のシャドウマップに適用されたが、後にサンプリングレートをさらに改善するために分割アルゴリズムと組み合わせられることとなった([@sec:4.3]と[@sec:4.4]を参照)。

![視錐台$V$、透視変換$P$を定義する錐台を持つLight Space Perspective Shadow Mapsの構成の例。左: ディレクショナルライト、視錐台$V$、透視変換$P$。右: 湾曲した後、ビュアー近くのオブジェクトはシャドウマップ中でより大きく現れる。従って、より多くのサンプルを受け取る。](){#fig:8}

StammingerとDrettakisは*Perspective Shadow Maps* (PSM) [@SD02]の論文でシャドウマップの湾曲を導入した。この主なアイデアは、シャドウマップへレンダリングする前にシーンへ透視変換、ビュアーの投影を適用することである。つまり、シャドウマップサンプルの分布が、投影の中心近くで多く、投影のファー面近くで少なくなるように変化させる。これは、4x4行列で表現できる、単純な透視変換しか使われないという利点を持つ。これはハードウェアに上手く対応し、高速に計算される。このアプローチの主な問題は、その誤差が取り得る深度の範囲全体へと不均等に分布するので、この手法の達成可能な品質がアイおよびビューのニア面に強く依存することである。近いニア面では、解像度のほとんどがアイ近くで使い切ってしまい、シャドウマップの残りの部分に対して十分な解像度が残らない。その著者らはこの問題を緩和するためにできる限り遠くにニア面を押し戻そうとシーンを解析することを提案している。加えて、ビュアーの投影を用いると、ライトの方向を、また、ライトの種類まで変化させる可能性がある(ディレクショナルからポイントまたはその逆)。これは、実装を複雑化する。

これらの問題はビュアーから透視変換を分離することで回避[circumvent]される。これは、ライトおよびビューに並行な変換でライト空間を曲げる[warp]という、*Light Space Perspective Shadow Maps* (LiSPSM) [@WRP04]の主なアイデアである。ここで、透視変換は常にライト錐台の軸に並行であり、故に、ライトは方向またはタイプを変化させない([@fig:8]と[@fig:10]を参照)。ポイントライトを扱うために、ポイントライトの投影がまず適用され、ポイントライトをディレクショナルライトに変換して、LiSPSMがライトのポストパースペクティブ空間で行われる。分離された透視変換は自由パラメーター、すなわち、透視変換のニア面の距離$n$を作り出すという追加の利点を持つ([@fig:9]を参照)。小さな距離は、より強烈な湾曲やすぐ近くのオブジェクトへの集中[focus]を引き起こし、$n$が大きくなれば引き起こされる湾曲が小さくなる。湾曲の手法に関する後の仕事のほとんどはこの枠組みを採用してきたことに注意していただきたい。LiSPSMにおいて、ニア面の距離は、均質的な品質を生成しようと取り得る深度の範囲全体で等しく誤差を分布させる方法で選ばれる([@fig:11]を参照)。

![自由パラメーター$n$の値の減少(左から右)は、ビュアー近くでシャドウマップの解像度の増加をもたらす。各画像は左上の角における湾曲したライトビューを示す。](){#fig:9}

![Light Space Perspective Shadow Mapsのパラメーター化(ライト空間でのYZ平面を示す)。パラメーター$n$は自由であり、$z_n$(Perspective Shadow Mapping)から無限大(Uniform Shadow Mapping)の間で変化できる。$\boldsymbol{P}$はニア面の距離$n$とファー面の距離$f$によるLiSPSMで用いられる投資変換である。$\boldsymbol{V}$は視錐台である。](){#fig:10}

![Uniform(左)、Perspective(中)、および、Light Space Perspectiveシャドウマップ(右)の比較。それぞれ1024x1024のシャドウマップを用いている。](){#fig:11}

非常によく似たアプローチに、ニア面の距離を選ぶのにヒューリスティックを用いる、MartinとTanの*Trapezoidal Shadow Maps*[@MT04]がある。非常に洞察に優れた仕事として、Lloyd et al.[@LTYM06]はすべての遠近による湾曲アルゴリズム[perspective warping algorithm] (PSM、LiSPSM、TSM)が、両方のシャドウマップ方向を考慮するとき、同じ*全体[overall]*の誤差を実際に引き起こすが、LiSPSMが方向の間の最も均一な誤差分布をもたらし、故に、有利であることを証明した。

ChongとGortler[@Cho03; @CG04; @CG07]は複数のシャドウマップを用いることで有意義な少なさの面数でシャドウマップの品質を最適化する。彼らはコンピュータービジョンに由来する"plane-stabilization"技術を用いてこれらの面で完璧にサンプリングできることさえも示している(そのような面上のビューポートピクセルごとに、シャドウマップにおけるテクセルは厳密に同じ幾何的な点をサンプリングする)。それにも関わらず、そのような面にないピクセルは任意の誤差を示す。

### 対数関数的な湾曲 {id="sec:4.2.1"}

[@eq:1]で示した単純化された誤差の数式を再び考えよう。*最適なパラメーター化*は深度の取り得る範囲全体で$dp/ds$を定数(スクリーンとシャドウマップの解像度が等しいと仮定するため、1に等しい)にするだろう。ビュー方向がライト方向と垂直になる理想的なケースでは、これは(定数であるにも関わらず)[@WSP04]と等価である。

$$
ds = \frac{dz}{z} \text{、すなわち、} s = \int_0^s ds = \int_{z_n}^z \frac{dz}{z} = \ln \frac{z}{z_n}
$$

これはシャドウマップに対する最適なパラメーター化が対数関数的であることを示している。より最近の仕事では、Lloyd et al. [@LGQ*08]は対数マッピングを再考し、遠近による湾曲と組み合わせた(LogPSM)。非常に難解な数学の学術論文[treatise]において、彼らは、[@eq:2]に由来する厳密なサンプリング方程式に基づいた、最適な定数誤差にかなりのところまで近づいた湾曲の関数を導出する。彼らは完全に汎用の3D構成も考慮している。

残念ながら、そのようnパラメーター化は現在のハードウェア上での実装に対して実践的ではない。対数は頂点プログラムにおいて適用できるかもしれないが、ピクセルプログラムに対するピクセル位置やすべての入力パラメーターは双曲線的に[hyperbolically]補間される。これはグラフィクスハードウェアを対数マッピングではなく、遠近によるマッピングに従わせる。概念実証として、対数関数的ラスタライゼーションは最後のプリミティブをboundすることが保証されているクアッドをレンダリングすることによってフラグメントシェーダーで厳密に計算することができるが、これは実践的な実装では低速すぎる。これを緩和するため、Lloyd et al. [@LGMM07]は対数関数的ラスタライゼーションを実現可能にするためのラスタライゼーションパイプラインに対する単純な修正を提案するが、この修正は将来的にラスタライゼーションそれ自体がプログラマブルな構成要素となるまでグラフィクスハードウェアに実装されることはありそうにない。

### 遠近による湾曲に対する最適な湾曲パラメーター {id="sec:4.2.2"}

以前に言及した通り、遠近による湾曲の手法には$P$に対する自由パラメーター、すなわち、投影基準点[projection reference point]$\vec{p}$からニア面への距離$n$が存在する。このパラメーターはシャドウマップがどれだけ大きく曲げられるかに影響を与える。$P$のニア面近くで選択される場合、遠近による歪み[perspective distortion]は強くなり、その効果は元のPerspective Shadow Mapsと似る($n$が視錐台ニア面距離と同様に選ばれるところで)。$P$のファー面から遠くで選択される場合、遠近による効果は非常に軽く、Uniform Shadow Mapsに近づく。ライトベクトルに垂直なビュー方向のケースでは、このパラメーターに対する最適な選択は[@WSP04]であることを示すことができる。

$$
n_{opt} = z_n + \sqrt{z_f z_n}
$$

ここで、$z_n$と$z_f$はアイ視錐台のニアおよびファー面の距離である。[@fig:12]は、Uniform Shadow Maps、オリジナルのPSMの論文にある通りの湾曲パラメーターを使ったPerspective Shadow Maps、最適な湾曲パラメーターを使ったもの、に対してビュアーのZ軸に沿ったエイリアシング誤差を比較する。ただし、この解析はZ方向に平行なシャドウマップ方向における誤差のみを取り扱うことに注意する。$x$方向を考慮すると、PSMパラメーターは、プロットに確認できるように、最適な定数誤差を実際に引き起こし、Z方向に沿った誤差は非常に不均等であり、ビュアーから離れるように動くときに非常に悪いシャドウ品質を引き起こす。最適なLiSPSMパラメーターは2つの軸の間で均等な誤差分布を引き起こす[@LGQ*08]。

![頭上にあるディレクショナルライトに対する様々なシャドウマップ技術ごとにZ座標に対してプロットされた遠近によるエイリアシング誤差。](){#fig:12}

ビュアーがライトに向かって傾けられる、または、それから離れるとき、$n$は増加する。そのため、ビュアーがライトを厳密に覗き込む、または、それから離れるとき、無限大に達する。この場合、遠近による湾曲はいかなる改善ももたらすことができず、それ故に、湾曲を適用する必要は一切ない。

より矛盾のないシャドウ品質を生成するより複雑なフォールオフ関数は[@ZXTS06]で提案された。依然として、Z軸に沿った誤差のみを計算に入れているため、後にLloyd[@Llo07]のアプローチに取って代わられた。元のLiSPSMの論文では、シャドウマップの法線ベクトルとビュー面の法線ベクトルとの角度$\gamma$に依存するフォールオフが、$n'_{opt} = n_{opt} / \sin \gamma$とすることで、導入された。しかし、Lloyd[@Llo07]は後に、このフォールオフが、視錐台の面のひとつがシャドウマップの法線と並行になる点をその角度が通過すると、十分に高速でないことを示した。彼はこの問題を回避する異なるフォールオフ関数を提案している。これはここに記載するにはいささか複雑すぎるので、我々は厳密な数式について[@Llo07]の節5.1.2と5.2.1を読むことをおすすめする。従って、Lloydの方程式は実践的なシナリオで発生し得る一般的なケースでより堅牢である。

もうひとつの興味深い拡張として、$n$の計算に対して異なる視錐台のニア面の距離を用いるものがある。その理論的根拠[rationale]は、最も近い深度値(例えば、0.01から1の間)はしばしば可視のシャドウを含まないが、シャドウマップ中の多くの精度は最適な湾曲パラメーターを用いるこの範囲に浪費されている、という所にある。Lloydは彼の論文の節5.1.9で偽のニア面を用いて説明している。

依然として、これらの改善にも関わらず、湾曲ベースのアプローチの主な問題は残ったままである。角度$\gamma$が減少して0に近づく(ビューとライトの方向が並行になる)とき、湾曲は効果がなくなる。この場合、ある大局的な遠近による湾曲はビュアーのZ軸に沿ったサンプリング密度を変化することができず、故に、湾曲はUniform Shadow Mappingに劣化する。これはこの種[class]のアプローチが素早いシャドウ品質の変化の影響を受けやすくする。これは、時間的なちらつきアーティファクトを生み出す可能性がある。次の節で説明する分割の手法はこの観点においてより堅牢である。

## 分割 {id="sec:4.3"}

湾曲の手法と対象的に、分割の手法は複数のシャドウマップを用いることで理想的なサンプリング分布を近似しようとする。

### Z分割 {id="sec:4.3.1"}

最も卓越したアプローチであり最も実践的なアルゴリズムのひとつは、Z軸に沿って視錐台を分割[subdivide]して、サブ錐台ごとに個々の同サイズのシャドウマップを計算することである。このアルゴリズムは*plural sunlight buffers* [@TQJN99]、*parallel split shadow maps* (PSSM) [@ZSXL06]、*z-partitioning* [@LTYM06]、*cascaded shadow maps* (CSM) [@Eng07]の名で知られている。[@fig:13]は視錐台が3つの区画[partition]に分割されるPSSMの例を示し、中段の区画のマップに対するシャドウマップが強調される。このアプローチを用いると、同数のシャドウマップサンプルがより大きな範囲をカバーするので、サンプリング密度が後続の区画ごとに減少する。

![PSSM: 左: 視錐台の3つの区画の中段にたいするシャドウマップ(サイドビュー)が強調される。右: 区画の境界ボリュームが3Dで示される。はめ込まれたもの[inlays]はシャドウマップを示す。](){#fig:13}

最もナイーブな実装では、$n$ヶの区画を持つPSSMスキームは$n$回のシャドウレンダリングパスを必要とする。Zhang et al. [@ZSN07]はレンダリングパスの数を減らす3つの異なる手法を説明する。1つ目に、彼らはシャドウマップを生成およびレンダリングするために複数のパスを用いるナイーブな手法を計算する。この手法はシェーダーを必要とせず、故に、古いハードウェアで動作するが、新しいハードウェアや複雑なシーンでは最も低速な手法でもある。2つ目の手法はシェーダーを使い、それによってレンダリングでの複数パスを回避する。これはGeForce 8800とそれ以降で最大30%の高速化をもたらす。3つ目の手法はシャドウマップレンダリングパス中に必要なシャドウマップのそれぞれに各トライアングルを複製することで同様にシャドウマップを生成する複数パスを回避するためにジオメトリシェーダーか進化したインスタンシングを用いる。著者らはこの手法がパフォーマンスを更に増加させると言及しているが、彼らの論文にはこの記述を確認するための数値データが与えられていない。

この手法に対する最も重要な問題[question]は分割面を置く場所である。方法のひとつに、シャドウマップのリサンプリング誤差の導出に立ち戻るというものがある。各サブシャドウマップはグローバルシャドウマップの大きなテクセルとして解釈できたので、Z分割は任意の湾曲関数の離散化となる。我々は最適湾曲関数が対数関数であることを以前に示したので、故に分割位置$C_i$は[@LTYM06]のように決定される必要がある。

$$
C_i = z_n \left( \frac{z_f}{z_n} \right)^{\frac{i}{m}}
$$

ここで、$m$は分割数である。しかし、大局的な湾曲スキームとは対象的に、Z分割の効果はシャドウマップの軸に制限されず、ライトがビュアーのすぐ背後にあるときでも動作する([@fig:14]を参照)。これは湾曲アプローチに勝るZ分割の主な利点であり、Z分割が一般的な構成でより堅牢である理由である。[@fig:14]の左図ではビュアーのすぐ背後にライトがある状況での最も近い区画と最も遠い区画を示している。最も近い区画のシャドウマップは最も小さい範囲をカバーし、それ故に、ビュアーの投影の場合と同程度に、知覚される解像度は高い。例えば、Tadamura et al. [@TQJN99]やEngel [@Eng07]は幾何的に増加するサブボリュームにビューベクトルに沿った錐台を分割する。[@fig:15]は背後からのライトのケースにおけるZ分割と湾曲の直接比較を示す。

![湾曲が失敗するケースでもPSSMは動作する。例えば、光が背後から来るとき。](){#fig:14}

![光が背後から来る場合、湾曲(左)は十分でない結果をもたらす。一方のZ分割(右)は優れた結果をもたらす。フラグメントごとに使われるシャドウマップが色分け[color coded]される。](){#fig:15}

[@ZSXL06]は、ほとんどオブジェクトが存在しない[is rarely populated with objects]ニア面ちかくに最も大きな解像度を割り当てるので、最適な分割スキームがしばしば実践的でないことに言及[note]している。故に、彼らは対数関数スキームと単純な等距離の分割面分布の間の重み付き平均として分割位置を計算することを提案する。シャドウマップエイリアシングの理論的特性をより尊重する代替の解法は湾曲におけるものと同程度の偽のニア面を用いることである。このアプローチはLloydの学位論文の節5.1.8で説明される。

[@ZZB09]もまた、ちらつきアーティファクト、シャドウマップストレージ戦略、分割の選択、テクスチャ座標の計算、分割間のフィルタリングに関するZ分割の実践的な問題の数々を議論する。興味深い観察結果として、いくつかのケースでは、ひとつの区画に属する点が異なる区画に対して生成されたシャドウマップを用いて影付けされる必要がある、というものがある。これはライトがビュー方向にほぼ並行であるときに発生する。この場合、視点により近い区画に対するシャドウマップはより良い解像度を提供する。

依然として、配置とZ分割の大きさを手で最適化することは、特に深度範囲全体がシャドウでカバーされない場合に、優れた結果をもたらすことができる。この手動の調整を回避するため、Lauritzen [@Lau10]はCascaded Shadow Mapsの確率論的な拡張を発表した。そのアイデアは区画ごとにタイトなライト空間の境界を見つけるために現在のフレームに必要となるシャドウサンプル分布を解析することにある。このアプローチの主な制限はクラスタリングアプローチが、最新のハードウェアでのみ実現可能である、深度のヒストグラムの計算を必要とすることである。

### 錐台面分割 {id="sec:4.3.2"}

もうひとつの代替の分割スキームとして、シャドウマップ面に投影される視錐台の面ごとに個々のシャドウマップを用いて、そして、個別にシャドウマップごとに湾曲を用いることがある。これはポストパースペクティブの視錐台の周囲にキューブマップを置き、キューブの面ごとにシャドウマップを適用することと解釈することもできる[@Koz04]。各錐台面は品質を増加させるためにさらに分割することができる。

このスキームは、LogPSM、すなわち、Lloyd et al. [@LGQ*08]が導入したLogarithmicおよびPerspective Shadow Mappingの組み合わせに対して最適であることを示すことができるので、特に重要である。しかし、Lloyd et al. [@LGMM07]もまた実践的な状況、すなわち、ファー面とニア面の比が大きく、シャドウマップ数が少ない状況で(任意に湾曲と組み合わせた)Z分割が錐台分割より優れていることを示したので、ここではこのスキームを詳しく説明しない[elaborate]。

粗いシーン解析を組み込んだ異なるシャドウマップバッファへの分割はForsyth [@For06]によって説明される。このアイデアはシャドウレシーバーが視点への距離に従って異なるシャドウマップに分割できることにある。最適化された投影はこれらのクラスタのそれぞれで使うことができ、それによって、シャドウを生成するだけで良くなった。このスキームはシャドウがシーンにおいてまばらに[sparsely]発生するのみである場合に利点を持つことができるが、(シャドウがどこにでも存在する)一般的な設定では、(シーン解析の追加のオーバーヘッドを持つ)Z分割が理想的である。

### 適応的分割 {id="sec:4.3.3"}

これまでに議論した分割アルゴリズムの利点はこれらが非常に高速であることである。その一方で、これらは表面の向きを完全に無視するので、光源によってほぼ真横から見える表面、すなわち、投影によるエイリアシングに起因するアンダーサンプリングを改善しない。

アルゴリズムにはシャドウマップを生成する前にシーンを解析することでより最適な方法でサンプルを割り当てようとするものが多く存在する。これは解析方法によるいくつかのオーバーヘッドを必然的に負うが、一般的なケースでははるかに良い結果をもたらす。これはしばしば、以前は非常に高価な方法であった、フレームバッファの読み戻し[read-back]を必要とする。とは言うものの、このコストは最近のハードウェアでは減少傾向にあり、これらの手法は実践的な用途として徐々に興味深いものとなってきている。有名な[prominent]例として、*Adaptive Shadow Maps* (ASM) [@FFBG01; @LSK*05]、*Resolution Matched Shadow Maps* (RMSM) [@LSO07]、*Queried Virtual Shadow Maps* (QSM) [@GW07b]、*Fitted Virtual Shadow Maps* (FVSM) [@GW07a]、*Tiled Shadow Maps* (TiledSM) [@Arvo04]がある。

これらのアプローチのすべてはシャドウマップを精錬[refine]するために階層的データ構造(通常は四分木)に頼っている。これらは主に停止基準[termination criteria]、および、停止基準を決定するために必要な尺度[measures]において異なる。

シャドウマップに適応的な分割を導入した最初のアプローチはFernando et al.の*Adaptive Shadow Maps* [@FFBG01]である。そのアイデアは高品質なシャドウマップはシャドウのエッジで高解像度を必要とするのみであることにある。故に、シャドウマップは階層的格子構造(四分木)に格納される。各四分木ノードはそれに紐付いた[attached]固定の解像度のシャドウマップを持つ。フレームごとにそのノードは利用可能なシャドウマップ解像度を増加させるために繰り返し分割できる(分割ごとに新しいシャドウマップを生成する)。Lefohn et al. [@LSK*05; @LSO07]はスクリーン空間のピクセルの影付けを解決するのに必要とされるすべてのシャドウマップテクセルを生成するためにエッジ検出フェーズを取り除くことでこの手法を適合させる(*Resolution Matched Shadow Maps* (RMSM))。このアプローチをGPUで実現可能にするため、著者らはアイ空間とライト空間との間の一貫性[coherence]を用いる。彼らはイメージ空間で連続的に可視である表面がライト空間でも同様であると仮定し、これらの表面を見つけるための連結成分解析[connected-components analysis]を用い、これらのそれぞれにシャドウマップページを要求する。

GieglとWimmer[@GW07b]により導入されたQueried Virtual Shadow Maps (QVSM)は、停止基準を計算するために読み戻しを必要とせず、GPU上で階層的データ構造を実装する必要がないので、恐らく最も実装しやすい適応的分割スキームである。そのアイデアは非常に単純である。シャドウマップで確認される精錬由来の実際の変化が事前に定義されたしきい値を下回るまでシャドウマップ階層を精錬する。より厳密に言うならば、初期のシャドウマップ(例えば、2048x2048)から始まり、このシャドウマップは再びそれぞれが2048x2048の解像度を持つ2x2のサブタイルに分割される。そのような精錬ステップの後に毎回、シーンは精錬されたシャドウマップを用いて影付けされ、その影付けの結果は前のステップの結果と比較される。変化したピクセルの特定のしきい値がタイル内で超過される場合、精錬は継続される。これを高速にする方法は、前のものとの比較でより精錬されたシャドウマップを適用するときに異なるピクセル数を数えるためにオクルージョンクエリーのメカニズムを用いることでGPU上ですべての計算を行うことである。QVSMは比較的多くのシーンレンダリングパス数を必要とし、精錬ごとに1回試みる。シーンを複数回再レダリングするのを避けるため、まずシーンは線形の深度バッファにレンダリングされ、各レンダリングパスはシャドウを計算するのにこのバッファを単に用いる(Deferred Shadowingとも呼ばれる)。[@fig:16]はQVSMと大きな標準のシャドウマップの比較を示す。

![左: 標準の4096x4096のシャドウマップ。右: 32x32の最大精錬レベルと2048x2048のタイルを持つQVSM。](){#fig:16}

QVSMでシャドウレンダリングパス数が大きくならないようにするために、GieglとWimmer[@GW07a]は四分木においてどれだけの最終精錬レベルが必要になるかを前もって定めようとするFitted Virtual Shadow Mmaps (FVSM)を導入した。これでは、実際にシーンが影付けされる代わりに、シーンはプリパスでレンダリングされ、このパスはシャドウマップに、クエリーの場所で必要なシャドウマップ解像度と同様に、クエリーの場所を単に記録する。その後、結果のバッファはCPUに転送される。そこで、このバッファの各サンプルはシャドウマップ空間に変換され、CPUの効率的な分散能力[scattering capabilities]を利用するために、低解像度バッファに格納される。このバッファはシャドウマップの各範囲における必要な解像度を最終的に[ultimately]含み、四分木構造はここから導出できる。読み戻しによるペナルティを減らすため、プリパスでは小さなフレームバッファがレンダリングされるのみである。Adaptive Shadow Maps [@FFBG01; @LSK*05]と比較して、QVSMとFVSMの両方は新たに[anew]フレームごとに階層全体を計算するのに十分高速であり、故に、精錬レベルを計算するのに反復的なエッジ検出アルゴリズムを頼っているASMとは対称的に動的なシーンに対して上手く動作し、それ故に、最近使用したタイルをキャッシュする必要がある。

RMSMは、FVSMと幾らか同じように、反復ステップを回避したり、必要な解像度を直接的に計算したりすることによって、特に動的なシーンでASMに改良を加える。両方のアルゴリズムもまた(四分木やソートのような)データ並列なGPUアルゴリズム[@LKS*06]を標準のレンダリングと混ぜ合わせる。RMSMでは、すべてのステップがGPUで実際に行われ、一方、FVSMはCPUで必要な細分化[subdivision]レベルを計算するが、それは低解像度バッファで行われる。

*Tiled Shadow Maps* [@Arv04]は深度の不連続性、距離、その他のファクターに基づいた階層的な解析に従ってサンプリング品質を変化させるためにライトビュー(ここでは固定解像度のシャドウマップ)をタイル化する。これは厳しい[hard]メモリ制限を設定することを可能にし、それによって、品質と速度をトレードする。

## 湾曲と分割の比較 {id="sec:4.4"}

TODO

## 4 {id="sec:4.4.1"}

## 4 {id="sec:4.4.2"}

## 4 {id="sec:4.5"}

## 4 {id="sec:4.6"}

# 5 {id="sec:5"}

# 6 {id="sec:6"}

# 7 {id="sec:7"}
