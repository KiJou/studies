---
title: Geometry Buffer Anti-Aliasing (GBAA) [@Persson2011]
numberSections: false
---
# 基本のアイデア[Basic Idea]

MLAAと仲間たちはバックバッファ(と任意に深度バッファ)からエッジを復元する。

アイデア:
ゲームエンジンはエッジのある所を知っている。
それを使おう！

# 第1の試み --- GPAA[First Attempt - GPAA]

- 最終画像にエッジを上描きする。
    - 主要な方向(水平/垂直)を確定する。
    - カバレッジを計算する。
    - 適切な近傍でブレンドする。
        - テクスチャフィルタに最適化する。
    - シーンのジオメトリを事前処理する。
        - 関連するエッジを抽出する。

プリプロセスは表面にある内部エッジを除外し、共有されたエッジから重複分を取り除く。
線の式はスクリーン空間で計算され、ピクセルシェーダに渡される。

# GPAA --- シェーダ[GPAA - Shader]

```hlsl
// 幾何的な線の間の差異を計算し、位置をサンプルする。
float diff = dot(In.KMF.xy, In.Position.xy) + In.KMF.z;

// 近傍の表面のカバレッジを計算する。
float coverage = 0.5f - abs(diff);
float2 offset = 0;

if (coverage > 0) {
    // 方向を選択して、近傍ピクセルをサンプルする。
    flot off = (diff >= 0) ? 1 : -1;
    if (asint(In.KMF.w))
        offset.y = off;
    else
        offset.x = off;
}

// テクスチャフィルタリングと座標ずらしを適切に用いて近傍ピクセルをブレンドする。
return BackBuffer.Sample(Filter, (In.Position.xy + coverage * offset.xy) * PixelSize);
```

`In.KMF`は水平か垂直のいずれかの方向に対する線の式を含む。方向フラグが`w`に格納される。
サンプリング方向は線がピクセル中心をどちら側に切り取るかに基づいて選択される。
カバレッジは距離から計算される。

# GPAA --- 結論[GPAA - Conclusions]

- 非常に高品質
    - 非常に正確なカバレッジ
    - 水平/垂直に近いケースに優れる。
- 時間的に安定
- エッジ抽出ステップ
    - 不便[incovenient]
    - メモリ消費を増加させる
- 線のラスタライゼーション
    - パフォーマンス的に理想的でない
    - 増加する幾何的密度のスケーリング問題

ソース付きデモがhttp://www.humus.nameでダウンロードできる。

# 第2の試み --- GBAA[Second Attempt - GBAA]

- メインパスでレンダターゲットにジオメトリ情報を格納する。
    - ジオメトリの事前処理なし
    - 線のラスタライゼーションなし
    - 小さな一定メモリの追加
- フルスクリーン"解決"パス
    - 固定のコスト

ジオメトリバッファはフルスクリーンで、2チャンネルの、符号付きフォーマットである。必要ならば1チャンネルにパックできるだろう(1ビットは水平/垂直のためのフラグを格納する)。

# GBAA

- ジオメトリシェーダはジオメトリ情報を伝達する。
    - 主要な方向でのエッジへの距離を格納する。
    - 線の式の計算ではなく補間器を用いる。
        - `noperspective`キーワードを用いる。
- ピクセルシェーダは最も近いエッジを選択する。

`d_dir = d / (|n.x| > |n.y| ? n.x : n.y)`

エッジ上の2つの頂点は当然そのエッジへの距離が0である。
上の頂点は、そのエッジが横[horizontal]なので、縦[vertical]の距離が割り当てられる。
垂線の長さ[perpendicular distance]`d`が初めに計算され、縦の距離`dx`にするファクタでスケールされる。

# GBAA --- 解決[GBAA - Resolve]

- ピクセルごとに、交差するエッジに対してバッファを調べる。
    - 距離がピクセル半分より小さいならば、1を得る。
        - 近傍を選択し、カバレッジを計算し、ブレンドする。
    - そうでなければ、ピクセルを据え置く。

<!-- p.11 -->

TODO
