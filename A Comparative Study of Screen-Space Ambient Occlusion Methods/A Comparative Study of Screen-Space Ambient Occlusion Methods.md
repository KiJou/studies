---
title: A Comparative Study of Screen-Space Ambient Occlusion Methods [@Aalund2013]
---
# はじめに {#sec:1}

## 動機 {#sec:1.1}

シャドウは物体同士の空間的な関係を見た目に判断するための手がかりとなる。シャドウがないと、平坦に見えたり浮遊しているように見えたりする。

シャドウの計算は大縮尺[large-scale]シャドウと小縮尺[small-scale]シャドウに分けられる。アンビエントオクルージョンは後者に含まれる。

## 大まかな歴史 {#sec:1.2}

アンビエントオクルージョンは初めにレイトレーシングで使われ、次に、リアルタイムのインタラクティブアプリケーションでの前処理工程[@Moller2008]で使われるが、これは静的なワールドに制限される。2007年以降、いわゆる*スクリーンスペース[screen-space]*のアプローチを用いて、期待される他の効果と一緒に、オンザフライかつリアルタイムに実現可能であることが証明されてきた[@Mittring2007a; @Shanmugam2007; @Nguyen2007]。これはアニメーションや物理を含む動的な環境で上手く動作する。さらに、遮蔽データの事前計算が必要ないため、アーティストやメモリの予算を軽減する。

スクリーンスペースアンビエントオクルージョン(SSAO)はいくつかの欠点も持ち合わせている。レイトレーシングは一般に優れた画像を生成し、他の大局照明効果とうまく統合する。SSAOも時折近しい所まで行くが、いくつかはcolor-bleeding効果を含んでいたりもする[@Ritschel2009]。依然として、高速化には情報を破棄する必要があるが、それ故に品質に悩まされるだろう。一般則として、品質を良くしようとすればそれだけパフォーマンスコストがかかるが、アルゴリズム的な発展は大いに役立つ可能性がある。

## プロジェクト {#sec:1.3}

## 報告の概要 {#sec:1.4}

# 背景 {#sec:2}

## レンダリング理論 {#sec:2.1}

光と表面の間の相互作用は複合的であり、故に、リアルタイム用途ではかなり近似される。それを行う歴史的に有名な方法は光を*ディフューズ[diffuse]*、*スペキュラ[specular]*、*アンビエント[ambient]*の構成要素に分けることである[@Cook1982]。この議論では、前者2つ(ディフューズとスペキュラ)を*直接光[direct light]*、光源から直接来る光とすれば事足りる。アンビエント光はすべての*間接光[indirect light]*、直接光でないすべての光である。例えば、任意の回数の反射または屈折を経験した光がある。

与えられた表面点[surface point]と方向に対して物理的に正しい間接光を計算することは計算的に難しい。各表面点$\boldsymbol{p}$と方向$\omega$の対は以下の関連する量を持つ。

- $L_o$、与えられた方向$\omega$に対する$\boldsymbol{p}$における出射する[outgoing]放射輝度。
- $L_i$、与えられた方向$\omega$に対する$\boldsymbol{p}$における入射する[incomming]放射輝度。
- $f$、$\boldsymbol{p}$における$\omega$に沿った出射する放射輝度と入射方向$\omega_i$に沿った入射する放射照度[incident irradiance]の比。双方向反射率分布関数[bidirectional reflectance distribution function] (BRDF)として知られている。

3つすべての量の間の相互作用はずっと複雑である[@Kajiya1986]。

$$
L_o = \int f L_i \cdot (n \cdot \omega) d\omega
$$ {#eq:2.1}

## アンビエントオクルージョン {#sec:2.2}

アンビエント光は*すべて*の入射方向に対して集約された間接光である。これは、アンビエント光を決定するためには[@eq:2.1]の積分を計算しなければならない、ということである。これはアンビエント光を更なる仮定なしに扱いづらい量にしている。そこで、状況を改善するため、かなり大量の仮定が作られている[@Cook1982]。

- アンビエント光は一様に入射する。すなわち、入射する放射輝度はすべての方向で同じになる($L_i$は定数)。
- アンビエント光は見ている角度に依存しない。すなわち、反射した光の比はすべての方向で同じになる($f$は定数であり、その表面は*ランバート[Lambertian]*である)。

合わせて、これらの近似はアンビエント光のより単純なモデルをもたらす。

$$
L_{oa} = f L_{ia} \int (n \cdot \omega) d\omega
$$ {#eq:2.2}

[@eq:2.2]の積分は$\boldsymbol{p}$における半球の可視性であり、まずは以下のように書き表すとする。

$$
A(\boldsymbol{p}) = \frac{1}{\pi} \int (n \cdot \omega) d\omega
$$ {#eq:2.3}

ここで、$\boldsymbol{p}$は照らされている点であり、$n$は$\boldsymbol{p}$における表面の法線であり、$\omega$は積分の方向である。この積分は$\boldsymbol{p}$と$n$によって定義される半球の*遮蔽されていない[unoccluded]*部分に対してである。内積$n \cdot \omega$はこの文脈においてその意味が変化し、浅い角度でのオクルーダーが大きな範囲に投影されるという事実を考慮するために可視性を調整する。

$A$はアンビエント光のオクルージョンを計算に入れる。古典的な単純化では積分計算を回避するために$A=1$を用いる。モダンな実装では[@eq:2.3]によるオリジナルの定義を用いて、$\boldsymbol{p}$から可視である方向に入射するアンビエント光$L_{ia}$を制限する。

### 半球の定義 {#sec:2.2.1}

関数$V(\boldsymbol{p}, \omega)$を方向$\omega$における$\boldsymbol{p}$からのレイの*可視性[visibility]*とすると、$V$は以下のように定義される。

$$
V(\boldsymbol{p}, \omega) = \begin{cases}
0 & \text{方向} \omega \text{における} \boldsymbol{p} \text{からのレイがなにかに当たる場合} \\
1 & \text{その他}
\end{cases}
$$

すると、半球全体で計算するために$A$を拡張できる。その新しい積分は以下となる。

$$
AO(\boldsymbol{p}) = \frac{1}{\pi} \int_{\Omega} V(\boldsymbol{p}, \omega) (n \cdot \omega) d\omega
$$ {#eq:2.4}

ここで、$\Omega$は$\boldsymbol{p}$と$\omega$によって定義される半球である。アンビエントオクルージョン(AO)[@Landis2002]という用語は基本の式の長らく後に新造された。離散的な方向数をテコ入れすることでレイトレーサーでのモンテカルロ積分によって定めることができる[@Landis2002]。

$$
AO \approx \frac{1}{N} \sum_{n=1}^{N} V \cdot (n \cdot \omega_n)
$$

ここで、$N$は調査用[probe]のレイの数であり、$\omega_n$は各$n$に対して一様に無作為に選ばれた方向である。

## Ambient Obscurance {#sec:2.3}

開口部が小さくて抜け出せるレイが極わずかである、すなわち、ほとんどの部分で$V$が0となる場合、[@eq:2.4]で与えられるようなAOの式でレンダリングすると、ほぼ識別不可能なほどに暗くなる。これは望ましくなく、我々は見た目に満足な結果をもたらすAOのさらに実践的な定義を必要とする。

Ambient Obscurance[@Zhukov1998]は可視性の関数$V$を距離$d$に基づく減衰(フォールオフ)関数$\rho(d)$で置き換える。関数$\rho$は経験的に選ばれるが、以下のような一般的な特性を持つ必要がある。

- $\rho$は$d$の単調増加関数である。
- $d > d_{max}$に対する$\rho(d) =1$となるような上限$d_{max}$が存在する。

$\rho$によるアイデアは遠くのオクルーダーが受ける影響を少なく、または、一切なくすることにある。これは結果の画像を一般に明るくし、見た目に満足な結果を生み出す。$\rho$は物理ベースではなく、審美眼に基づいて完全に選択されることに注意すべきである。Ambient Obscuranceの定義はすでに見てきたものと似ている。

$$
AO^{* }(\boldsymbol{p}) = \frac{1}{\pi} \int_{\Omega} \rho(|\boldsymbol{p}\omega - \boldsymbol{p}|)(n \cdot \omega) d\omega
$$ {#eq:2.5}

ここで、$|\boldsymbol{p}\omega-\boldsymbol{p}|$は$\boldsymbol{p}$から調査用レイにヒットした最初の表面への距離である。

$V$は本当に単に$d_{max}=\infty$での$\rho$の特殊なケースであることに注意する。

## Inversion {#sec:2.4.1}

$AO$関数はアンビエントの*遮蔽[occlusion]*を示そうとしているにも関わらず、*可視性*によって増加する($AO=1$で完全に可視であることを示す)。そのため、著者によっては以下のように定義を反転するのを好む場合がある。

$$
AO = 1 - \int \dots
$$

これは多かれ少なかれ好みの問題であり、このレポートでは、各手法で与えられる定義を用いる。

## リアルタイムレンダリング {#sec:2.5}

### 変換、空間、座標 {#sec:2.5.1}

### ディファードレンダリング {#sec:2.5.2}

### シェーダ {#sec:2.5.3}

# 解析 {#sec:3}

## レイトレーシングとラスタライゼーション {#sec:3.1}

歴史的に、AOはレイトレーサーのために用意された機能であったが、レイトレーサーはGPUが活用するラスタライゼーションアプローチと互換性がないため、大きな商業基盤におけるインタラクティブなリアルタイムレンダリングでは用いられていない。

## 以前の研究 {#sec:3.2}

### ディスクプロキシ {#sec:3.2.1}

このアルゴリズムはディスク要素に分解されたシーンのすべてのポリゴンメッシュを入力として必要とする。そのアイデアはシーン中のジオメトリを遮蔽するディスク数を確認することにある[@Pharr2005]。これが初めて提案されたAO実装に対するレイトレーシングの代替案であり、後に、結果を平滑化することで改良された[@Nguyen2007]。

### アンシャープマスキング {#sec:3.2.2}

[@Luft2006]

### 最初のスクリーンスペースアプローチ {#sec:3.2.3}

#### シーン近似としての深度バッファ

深度バッファは、元々の目的を越えて、シーンの粗い表現として働くことも可能である[@Mittring2007a; @Shanmugam2007]。

#### 拡張されたパイプライン

AOは入力に深度バッファのみを用いるため、同じく入力に深度バッファを用いるシェーディングパスでAOを計算させることができるが、低解像度で計算したりパフォーマンス特徴の割り出しがし易かったりするので、専用のAOパスで計算したほうが良い。

#### スクリーンスペース積分

シーンを深度バッファで表現することで、[@eq:2.5]の積分を解くいくつかの興味深いアプローチが可能となる。

方法のひとつは標本点[sample point]近くでの遮蔽と可視の比で$AO$を近似することである[@Mittring2007a; @Mittring2007b; @Dachsbacher2009]。

$$
AO \approx \frac{1}{N} \sum_{n=1}^{N} V'(s_n)
$$ {#eq:3.1}

ここで、$N$は標本点の数であり、$s_n$は$n$番目の標本点であり、$V'$は$s_n$が可視であれば$1$、そうでなければ$0$である。$s_n$の標本点は半径$r$を持つ$\boldsymbol{p}$周辺の球に拡散される。

現在の点$\boldsymbol{p}$は始めに再構築されなければならず、計算コストが低いスクリーン座標で$\boldsymbol{p}$を再構築するアプローチが選ばれる。$\boldsymbol{p}_{xy}$は現在のピクセル座標であり、$\boldsymbol{p}_z$は深度バッファから直接読み出すことができる。$\boldsymbol{p}$が定まれば、周囲の球に標本点を選ぶことは自明となるはずである。しかし、手法の著者が記す通り、これはアーティファクトの源となり得る。

標本の位置$\boldsymbol{s}$は$\boldsymbol{p}$と同様にスクリーン座標上にあり、関連する$\boldsymbol{s}_z$の座標を持つ。$\boldsymbol{s}$の上にある表面の深度は$\boldsymbol{s}_d = \text{depth}(\boldsymbol{s}_{xy})$として深度バッファから読み出すことができる。後は単純な比較を行うだけで可視性が定まる。

$$
V'(\boldsymbol{s}) = \begin{cases}
1 & \boldsymbol{s}_d > \boldsymbol{s}_z \\
0 & \text{その他}
\end{cases}
$$

この手法([@eq:3.1])は元の式([@eq:2.5])にあるような半球ではなく、$\boldsymbol{p}$の周囲の球の中でサンプルすることにも注意する。すなわち、平坦な表面に対してでさえ、サンプルの半分が遮蔽されることを期待しなければならない。

理論上よろしくても、標本分布の問題が残っている。標本位置が$\boldsymbol{p}$ごとに固定される場合、結果のAOはバンディングアーティファクトを持つだろうから、代わりに、標本位置を一様に無作為に分布させる。これはバンディングアーティファクトを除去するが、高周波ノイズを引き起こす。著者らはAO計算上でジオメトリ対応[geometry-aware]のブラーを適用することでノイズを回避する。残念ながら、GPUの特徴により、ブラーはそれ自身のシェーダパスで行われなければならない。もうひとつの障害はシェーダプログラムが乱数をを生成できないことであるため、代わりに、事前に計算した乱数のバッファをAOシェーダに供給する。

#### バリエーション

以下に概略される差異を持つ前述の手法のバリエーション[@Filion2008]が存在する。

標本位置はワールド座標で探し、深度比較のためにスクリーン座標へ投影される。著者らは、単純な比較関数$V'$を前に使っていたが、減衰関数$\rho$も再導入している。これは高い$\boldsymbol{s}_d$の値を持つ前面のオブジェクトに起因する過剰な遮蔽[over-occlusion]を軽減する。前述の通り、標本の半分はデフォルトで遮蔽されていると扱われるので、代替アプローチではまず球の中の標本を探すが、表面の法線$n$に従って半球にこれらをflip backする。事実上、サンプルの半数がこのアプローチでは必要になる。

#### 球プロキシ

スクリーンスペースで動作し、多くの特性を共有する、[@Mittring2007a]と同時期に独立して開発された手法は、球プロキシで表現される表面近くの遮蔽を平均することで$AO$を近似する[@Shanmugam2007]。この手法は、[@Mittring2007a]と同様に、スクリーン座標で$\boldsymbol{p}$を再構築し、同様にスクリーン座標で$\boldsymbol{p}$の周りの*ディスク*内の$N$ケのサンプル$s_n$を分布させる。これは、その類似性がstopであった場合、各サンプル$s$が$s_z = s_d$で表面に投影されるので、ワールド座標への変換に従う。球は近くの表面を近似することを意図している各ワールド空間$s$に位置する。球の半径は$s_d$の関数である。$AO$は球が$p$で半球を遮蔽するサンプル数の合計として近似される。これは単に[@Mittring2007a]に見られる$V'$のような比較関数ではないことに注意する。

上記で述べられる手法は非常に込み入っており、他の提案と比較して非常に異なって$AO$の近似に取り掛かる。

### A Horizon-Based Approach {#sec:3.2.4}

$AO$を近似するもうひとつの方法は$p$周りの半球上で見える地平線の角度$h$を定めることによるものである[@Bavoil2008a; @Bavoil2008b; @BavoilSainz2008; @Dachsbacher2009]。高さフィールドが連続的であるという仮定の下では、この角度を越えてトレースされるレイは遮蔽されるはずである。さらに、視線ベクトルの周りに与えられた角度$\theta$に対する地平線の角度$h(\theta)$が求まると仮定する。我々は視線ベクトル周りの*すべての*$\theta$に対する$h$の平均を求めたい。この手法の著者らはそれを行うために以下の式を提示する。

$$
AO = 1 - \frac{1}{2\pi} \int_{\theta=-\pi}^{\pi} AO_{horizon}(\theta)d\theta
$$ {#eq:3.2}

ここで、積分は視線ベクトルの周りのすべての角度$\theta$全体で行われる。$AO$の定義が反転していることに注意する。

すると、与えられた$\theta$に対しいて$AO_{horizon}(\theta)$を計算する方法が必要になる。[@eq:2.5]では$\rho$によって重み付けされた接線から法線までのすべての方向でレイをトレースする必要があるが、$h(\theta)$以下のすべてのレイは遮蔽されることがすでに分かっており、逆に、$h(\theta)$以上のすべてのレイは可視であるため、いずれの場合もトレースする必要はない。代わりに、接線の角度$t(\theta)$と$h(\theta)$の間の積分としてAOの寄与を求めることができる。$t(\theta)$は$n$と$\theta$から容易に導くことができる。著者らは以下としている。

$$
AO_{horizon} = \int_{\alpha=t(\theta)}^{h(\theta)} \rho(d) \cdot \cos(\alpha) d\alpha
$$ {#eq:3.3}

ここで、$\cos(\alpha)$は[@eq::2.5]からの内積である。$\rho(d)$は少々込み入っており、後に説明したい。著者らは[@eq:3.3]を以下へとさらに計算する。

$$
AO_{horizon} = \rho(d) \left( \sin(h(\theta)) - \sin(t(\theta)) \right)
$$

すると、[@eq:3.3]を[@eq:3.2]に挿入できる。計算目的のために、この積分を解くのにモンテカルロ積分を用いることも有用である。

$$
AO = 1 - \frac{1}{N} \sum_{n=1}^{N} \rho(d_n) (\sin(h(\theta_n)) - \sin(t(\theta_n)))
$$ {#eq:3.4}

ここで、$N$はサンプル数である。

#### スクリーンスペースの計算

[@eq:3.4]を実装する鍵は、同じ著者らによって提案されるように、$h(\theta)$を求めるためにスクリーンスペースで深度バッファをレイマーチすることである。レイはスクリーン座標で$p$から方向$\theta$に生成され、深度バッファを横断し、別個の間隔でサンプルする。各サンプルは$s_z = \text{depth}(s_{xy})$でシーンの表面に投影される。サンプルのAO寄与は遮蔽された角度$\text{acos}(t^{* }, \text{normalize}(s-p))$から計算され、$\rho(|s-p|)$で重み付けされる。$t^{* }$は初期の接線ベクトルであるが、後続のサンプルの各$s-p$ベクトルへ[reassign]される。これは各サンプルが貢献することを可能にし、過剰遮蔽を回避する。現時点で定義される$t^{* }$以下であるサンプルは$p$から見えないので却下される。

さらに、著者らは規則正しい[systematic]ノイズを回避するためにレイマーチングのステップサイズをジッタリングして無作為に方向を選択することを提案する。これは[@Mittring2007a]で遭遇したアーティファクトと似たものである。

#### バリエーション

アイ空間でレイをトレースし、バッファをサンプリングするために毎ステップにスクリーン座標に投影する方法もある[@Dimitrov2008; @Sainz2008]。これはHorizon-Split AO(HSAO)として知られ、対して、[@Bavoil2008a]で述べられる手法はHorizon-Based AO(HBAO)として知られている。追加された投影はパフォーマンスの観点でHBAOを優れたものにする追加の計算を暗示する。HSAOとHBAOの両方を支持する論文は同じ著者らによるものであるが、後者の論文は前者の半年後のものであるので、我々はHBAOはHSAOの改良版であると結論付けても差し支えはないと考えている。

### Directional Occlusion {#sec:3.2.5}

Screen-Space Directional Occlusion (SSDO) [@Ritschel2009; @Dachsbacher2009]は$AO$だけでなく、$p$に属する表面の入射する放射輝度も計算する。これはその結果に色付きで有向のシャドウを可能にする。さらに、SSDOは光のディフューズ間接バウンスをひとつ近似する任意の第2パスを持つ。これは最初のパスで集められた直接放射輝度の値近くをサンプリングすることで行われる。従って、レイトレースの大域照明ソリューションで知られているcolor bleeding効果が起こり得る。

著者らは、深度バッファが最前面のオブジェクトに関する情報のみを含んでいることに起因するシーン情報の欠落の問題に対処するため、*depth peeling*を用いることを提案する。

### マルチレイヤとマルチ解像度 {#sec:3.2.6}

[@BavoilSainz209]は一般的なSSAOアルゴリズムへの2つの改善を提示する。

1つ目の改善は品質ついてである。著者らは[@Ritschel2009]ですでに提示されたようなdepth peelingを用いることを提案し、加えて、シーン際近くでのアーティファクトを修正するために$AO$を計算するときに拡大した視野(ガードバンド)を用いることも提案する。

2つ目の改善は品質を犠牲にしないパフォーマンスに焦点を当てる。そのキモはAO計算をハーフ解像度とフル解像度の2つのパスに分けることである。

#### バリエーション

マルチ解像度を用いると、ブラーステップを省略できる[@HoangLow2010]。$AO$はまず対称的な低解像度の入力(深度と法線バッファ)を用いてますます低解像度で計算され、異なる$AO$値が最終的なフル解像度のレンダリングに組み合わせられる。そのアイデアは[@BavoilSainz2009]で開発されたデュアル解像度手法と似ているように見えるが、いくつかの重要な差異が存在する。まず、著者らは$AO$の計算に用いる深度と法線をダウンサンプリングすることを提案する。これはすでに粗いシーンの近似を粗くする。次に、彼らは$AO$値を組み合わせるのに知的な組み合わせのスキームを提案せず、ただ単にエッジ対応バイラテラルフィルタを用いて一緒にブレンドすることを提案する。その粗い近似にも関わらず、著者らは良好な結果をもたらすとしている。マルチ解像度の入出力バッファはミップマップによりモダンなハードウェアで容易に表現される。

同著者らはいくつかの改善で2年後に初期の実装を再検討する[@HoangLow2012]。今回は、各パスが数学的な動機付けと共に詳細に説明されている。また、著者らは両方の入力バッファを賢くダウンサンプリングし、$AO$値を組み合わせる手法を提示する。このように、提案される手法は審美眼的に動機付けされるのみならず、その背後に理に適った数学的な理由付けがなされている。

### A Temporal Approach {#sec:3.2.7}

$AO$計算の品質を改善する方法のひとつは前フレームからの情報を再利用することである[@SmedbergWeight2009]。*テンポラルフィルタ[temporal filter]*は移動するシーンの結果を改善することを示す。動機付けを行う観察結果はビュー(カメラ)が、通常のケースではシーンのアニメーションを行うので、フレームからフレームへ徐々に変化することである。そのアイデアは*時間をかけて[over time]* 2つの項をブレンドすることでフレーム$n$の$AO$でフレーム$n-1$の$AO$をフィルタリングすることにあり、実質的に移動中のノイズアーティファクトを取り除く。これが機能するためには、フレーム$n$のビューおよびアニメーションステートがフレーム$n$で利用できなければならず、メモリオーバーヘッドを被る。スクリーン座標における$p$は2つのフレームの間で異なる可能性が高いので、ワールド座標における$p$からフレーム$n-1$とフレーム$n$の両方で計算されなければならない。ビューとアニメーション種テートを保存するとこれが可能になる。著者らはこれを*再投影[reprojection]*と呼んでいる。

動きがないとき、この追加のテンポラルフィルタは品質的な利点をもたらさず、パフォーマンスコストをもたらすのみである。これはフィルタが*時間をかけて*フレーム間をブレンドするためである。静的なシーンでは、フレーム間で$AO$が変化せず、フィルタが効力を持たず、動的なシーンでさえ、新旧$AO$値の間の収束レート[rate of convergence]に基づいて発生し得る。

著者らは、サンプリング半径が大きすぎると、無作為なサンプル探索[look-up]がテクスチャキャッシュをめちゃくちゃにするとも説明する。小さな値に半径をクランプすることはキャッシュ内のテクスチャサンプルの空間的局所性を改善する。

#### バリエーション

他の見方はフレーム間で$AO$計算を単純にブレンドしたりはせずに時間をかけて$AO$を精錬するためにサンプルを実際に再利用することであり[@Mattausch2010; @Scherzer2010]、すなわち、より良い結果に収束するために古いフレームのサンプルを集める[aggregate]ことである。これは大量のサンプルがピクセルあたりに追加で格納されなければならないことを示しているが、静的なシーンでも品質が改善するだろう。この手法は[@SmedbergWeight2009]と無関係に開発された。

著者らはディファードパイプラインに再投影を統合する方法やdisocclusionを扱う方法に踏み込んでいる。後者は前景[foreground]の動きによって後景[background]のオブジェクトが可視になる(disoccluded)ときのことである。一般的なアイデアはフレーム$n-1$と$n$の間のワールド座標における$p$の相対的な深度差が与えられたしきい値以上であるかを確かめることにある。それが正しければ、$p$が後景のオブジェクトの表面を表現している可能性が大いに高く、$AO$は再び計算されなければならない。

### The First Hybrid {#sec:3.2.8}

[@Bavoil2008a]と[@ShanmugamArikan2007]に見られる手法の組み合わせは最初に提案されたハイブリッド手法を形成する[@Song2010]。

### ボリューメトリックなアプローチ {#sec:3.2.9}

TODO
