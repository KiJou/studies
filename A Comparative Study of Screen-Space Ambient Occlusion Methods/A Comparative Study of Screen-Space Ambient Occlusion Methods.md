---
title: A Comparative Study of Screen-Space Ambient Occlusion Methods [@Aalund2013]
---
# はじめに {#sec:1}

## 動機 {#sec:1.1}

シャドウは物体同士の空間的な関係を見た目に判断するための手がかりとなる。シャドウがないと、平坦に見えたり浮遊しているように見えたりする。

シャドウの計算は大縮尺[large-scale]シャドウと小縮尺[small-scale]シャドウに分けられる。アンビエントオクルージョンは後者に含まれる。

## 大まかな歴史 {#sec:1.2}

アンビエントオクルージョンは初めにレイトレーシングで使われ、次に、リアルタイムのインタラクティブアプリケーションでの前処理工程[@Moller2008]で使われるが、これは静的なワールドに制限される。2007年以降、いわゆる*スクリーンスペース[screen-space]*のアプローチを用いて、期待される他の効果と一緒に、オンザフライかつリアルタイムに実現可能であることが証明されてきた[@Mittring2007a; @Shanmugam2007; @Nguyen2007]。これはアニメーションや物理を含む動的な環境で上手く動作する。さらに、遮蔽データの事前計算が必要ないため、アーティストやメモリの予算を軽減する。

スクリーンスペースアンビエントオクルージョン(SSAO)はいくつかの欠点も持ち合わせている。レイトレーシングは一般に優れた画像を生成し、他の大局照明効果とうまく統合する。SSAOも時折近しい所まで行くが、いくつかはcolor-bleeding効果を含んでいたりもする[@Ritschel2009]。依然として、高速化には情報を破棄する必要があるが、それ故に品質に悩まされるだろう。一般則として、品質を良くしようとすればそれだけパフォーマンスコストがかかるが、アルゴリズム的な発展は大いに役立つ可能性がある。

## プロジェクト {#sec:1.3}

## 報告の概要 {#sec:1.4}

# 背景 {#sec:2}

## レンダリング理論 {#sec:2.1}

光と表面の間の相互作用は複合的であり、故に、リアルタイム用途ではかなり近似される。それを行う歴史的に有名な方法は光を*ディフューズ[diffuse]*、*スペキュラ[specular]*、*アンビエント[ambient]*の構成要素に分けることである[@Cook1982]。この議論では、前者2つ(ディフューズとスペキュラ)を*直接光[direct light]*、光源から直接来る光とすれば事足りる。アンビエント光はすべての*間接光[indirect light]*、直接光でないすべての光である。例えば、任意の回数の反射または屈折を経験した光がある。

与えられた表面点[surface point]と方向に対して物理的に正しい間接光を計算することは計算的に難しい。各表面点$\boldsymbol{p}$と方向$\omega$の対は以下の関連する量を持つ。

- $L_o$、与えられた方向$\omega$に対する$\boldsymbol{p}$における出射する[outgoing]放射輝度。
- $L_i$、与えられた方向$\omega$に対する$\boldsymbol{p}$における入射する[incomming]放射輝度。
- $f$、$\boldsymbol{p}$における$\omega$に沿った出射する放射輝度と入射方向$\omega_i$に沿った入射する放射照度[incident irradiance]の比。双方向反射率分布関数[bidirectional reflectance distribution function] (BRDF)として知られている。

3つすべての量の間の相互作用はずっと複雑である[@Kajiya1986]。

$$
L_o = \int f L_i \cdot (n \cdot \omega) d\omega
$$ {#eq:2.1}

## アンビエントオクルージョン {#sec:2.2}

アンビエント光は*すべて*の入射方向に対して集約された間接光である。これは、アンビエント光を決定するためには[@eq:2.1]の積分を計算しなければならない、ということである。これはアンビエント光を更なる仮定なしに扱いづらい量にしている。そこで、状況を改善するため、かなり大量の仮定が作られている[@Cook1982]。

- アンビエント光は一様に入射する。すなわち、入射する放射輝度はすべての方向で同じになる($L_i$は定数)。
- アンビエント光は見ている角度に依存しない。すなわち、反射した光の比はすべての方向で同じになる($f$は定数であり、その表面は*ランバート[Lambertian]*である)。

合わせて、これらの近似はアンビエント光のより単純なモデルをもたらす。

$$
L_{oa} = f L_{ia} \int (n \cdot \omega) d\omega
$$ {#eq:2.2}

[@eq:2.2]の積分は$\boldsymbol{p}$における半球の可視性であり、まずは以下のように書き表すとする。

$$
A(\boldsymbol{p}) = \frac{1}{\pi} \int (n \cdot \omega) d\omega
$$ {#eq:2.3}

ここで、$\boldsymbol{p}$は照らされている点であり、$n$は$\boldsymbol{p}$における表面の法線であり、$\omega$は積分の方向である。この積分は$\boldsymbol{p}$と$n$によって定義される半球の*遮蔽されていない[unoccluded]*部分に対してである。内積$n \cdot \omega$はこの文脈においてその意味が変化し、浅い角度でのオクルーダーが大きな範囲に投影されるという事実を考慮するために可視性を調整する。

$A$はアンビエント光のオクルージョンを計算に入れる。古典的な単純化では積分計算を回避するために$A=1$を用いる。モダンな実装では[@eq:2.3]によるオリジナルの定義を用いて、$\boldsymbol{p}$から可視である方向に入射するアンビエント光$L_{ia}$を制限する。

### 半球の定義 {#sec:2.2.1}

関数$V(\boldsymbol{p}, \omega)$を方向$\omega$における$\boldsymbol{p}$からのレイの*可視性[visibility]*とすると、$V$は以下のように定義される。

$$
V(\boldsymbol{p}, \omega) = \begin{cases}
0 & \text{方向} \omega \text{における} \boldsymbol{p} \text{からのレイがなにかに当たる場合} \\
1 & \text{その他}
\end{cases}
$$

すると、半球全体で計算するために$A$を拡張できる。その新しい積分は以下となる。

$$
AO(\boldsymbol{p}) = \frac{1}{\pi} \int_{\Omega} V(\boldsymbol{p}, \omega) (n \cdot \omega) d\omega
$$ {#eq:2.4}

ここで、$\Omega$は$\boldsymbol{p}$と$\omega$によって定義される半球である。アンビエントオクルージョン(AO)[@Landis2002]という用語は基本の式の長らく後に新造された。離散的な方向数をテコ入れすることでレイトレーサーでのモンテカルロ積分によって定めることができる[@Landis2002]。

$$
AO \approx \frac{1}{N} \sum_{n=1}^{N} V \cdot (n \cdot \omega_n)
$$

ここで、$N$は調査用[probe]のレイの数であり、$\omega_n$は各$n$に対して一様に無作為に選ばれた方向である。

## Ambient Obscurance {#sec:2.3}

開口部が小さくて抜け出せるレイが極わずかである、すなわち、ほとんどの部分で$V$が0となる場合、[@eq:2.4]で与えられるようなAOの式でレンダリングすると、ほぼ識別不可能なほどに暗くなる。これは望ましくなく、我々は見た目に満足な結果をもたらすAOのさらに実践的な定義を必要とする。

Ambient Obscurance[@Zhukov1998]は可視性の関数$V$を距離$d$に基づく減衰(フォールオフ)関数$\rho(d)$で置き換える。関数$\rho$は経験的に選ばれるが、以下のような一般的な特性を持つ必要がある。

- $\rho$は$d$の単調増加関数である。
- $d > d_{max}$に対する$\rho(d) =1$となるような上限$d_{max}$が存在する。

$\rho$によるアイデアは遠くのオクルーダーが受ける影響を少なく、または、一切なくすることにある。これは結果の画像を一般に明るくし、見た目に満足な結果を生み出す。$\rho$は物理ベースではなく、審美眼に基づいて完全に選択されることに注意すべきである。Ambient Obscuranceの定義はすでに見てきたものと似ている。

$$
AO^{* }(\boldsymbol{p}) = \frac{1}{\pi} \int_{\Omega} \rho(|\boldsymbol{p}\omega - \boldsymbol{p}|)(n \cdot \omega) d\omega
$$ {#eq:2.5}

ここで、$|\boldsymbol{p}\omega-\boldsymbol{p}|$は$\boldsymbol{p}$から調査用レイにヒットした最初の表面への距離である。

$V$は本当に単に$d_{max}=\infty$での$\rho$の特殊なケースであることに注意する。

## Inversion {#sec:2.4.1}

$AO$関数はアンビエントの*遮蔽[occlusion]*を示そうとしているにも関わらず、*可視性*によって増加する($AO=1$で完全に可視であることを示す)。そのため、著者によっては以下のように定義を反転するのを好む場合がある。

$$
AO = 1 - \int \dots
$$

これは多かれ少なかれ好みの問題であり、このレポートでは、各手法で与えられる定義を用いる。

## リアルタイムレンダリング {#sec:2.5}

### 変換、空間、座標 {#sec:2.5.1}

### ディファードレンダリング {#sec:2.5.2}

### シェーダ {#sec:2.5.3}

# 解析 {#sec:3}

## レイトレーシングとラスタライゼーション {#sec:3.1}

歴史的に、AOはレイトレーサーのために用意された機能であったが、レイトレーサーはGPUが活用するラスタライゼーションアプローチと互換性がないため、大きな商業基盤におけるインタラクティブなリアルタイムレンダリングでは用いられていない。

## 以前の研究 {#sec:3.2}

### ディスクプロキシ {#sec:3.2.1}

このアルゴリズムはディスク要素に分解されたシーンのすべてのポリゴンメッシュを入力として必要とする。そのアイデアはシーン中のジオメトリを遮蔽するディスク数を確認することにある[@Pharr2005]。これが初めて提案されたAO実装に対するレイトレーシングの代替案であり、後に、結果を平滑化することで改良された[@Nguyen2007]。

### アンシャープマスキング {#sec:3.2.2}

[@Luft2006]

### 最初のスクリーンスペースアプローチ {#sec:3.2.3}

#### シーン近似としての深度バッファ

深度バッファは、元々の目的を越えて、シーンの粗い表現として働くことも可能である[@Mittring2007a; @Shanmugam2007]。

#### 拡張されたパイプライン

AOは入力に深度バッファのみを用いるため、同じく入力に深度バッファを用いるシェーディングパスでAOを計算させることができるが、低解像度で計算したりパフォーマンス特徴の割り出しがし易かったりするので、専用のAOパスで計算したほうが良い。

#### スクリーンスペース積分

シーンを深度バッファで表現することで、[@eq:2.5]の積分を解くいくつかの興味深いアプローチが可能となる。

方法のひとつは標本点[sample point]近くでの遮蔽と可視の比で$AO$を近似することである[@Mittring2007a; @Mittring2007b; @Dachsbacher2009]。

$$
AO \approx \frac{1}{N} \sum_{n=1}^{N} V'(s_n)
$$ {#eq:3.1}

ここで、$N$は標本点の数であり、$s_n$は$n$番目の標本点であり、$V'$は$s_n$が可視であれば$1$、そうでなければ$0$である。$s_n$の標本点は半径$r$を持つ$\boldsymbol{p}$周辺の球に拡散される。

現在の点$\boldsymbol{p}$は始めに再構築されなければならず、計算コストが低いスクリーン座標で$\boldsymbol{p}$を再構築するアプローチが選ばれる。$\boldsymbol{p}_{xy}$は現在のピクセル座標であり、$\boldsymbol{p}_z$は深度バッファから直接読み出すことができる。$\boldsymbol{p}$が定まれば、周囲の球に標本点を選ぶことは自明となるはずである。しかし、手法の著者が記す通り、これはアーティファクトの源となり得る。

標本の位置$\boldsymbol{s}$は$\boldsymbol{p}$と同様にスクリーン座標上にあり、関連する$\boldsymbol{s}_z$の座標を持つ。$\boldsymbol{s}$の上にある表面の深度は$\boldsymbol{s}_d = \text{depth}(\boldsymbol{s}_{xy})$として深度バッファから読み出すことができる。後は単純な比較を行うだけで可視性が定まる。

$$
V'(\boldsymbol{s}) = \begin{cases}
1 & \boldsymbol{s}_d > \boldsymbol{s}_z \\
0 & \text{その他}
\end{cases}
$$

この手法([@eq:3.1])は元の式([@eq:2.5])にあるような半球ではなく、$\boldsymbol{p}$の周囲の球の中でサンプルすることにも注意する。すなわち、平坦な表面に対してでさえ、サンプルの半分が遮蔽されることを期待しなければならない。

理論上よろしくても、標本分布の問題が残っている。標本位置が$\boldsymbol{p}$ごとに固定される場合、結果のAOはバンディングアーティファクトを持つだろうから、代わりに、標本位置を一様に無作為に分布させる。これはバンディングアーティファクトを除去するが、高周波ノイズを引き起こす。著者らはAO計算上でジオメトリ対応[geometry-aware]のブラーを適用することでノイズを回避する。残念ながら、GPUの特徴により、ブラーはそれ自身のシェーダパスで行われなければならない。もうひとつの障害はシェーダプログラムが乱数をを生成できないことであるため、代わりに、事前に計算した乱数のバッファをAOシェーダに供給する。

#### バリエーション

以下に概略される差異を持つ前述の手法のバリエーション[@Filion2008]が存在する。

標本位置はワールド座標で探し、深度比較のためにスクリーン座標へ投影される。著者らは、単純な比較関数$V'$を前に使っていたが、減衰関数$\rho$も再導入している。これは高い$\boldsymbol{s}_d$の値を持つ前面のオブジェクトに起因する過剰な遮蔽[over-occlusion]を軽減する。前述の通り、標本の半分はデフォルトで遮蔽されていると扱われるので、代替アプローチではまず球の中の標本を探すが、表面の法線$n$に従って半球にこれらをflip backする。事実上、サンプルの半数がこのアプローチでは必要になる。

#### 球プロキシ

スクリーンスペースで動作し、多くの特性を共有する、[@Mittring2007a]と同時期に独立して開発された手法は、球プロキシで表現される表面近くの遮蔽を平均することで$AO$を近似する[@Shanmugam2007]。この手法は、[@Mittring2007a]と同様に、スクリーン座標で$\boldsymbol{p}$を再構築し、同様にスクリーン座標で$\boldsymbol{p}$の周りの*ディスク*内の$N$ケのサンプル$s_n$を分布させる。これは、その類似性がstopであった場合、各サンプル$s$が$s_z = s_d$で表面に投影されるので、ワールド座標への変換に従う。球は近くの表面を近似することを意図している各ワールド空間$s$に位置する。球の半径は$s_d$の関数である。$AO$は球が$p$で半球を遮蔽するサンプル数の合計として近似される。これは単に[@Mittring2007a]に見られる$V'$のような比較関数ではないことに注意する。

上記で述べられる手法は非常に込み入っており、他の提案と比較して非常に異なって$AO$の近似に取り掛かる。

### A Horizon-Based Approach {#sec:3.2.4}

TODO
