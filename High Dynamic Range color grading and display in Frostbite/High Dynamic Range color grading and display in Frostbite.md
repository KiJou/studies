---
bibliography: 'Color Grading.bib'
citation-style: 'authoryear.csl'
reference-section-title: '参考文献'
---
## High Dynamic Range color grading and display in Frostbite {ignore=true}

[TOC]

### 昔話 [@Fry2017]

- フィルム密度(film density)によって光に対する応答が異なっていた。
    - [Fundamentals of Film Exposure -- Olympus Microscopy Resource Center](http://www.olympusmicro.com/primer/photomicrography/filmexposure.html)を参考。
- フィルムの特性が描くカーブは3つのセクションに分けられる。
    - 中間部(Mid section): ほぼ線形
    - Toe(つま先): 反応がにぶる
    - Shoulder(肩): 反応がにぶる
- カーブを非線形にすることで、全体として光の値を広い範囲で捉えることができる。
    - ToeとShoulderの範囲を縮小する。
    - 中間部に合わせてシーンを露出する。

#### 昔のテレビと標準規格 [@Fry2017]

- 昔のテレビやCRTモニタは0.1nitsから100nitsまで。
    - $[\text{nits}] = [\text{cd}/m^2]$
- 電気的な入力に対して非線形な応答を持つ。
    - 電気光学伝達関数(Electro Optical Transfer Function; EOTF)
    - いわゆる"ガンマカーブ"
- sRGB/BT.1886が標準に導入される。
    - ディスプレイの表示能力(capability)そのまま。
    - こんにちではよく使われている。

#### 今のテレビと標準規格 [@Fry2017]

- 今のテレビは0.01nitsから300nits超。HDR的なことまでできる。
    - ハードウェアは標準規格以上の能力がある。
    - LCDの応答はCRTとは違う。
- sRGB/709を未だに使っている。
    - テレビは0.1nitsから100nitsまでの信号を加工してそれっぽく見せている。
    - キャリブレーション以外では特に制御する術はない。
    - 最終的にコントラストが強めに出る傾向がある。
- 輝度についても、同じように上限方向に飽和している。(例えば、店頭デモモード)

### トーンマッピング(Tonemapping) [@Fry2017]

- 最終的な出力先はディスプレイであるため、そこで表現できる色空間に合わせて値の範囲を縮小しなければならない。
- トーンマッピングは、大事なディテールを維持しつつ、広いダイナミックレンジを狭いダイナミックレンジに対応させる処理のこと。
    - FP16をRGB8に変換する。
    - シーンの注目している地点を、中間トーン(mid tones)に合わせて露出する。
    - フィルムの特性を模倣する。

#### トーンマッパー(Tonemapper)の例 [@Fry2017]

- シンプルなヤツ: 影響の度合いは、最明部が最も大きく、最暗部が最も少ない。
    - [@Reinhard2002]
    - 指数関数
- フィルム的(filmic)なヤツ: コントラストの変化に応じてToeとShoulderが程よく変化する。
    - Hejl and Burgess-Dawson [@Duiker2010]
    - [@Hable2010]

実装は[Filmic Tonemapping Operators -- Filmic Worlds](http://filmicworlds.com/blog/filmic-tonemapping-operators)を参照。

### カラーグレーディング(Color grading) [@Fry2017]

- カラーグレーディングとは、シーンに特徴的な見た目を適用すること。
- その始まりは映画産業で、見た目を変えるために使うフィルムを選んだり、現像工程を変化させたりすることを呼んだ。
    - 例えば、銀残し(bleach bypass)など。
- CGではさらに多くのことができる。
    - ホワイトバランスや露出の調整。
    - 色やハイライトの置き換え。
    - Orange & Teal (肌の補色による色味戦略。参考:[raitank blog](http://www.raitank.jp/archives/1419))
    - "Fix it in post" (= 撮影後に行う修正。参考:[BornDigital](https://www.borndigital.co.jp/book/300.html))

### Frostbiteにおける以前のグレーディングパイプライン [@Fry2017]

1. ポストプロセス
    - ここまでFP16の線形空間。
    - ブルーム、モーションブラー、Vignette(ビネット効果。参考:[UnrealEngine Docs](https://docs.unrealengine.com/latest/JPN/Engine/Rendering/PostProcessEffects/Vignette/index.html))、被写界深度、など。
1. トーンマッピング
    - ビルトインしたアルゴリズムからアーティストが使うものを選ぶ。
    - 大抵はフィルム的トーンマップ。
    - トーンマップはRGB各個に一次元のカーブとして与えられる。
1. sRGBに変換
1. カラーグレーディング
    - オフラインで生成した三次元LUTを使う。
        - フォトショップでスクリーンショットを読み込む。
        - 32x32x32の独自性を表すカラーキューブレイヤを読み込む。
        - 見た目変換を適用する。
        - カラーキューブLUTを保存する。

1. UIを描画
1. ディスプレイに表示

#### 問題 [@Fry2017]

- トーンマッピング
    - RGB個別の一次元カーブだと色相シフトが起こる。
        - 中間部が完全な線形にならない。
        - チャネルが切り取られるように、ハイライトがシフトする。
    - トーンマッピングは"見た目"を適用する。
        - "見た目"の選択はグレーディングとは別のワークフローになっている。
    - 新しいトーンマップを作りづらい。
        - トーンマップは選ぶだけでデータ駆動ではない。
- sRGBとグレーディング
    - photoshopは実際にはグレーディングの範疇ではない。
    - LUTはたいてい8ビット。
        - 取り返しのつかない(irrecoverable)量子化が行われる。
        - マッハバンドや色相シフトが起こる。
    - sRGB変換が前にあるので、1以上の値を取り扱えない。
- トーンマッピングからグレーディングまで
    - トーンマップ + sRGB = LUT分布関数
        - 分布関数はグレーディングに最適ではない。
        - トーンマップに依存して異なる分布が現れる。
        - 異なるトーンマップを使っていたら、他のチームとLUTを共有できない。
- ディスプレイ表示
    - SDRにハードコートされている。
    - より多いビット数の、より大きいダイナミックレンジの、より広い色空間の、HDRディスプレイに対応したい。
    - クリエイターがこれらすべてを制御できる方法を提供したい。
        - テレビの製造業者由来ではなく、クリエイティブな制御ができるように。

### HDRディスプレイ対応 [@Fry2017]

#### 単純なアプローチ [@Fry2017]

- SDRの最終的な色情報を逆トーンマッピングして、もとのHDRデータを抽出する。
    - Shoulderをもとに戻すにはどうすれば。
- 制約の数々。
    - 逆を求めるには、8ビットだと精度が足りない。
    - トーンマップが複数あれば、その分だけ逆を求める必要がある。
    - 限定された範囲なら復元できる。
    - 処理順が正確でない。
        - グレーディングとUIがトーンマッピングの後に描かれている。
        - 後段で逆トーンマップを求めるとき、これらが不正確に反転されてしまう。
- さらなる改善案。
    - トーンマップカーブ(LUT分布関数)を調整する。
        - より広い範囲をキャプチャする。
        - 解析的な逆マッピングを計算する。
    - レンダターゲットとグレーディングを10ビットにする。
    - マイルドな色を使うようチームに頼んでみる。
    - Shoulderの範囲を使わないようにUIをスケールする。

#### Frostbiteのアプローチ [@Fry2017]

- HDRからLUT空間へ変換する。
- LUT空間でグレーディングする。
- UIはオフスクリーン(バッファに直接)描画する。
    - 前乗算アルファ(premultiplied alpha)は必須。
- HDRにデコード、UIを合成、トーンマッピングして、ディスプレイに合わせてエンコードする。

- "見た目"のワークフローをすべて一箇所に移動する。
- グレーディングは出力先を考慮せずにマスター空間で1回のみ行う。
- UIは見た目が異なるので別に処理する。
- 現在のHDR規格は現行のディスプレイ性能より広い範囲をカバーするので、規格に従えば将来の高性能ディスプレイならよりよく見えるようになるかも。

##### HDRグレーディング

- HDRフレンドリーな分布関数を用いる。
    - 色々(log, S-Log, LogC)試したけど、結局はST.2084かPQ(Perceptual Quantiser)を使うことにした。(参考:[Phileweb](http://www.phileweb.com/review/article/201503/17/1558.html))
    - PQはLUTが知覚的な空間化がなされるので、うまく制御できる。
- 33x33x33のLUTルックアップを行う。ランタイムだと10ビットUNORM。
    - 業界標準(industry standard)サイズを使うので、標準のグレーディングツールが使える。
- 単一の分布関数を用いることで、誰でもLUTを作って共有できるので、ライブラリ化できる。

- 業界標準のグレーディングツールであるDaVinci Resolveを使って作る。
- なぜエンジンには組み込まなかった？
    - 車輪の再発明とその後のメンテナンスをしている時間や必要性、要望がなかった。
    - 熟練のグレーダーとの摩擦を減らしたかった。
    - Resolveのフリー版でも十分なことができた。
- "Resolve Live"は多大なワークフロー改善をもたらした。
    - キャプチャ/モニタカードを買う必要がある。

##### ディスプレイマッピング

- The HDR version of the game is the reference version
- トーンマッピングはパイプラインの最後にした。
- トーンマッピングは接続しているディスプレイに応じて異なる。
    - SDRでは、アグレッシブなトーンマッピング。
    - HDRでは、アグレッシブさは抑えめだが、ディスプレイによって変わる。
    - Dolby Visionでは、トーンマッピングしない。
    - 個別のケースに合わせて微妙に異なるバージョンのものを使う。
    - カーブだけでなく、露出にも。
- ディスプレイマッピングと呼ぶことにした。

- ディスプレイマッピングの主なチャレンジ。
    - 広範囲のデバイスに渡ってスケールする。
    - ディスプレイに関係なく似た見た目を達成する。
- 欲しい性質
    - Toeなし。
    - コントラスト変化なし。
    - 色相シフトなし。
    - No built in film look(フィルムルックを組み込まない[?]
- できるだけ中立に作る。

- どうやって？
    - RGBではなく輝度(luma)/彩度(chroma)でやる。
        - Shoulderには輝度のみを適用する。
        - Shoulderに依存して彩度を漸次的に(progressively)脱飽和する(desaturate)。
    - DolbyがHDR用に開発した、ICtCp空間を使う。
        - Chroma follows lines perceptually constant hue
    - 画像/ゲームの多くでは目視で調整される。
        - ぜんぜんPBRじゃないけど、これは数学ではなくて知覚についてなので。

##### 万事OK...じゃない

- SDRの性能は0.1-100nitsだが、ディスプレイはその性能に合わせて200から400nitsまで上限を拡大する。
- HDRは100nitsは100nitsなので、比較すると暗く写ってしまう。
- HDRをリファレンスとして、SDRの露出を調整した。
    - SDRディスプレイマッパーは過小露出する。

アーティストはSDRのピーク値を設定できる。
ユーザがこの値を調整していることも考えて、デフォルトではSDRディスプレイは200nitsだと仮定する。

- 既存のアセットで色相シフトを活用したものがあれば直さなければならない。

##### VFXの再制作

- 炎のエフェクトが変化するのがもっともよくあった苦情(complaint)だった。
    - VFXは前のトーンマッパーで起こるクリッピングによる色相シフトをを使って作られていた。
    - SDRではよく見えても、HDRになると駄目だった。
- 黒体シミュレーション(温度による色相変化をカラールックアップにする方法)を使う。
    - エフェクトを温度として作る。
    - 黒体放射からカラーランプを作る。
    - 温度でランプを指す。
    - ちょうどいいようにランプを調整する。

##### こんどこそOK...じゃない

TODO

### 参考文献
