---
title: Advanced Lighting R&D at Ready At Dawn Studios [@Neubelt2015]
numberSections: false
---
# 焼き込み式大域照明[Baked Global Illumination]

- 目標
    - 高品質な静的GI
    - 焼き込まれた環境
    - 焼き込まれたキャラクターライティング
    - ディフューズとスペキュラ

The Order: 1886は屋内と屋外の両方の中くらいの大きさのレベルを持つリニアなゲームである。このゲームはそのライティング的にかなり静的であり、我々のプロジェクトに対して静的に焼き込まれたGIソリューションを使うのに最も理に適っている。

ディフューズライティングだけでなくスペキュラGIも同様にキャプチャするのが重要である。焼き込まれたスペキュラを強く推し進める多くの理由のひとつはキューブマップを用いることで発生する制限である(間違った場所と角度の品質で間違った反射を空間的に取得する)。

# 沢山の解決法を試した[Tried Many Solutions]

- 焼き込まれたAO
- SG(5, 6, 9, 12)
- SH(4, 9)
- 方向性ディフューズ
- PRT
- 方向性AO
- RGBディフューズ
- 透視投影補正キューブマップ
- H-Basis4/6
- H-Basis AO

我々は開発中に多くのテクニックを試したが、これらの中に我々のニーズにピタリと一致するものはなかった。いくつかのテクニックは小道具用のスペキュラおよびディフューズオクルージョンのためのH-Basis AOのような出荷する製品に残ったままになっている。

しかしながら、最終的には球面ガウス[Spherical Gaussians]を用いることになり、これに決定した理由を手短に見ていこうと思う。

# 球面調和ディフューズ[Spherical Harmonics Diffuse]

- 良い場合: 低い周波数の信号
- 悪い場合: 高い強度、方向性のライティング

注意: 信号をブラーするコストでリンギング[ringing]を減らすために窓関数を適用できる。

HDRライティングは、高い正の係数を打ち消すような非常に大きな負数になる、とあるローブを引き起こす可能性がある。これは品質や圧縮に悪影響である。

# 球面調和リンギング[Spherical Harmonics Ringing]

リンギングは我々のゲーム中には、ライティングコストを抑えるために直接光を焼き込むときに現れる。これはキャラクターを死んだ/ゾンビのような見た目にしてしまう。リンギングはライティングを、例えば前頭部では行き過ぎに、光の当たらない側では暗すぎにしてしまう。

# 球面調和スペキュラ[Spherical Harmonics Specular]

- 高周波データには大量の係数が必要
- 評価が高価
    - テクスチャルックアップ
    - SHの回転
    - 評価

我々はBungieが実装した球面調和スペキュラを試した。ルックアップ、SH回転、BRDF評価の組み合わせにより少々高価すぎた。

<!-- p.8 -->

- SH9は艶消し[matte]のように見える。

9つの係数のみではマットなルックになる。係数が16つあれば十分良好だが、そのコストは間違いなく当時では高価すぎていた。

# キューブマップスペキュラ[Cubemap Specular]

- 非局所的なサンプリングアーティファクト
<!--  -->
- ライティング信号とBRDFにより近く合致する。
- 非局所的
    - AABBの透視投影の歪み[perspective warping]を実装した。
    - 未だ完璧ではなく、正方形でない部屋を作る[author]のが難しい。
- 輝く[glowing]エッジを引き起こす。
    - オクルージョンの欠落

<!-- p.10 -->

- 局所化とオクルージョンの問題

左のスクリーンショットは我々のゲームではとても一般的な問題である。誤ったスペキュラプロブの捕捉[grabbing]は暗い所やエネルギー不足の所で輝くエッジを引き起こすだろう。

方向性オクルージョンをH-Basisに焼き込み、アーティストに距離を指定させようと試みたが、これは難しく、間違いを起こしがちであった。また、キューブマップが誤った位置にあるために、スペキュラが欲しいときに役に立たなかったり、そもそも得られなかったりもした。アーティストはキューブマップの配置の調整に多くの時間を費やした。

# 球面ガウス基底[Spherical Gaussian Basis]

ここには3つの主なテクニックの比較がある。球面ガウスでは、ハイライトの幅がパストレースの解に最も近く一致することに注目する。

# 球面ガウスGI[Spherical Gaussian GI]

# キューブマップとSH9[Cubemap and SH9]

これはキューブマップでの焼き込まれたディフューズライティングを示す古いスクリーンショットである。そのエネルギーは平坦に見え、床は得るべきでないところまでエネルギーを得ている。

# 球面ガウシアン[Spherical Gaussians]

この例では、球面ガウシアンを用いて焼きこまれている。光や影があるべきところにあることに注目する。このシーンは、シャドウとハイライトが混ざっているので、より興味深いものになっているように見える。

# スペキュラの焼き込み[Baking Specular]

このシーンでは、球面ガウシアンライティングを無効化した。

<!-- p.24 -->

- 複数の光源が適切にライトマップにキャプチャされる。
- キューブマップによるエイリアシングがない(追加のおまけ)。

再び有効化するときは、ライト周りのホットスポットに注目する。各光源の周りに多くのキューブマップを配置する必要があるので、この種のライティングをキューブマップでキャプチャするのは非常に困難だろう。

<!-- p.25 -->

このシーンは非常に暗い --- 多くのスペキュラを付け損なっている。この例では、アーティストはキューブマップを十分に持っていなかった。なので、このエリアにひとつでもキューブマップを置けば、おそらく多少は良くなっただろう。しかし、このレベルではメモリの制約によりそれをしなかった。このレベルはとても大きく、膨大な量のゲームプレイエリアがあったので、すべてのスポットで十分なキューブマップを得ることは実行可能な選択肢ではなかった。

<!-- p.26 -->

- 引き伸ばされた[stretched]ハイライト
    - キューブマップは等方的なPhongハイライトのみを持つ。
    - SGは長く引き伸ばされたハイライトを持つことができる。

有効化すると、このエリアのSGのエネルギーが戻ってきて、金属の梁に引き伸ばされたハイライトを得ることに注目する。キューブマップが円形ハイライトのみをサポートするのに対し、球面ガウシアンは細長い[elongated]ハイライトを可能にするBRDFに対する半角パラメータ化を用いる。

<!-- p.28 -->

この例では、2箇所が確認できる。床と木のパネルで細長いハイライトが確認できる。このエリアでキューブマップのみを用いていた場合にはジオメトリのすべてが明るく輝いていたであろう複雑なジオメトリにも気付く。

# 基本的な数学的特性[Basic Mathematical Properties]

# 球面ガウシアン[Spherical Gaussians]

$$
Ae^{\frac{1}{W}(M \cdot x - 1)}
$$

- $A$: 縦幅[amplitude]
- $W$: 横幅[Width]
- $M$: 平均[Mean]

私見では、SGは、直観的なパラメータを持つので、理解しやすい方である。

これらは等方的なので、2Dでグラフ化できる。この可視化では、真ん中で輪切りにして、X軸を平均からの角度で表している。

これは平均からの測地的な距離に基づいて減少[falloff]する関数のような指数関数的ガウシアンである。

<!-- p.31 -->

- 平均は指す方向を制御する。
- 横幅はフォールオフを制御する。
- 縦幅は高さ又は強度を制御する。

<!-- p.32 -->

平均は単純な正規化済み方向ベクトルである。望みの方向に回転するのは容易い。

<!-- p.33 -->

横幅パラメータ、または、たまにフォールオフ、周波数[frequency]、逆幅[inverse width]と呼ばれるそれは、関数がどれだけ素早く平均から減少するかを制御する。

横幅パラメータを変更すると、関数が持つエネルギーの総量を変更する。

<!-- p.34 -->

縦幅は高さを制御する。これは線形な応答を持つので、より直観的なパラメータのひとつである。例えば、関数に2をかければ、平均方向で高さが2倍になる。

しかし、高さを変更すると、関数の総エネルギー量を変更することにも注意する。故に、振幅と周波数は関数の総エネルギー量に対して結びつけられる。

<!-- p.35 -->

- SG *(演算子)* SG = SG (閉じた演算子)
    - 回転は単純な3Dベクトルの回転である。
    - 閉形式の積分
        - 畳み込み、内積
    - 閉形式の積[product]
        - 二重積[double product?]、三重積[triple product]、など

SGの実際の力はどれだけの演算と閉形式の演算をサポートするかによる。ほとんどの演算は別のSGを生成するので、多くの単純なものをつなぎ合わせ、単一のSGを得ることができる。

これはレンダリング方程式のような複雑な数式を取り、解析的に評価できるようにする。

<!-- p.36 -->

- 複雑な信号を表現するために足し合わせることができる。

SGで可能になるもうひとつの本当に興味深い演算はそれらを足し合わせることである。

左に青い壁、赤い天井、右に緑の壁のある部屋があると想像しよう。上記の図のにあるようなSGで各方向からの放射輝度を表すことができる場合、右の関数を得るために足し合わせることができる。

右の関数のサンプリングを単純化すると、その方向での放射輝度を得るだろう。

<!-- p.37 -->

- エリアライトを表現できる。

SGはエリアライトを表現できる。

<!-- p.38 -->

- …それと、様々なBRDF。

SGはBRDFを表現できる。

# SGライトマップ[SG Lightmaps]

# ライトマップデータ[Light Map Data]

- 5、6、9、12のRGBの **非負** のHDR係数
    - 係数の数は任意
    - SH4/H-Basis4を置き換えるために4を使うことができる。
- 色データのみを含む。
- BC6で圧縮されたライトマップ
- 平均方向と横幅はシェーダにハードコートされた定数である。

ライトマップに格納されるデータはHDRのRGB色のみである。持つローブの数は持つライトマップの数を指示[dictate]する。アーティストがこの概念を理解するのはとても簡単で直観的である。ライトマップはローブ方向での放射輝度を表すので、SHとは異なり各ライトマップでどうなっているかを詳しく調べ[inspect]、理解することは非常に容易である。

係数は圧縮や精度の助けになる正の値のみである。

方向と横幅はライトマップには格納されない。

# SGの焼き込まれたライティング[SG Baked Lighting]

- 各ライトマップのテクセルに焼き込まれたSGの合計として放射輝度を表現する。

ここにはライトマップの各テクセルでの球面ガウシアンの可視化がある。各半球はSGの数の合計である。見ての通り、図中の球は、右の赤の壁、上部の空、カメラや床の背後の緑の壁から来るの放射輝度を示す。

# 固定の方向[Fixed Directions]

- 球上で均等に分けた方向の固定のセット
- 5、6、9、12
- 黄金比の螺旋を用いる。

ローブ数に基づいて、黄金比の螺旋のアルゴリズムを用いて方向の一様分布を生成する。

# 固定の横幅[Fixed Widths]

- 横幅
    - 小さすぎる == 乖離
    - 大きすぎる == 過剰ブラー
    - 丁度いい

横幅は、連続的で、乖離がなく、信号を過剰にブラーするほど広すぎたりしないように、解決する必要がある。

# なぜ固定の基底か？[Why Fixed Basis?]

- 可変のスカラの数
    - 27つの色用スカラ (9 * 3)
    - 9つの横幅
    - 18つの方向用スカラ ($\theta$/$\phi$)
    - == 54
- 固定のスカラの数
    - == 27
- 固定の利点
    - 同じデータ量で2倍多い方向
    - より多い最適化の機会
    - 隣接テクセル間の補間問題がない

# SGを伴うライティング[Lighting with SGs]

- 基本のアイデア
    - SGの合計として放射輝度を表現する。
    - ひとつのSGとしてBRDFを表現する。

SGの合計として放射輝度を、ひとつのSGとしてBRDFを表現できるならば、ライティングを得るためにSGの解析的な積分演算を用いることができる。これが基本のアイデアである。

# SGの焼き込まれたライティング[SG Baked Lighting]

- 実際の実装はもっと複雑である。
    - Fresnel
    - シャドウイング
    - マスキング
    - NDFの歪曲[warping]
        - NDF SGは半角でパラメータ化される。
        - 放射輝度SGはライト方向でパラメータ化される。
        - 効率的なSGの乗算のために同じ空間にある必要がある。

<!-- p.47 -->

- NDF近似
    - Beckmann = 1つのSG
    - GGX      = 3つのSG

BeckmannのNDFの近似は1つのSGだけで極めて正確に行うことができる。GGXのBRDFは良好な長いテール[wide tail]を得るために3つのSGを必要とする。

1。しかし、アンビエントライティングでは、GGXローブのテールはパンクチュアルな光源では言うほど目立たない。なので、このスライドのようにひどくはならない。

# SGを伴うライティング[Lighting with SGs]

- NDF * 放射輝度 (不可能: 空間が異なる！)
    - NDF    = 半角空間
    - 放射輝度 = 正接空間

残念ながら、SGへの入力パラメータが異なる空間にあるため、放射輝度とNDFを解析的に積分できない。ライティング方向で積分する場合、NDFではそのライティング方向を半角方向に変換しなければならない。主なアイデアは、同じ方向を指し、その空間でNDFを最も良く表す他のSGを生成する。

このアイデアではまず、ライト方向の方向を指すようにNDFを回転する。そして、NDFのエネルギーを最も良く表すように横幅を修正する。しかし、SGは対称的に横幅を修正することしかできないが、半角パラメータ化により、他よりもある方向に実際にスケールする。このため、SGをASG(非対称球面ガウシアン)に昇格させる。これは2つの方向で個別に伸縮[stretch]することができるようになる。

<!-- p.49 -->

ここでは、対称SGの歪みと非対称SGの歪み、対、パストレースの結果の例である。

<!-- p.50 -->

- ライティング方程式

$$
\int Masking * Fresnel * Shadowing * WarpedNDF * Radiance * d\omega
$$

これはライティング方程式が球上の関数をレンダリングすることのように見えるものである。

歪んだNDFはASGとして表現される。
放射輝度はSGの合計として表現される。
Fresnel、シャドウイング、マスキング関数はグラフィクスで使う典型的な関数である。Fresnel関数とシャドウイング関数はその領域上で非常に滑らかな関数であることに注目する。

マスキング関数は、ビュー方向でパラメータ化される一方、ライティング方向の領域上で積分しているので、積分に関する定数の関数である。

<!-- p.51 -->

- ライティング方程式

$$
Masking * \int \underbrace{Fresnel * Shadowing}_{解析的な積分なし} * \underbrace{WarpedNDF * Radiance}_{解析的な積分あり} * d\omega
$$

我々が行える最初のことは、マスキング関数が積分に関して定数なので、外に出すことである。

<!-- p.52 -->

- ライティング方程式

$$
\underbrace{Masking * Fresnel * Shadowing}_{積の評価} * \int \underbrace{WarpedNDF * Radiance}_{解析的な積分} * d\omega
$$

そして、Fresnelとシャドウイングは非常に滑らかなので、外に出すことができる。これは、積分の平均値定理[mean value theorem]のため、かなり強烈な近似である。それが平均値[average value]となるので、良好な代表的な方向を選び取る必要がある。我々はFresnelやシャドウイングを評価するためにライト方向を選択する。

これはかなり強烈な近似であるが、もう少しランタイムコストを支払うことを気にしなければ、さらに高い正確さを得るために2つの区分的線型近似を行うことができる。

3つの項を外に出すと、これらの関数の積を取り、ASGとSGの解析的な積分で乗算することができるようになる。

<!-- p.53 -->

最終的なアンビエントライティングを評価するために、それぞれのFresnel項やシャドウイング項で乗算されたSGでASGの積分を要約する。そして、右にある最終結果を得るためにマスキング関数で乗算する。

# 鏡のようなマテリアル[Mirror-Like Materials]

- 基本のアイデア
    - 粗いマテリアル == SG
    - 光沢のあるマテリアル == キューブマップ
    - 中間 ~= lerp(SG, キューブマップ)

実践では
    テストシーンではあるところで最大0.2のラフネス
        ローブ数に依存する。
    アーティストはレベルごとに内外の特定のブレンドポイントを制御する。

# 球面ガウシアン/キューブマップブレンディングの可視化[Spherical Gaussians / Cube Map Blending Visualization]

<!-- p.56 -->

このシーンに対するブレンディング重みの特定の選択の可視化

# カスタムBRDFの扱い方[Handling Custom BRDFs]

- Beckmann/GGXはSGとしてうまく動作する。
- 布＆髪は表現できるが、より手間がかかる。
    - 参考文献を参照
- 時間がなかった。
    - SGのライトマップデータを点ライトとして扱い、布/髪をN回評価する。

注意: 空間的なエネルギー問題がキューブマップで悪化したので、単に好みでなかったこれらのBRDFを持つキューブマップに対してフォールバックがあった。

# ポストモーテムと今後のR&D[Post-Mortem and Future R&D]

# 振り返り[Looking Back]

- The Order: 1886は2015年2月に出荷した。
- いくつかの技術的選択がうまくいった！
    - マテリアルパイプライン
    - SG焼き込み
- 何か改善できることは？

2月にThe Orderの開発を終了してからは、我々の技術を精査するための時間であったので、強みと弱みを評価できた。いくつかのケースでは、このコースの2013年バージョンで示したマテリアルやシェーディングパイプラインのように、我々の選択が良好なランタイム結果と同様に効率的なアーティスト用オーサリングパイプラインの両方を生成する観点でうまく働いたことは目にも明らかであった。しかし、高品質なアセットを生成するのに必要な時間を少なくできたと思われるような改善の余地があると感じた場所も多くあった。


# R&Dの原則[R&D Principles]

- 現実世界のニーズに駆られる
    - 考えることだけがCOOLじゃない！^[誤訳?][Not just what we think is cool!]
- 厳しくせず、ゆとりを持とう
- デフォルトで物理ベース
    - もっともらしく、現実世界の値を規定値とする

この仕事を始めたとき、我々の目標は何であるか、そして、技術改善の価値のある候補がどれくらいあるかについて注意深く腰を据えて考えた。Daveと私は物理ベースレンダリング技術にかなり熱心[enthusiastic]で、より厳密に現実世界の振る舞いに基づいたモデルを持つことを目的に純粋に我々の技術を変更することについて夢中になることは容易い。可能性のある変更が単なる祭り[enthusiasm]ではなく実際の現実世界のニーズに駆り立てられているかどうかを考慮することが重要であると私は考える。これに関して、ソリューションを提案する前に制作中に遭遇した実際の問題からまず始めることを確認したかった。

似た話に、いかなる可能性のあるソリューションでもアーティストのワークフローの効率か品質のいずれかへの明白な利点となることを確認したかった。これは物理ベース的振る舞いを追従するという名目で単に恣意的にアーティストを制限する新しい技術を避けようとすることを望むことを暗黙的に意味する。

最後に、技術がアーティスト駆動のパラメータを必要とするたび、それらがデフォルトで物理的にもっともらしい結果を常に生成すべきであることを決めた。いくつかのケースでは、生来の制限及び/又は近似に対処するためにアーティストが物理法則を破ることができるようにする必要があるかもしれないが、これは明示的に起こるのみにするべきである。

# 基本のシーンパイプライン[Basic Scene Pipeline]

これはThe Orderで用いたレンダリングパイプラインの本当に基本的で高レベル視点である。左には、空、太陽、ローカルな照明器具[lighting fixtures]のような光源がある。これらの光源はシーンにライティングを放ち、中図においてマテリアルに反射する。この反射したライティングは入射するピクセルあたりの放射輝度をディスプレイ空間の最終出力に変換する露出/カメラシミュレーションステップを通過する。

これらのステップのうち、マテリアルのみが本当に物理ベースの原則に従っている。残りのこれらのステップはそうではなく、任意の単位と標準を用いていた。当然と言えば当然だが[somewhat unsurprisingly]、これらの赤のエリアはThe Orderの製作中で最も多くの問題に遭遇した箇所であった。

# ライティングの釣り合い取り[Balancing Lighting]

- 以下では物理原則なし
    - 空
    - 太陽
    - ローカルライト
    - 露出
- どう釣り合いを取るか？

我々の問題の基礎にあるテーマは様々な光源の釣り合いのとり方であった。現実的なシーンを望むなら、様々な光源が組み合わせるときに互いにすべての釣り合いを取ることが重要である。しかし、我々の場合、アーティストが光源を追加するときにこのバランスが正しくなることを保証するフールプルーフな方法をまったく持たなかったことが問題であった。

<!-- p.63 -->

- 様々なライティング条件で'atriums'を作った。
- ゲーム内露出値を標準化した。
- 光源をビジュアル的に釣り合い取りした。
    - AKA: 良くなるまで調整する。
- 我々のプロダクションセッションを参照

バランシングを扱う方法はライトの強度と様々なエミッシブ効果を特定するためのテスト環境を用いることだった。これらの環境のすべては、time of dayと同様に様々な気象条件を反映した太陽と空の要素を組み合わせた、同じアトリウムジオメトリを用いた。アーティストはこれらのアトリウムで標準化された露出値を選択した。これは一般的にニたインゲーム条件での基本の露出値として使われた。光源をバランシングするため、それらは単純にシーンに追加され、それらの強度はシーンの残りとビジュアル的に一貫性のあるようになるまで調整された。この処理は幾分かエラーになりやすく、同様に時間がかかった。

<!-- p.64 -->

- 良好な最終結果だが、それほど効率的ではない。
- 調整と問題の追跡に大幅な時間を要した。
- もっと簡単にできる？
    - そう思う:)

プロジェクトの後に得た考慮すべき意見[takeaway]は、我々の処理で説得力のあるビジュアルを作ることが間違いなく可能で、確実に取り得る限りで効率的であった。我々のパイプラインに更なる物理ベース原則を適用することは合理化[streamlined]されたワークフローになるのに役立つ可能性があると強く思っている[firmly believe]。

# The Orderでの空[Skies in The Order]

- 最初の試み: e-On SoftwareのVue
    - 完全にプロシージャルなスカイドーム
    - VFX界隈[industry]で使われる
- アーティストが使うのに苦労した。
    - 険しい[steep]学習曲線
    - 遅いレンダリング
    - 一般的にスペシャリストによって使われる
- 将来的に再検討する必要がある。


プロジェクトの初期では、HDRスカイドームをオーサリングするツールとしてE-On SoftwareのVueを評価した。これはとても強力な完全にプロシージャルなソリューションであるが、かなり厳しい学習曲線を持っている。このツールを用いるVFXスタジオでは、これらのシミュレーションで開示されるすべてのパラメータに精通する専属のVueアーティストがいるのが普通である。我々にはそのようなエキスパートはいないので、アーティストたちはよりローテクなソリューションを追求することに決めた。

<!-- p.66 -->

TODO
