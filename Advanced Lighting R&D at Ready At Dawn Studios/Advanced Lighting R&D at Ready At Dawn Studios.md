---
title: Advanced Lighting R&D at Ready At Dawn Studios [@Neubelt2015]
numberSections: false
---
# 焼き込み式大域照明[Baked Global Illumination]

- 目標
    - 高品質な静的GI
    - 焼き込まれた環境
    - 焼き込まれたキャラクターライティング
    - ディフューズとスペキュラ

The Order: 1886は屋内と屋外の両方の中くらいの大きさのレベルを持つリニアなゲームである。このゲームはそのライティング的にかなり静的であり、我々のプロジェクトに対して静的に焼き込まれたGIソリューションを使うのに最も理に適っている。

ディフューズライティングだけでなくスペキュラGIも同様にキャプチャするのが重要である。焼き込まれたスペキュラを強く推し進める多くの理由のひとつはキューブマップを用いることで発生する制限である(間違った場所と角度の品質で間違った反射を空間的に取得する)。

# 沢山の解決法を試した[Tried Many Solutions]

- 焼き込まれたAO
- SG(5, 6, 9, 12)
- SH(4, 9)
- 方向性ディフューズ
- PRT
- 方向性AO
- RGBディフューズ
- 透視投影補正キューブマップ
- H-Basis4/6
- H-Basis AO

我々は開発中に多くのテクニックを試したが、これらの中に我々のニーズにピタリと一致するものはなかった。いくつかのテクニックは小道具用のスペキュラおよびディフューズオクルージョンのためのH-Basis AOのような出荷する製品に残ったままになっている。

しかしながら、最終的には球面ガウス[Spherical Gaussians]を用いることになり、これに決定した理由を手短に見ていこうと思う。

# 球面調和ディフューズ[Spherical Harmonics Diffuse]

- 良い場合: 低い周波数の信号
- 悪い場合: 高い強度、方向性のライティング

注意: 信号をブラーするコストでリンギング[ringing]を減らすために窓関数を適用できる。

HDRライティングは、高い正の係数を打ち消すような非常に大きな負数になる、とあるローブを引き起こす可能性がある。これは品質や圧縮に悪影響である。

# 球面調和リンギング[Spherical Harmonics Ringing]

リンギングは我々のゲーム中には、ライティングコストを抑えるために直接光を焼き込むときに現れる。これはキャラクターを死んだ/ゾンビのような見た目にしてしまう。リンギングはライティングを、例えば前頭部では行き過ぎに、光の当たらない側では暗すぎにしてしまう。

# 球面調和スペキュラ[Spherical Harmonics Specular]

- 高周波データには大量の係数が必要
- 評価が高価
    - テクスチャルックアップ
    - SHの回転
    - 評価

我々はBungieが実装した球面調和スペキュラを試した。ルックアップ、SH回転、BRDF評価の組み合わせにより少々高価すぎた。

<!-- p.8 -->

- SH9は艶消し[matte]のように見える。

9つの係数のみではマットなルックになる。係数が16つあれば十分良好だが、そのコストは間違いなく当時では高価すぎていた。

# キューブマップスペキュラ[Cubemap Specular]

- 非局所的なサンプリングアーティファクト
<!--  -->
- ライティング信号とBRDFにより近く合致する。
- 非局所的
    - AABBの透視投影の歪み[perspective warping]を実装した。
    - 未だ完璧ではなく、正方形でない部屋を作る[author]のが難しい。
- 輝く[glowing]エッジを引き起こす。
    - オクルージョンの欠落

<!-- p.10 -->

- 局所化とオクルージョンの問題

左のスクリーンショットは我々のゲームではとても一般的な問題である。誤ったスペキュラプロブの捕捉[grabbing]は暗い所やエネルギー不足の所で輝くエッジを引き起こすだろう。

方向性オクルージョンをH-Basisに焼き込み、アーティストに距離を指定させようと試みたが、これは難しく、間違いを起こしがちであった。また、キューブマップが誤った位置にあるために、スペキュラが欲しいときに役に立たなかったり、そもそも得られなかったりもした。アーティストはキューブマップの配置の調整に多くの時間を費やした。

# 球面ガウス基底[Spherical Gaussian Basis]

ここには3つの主なテクニックの比較がある。球面ガウスでは、ハイライトの幅がパストレースの解に最も近く一致することに注目する。

# 球面ガウスGI[Spherical Gaussian GI]

# キューブマップとSH9[Cubemap and SH9]

これはキューブマップでの焼き込まれたディフューズライティングを示す古いスクリーンショットである。そのエネルギーは平坦に見え、床は得るべきでないところまでエネルギーを得ている。

# 球面ガウシアン[Spherical Gaussians]

この例では、球面ガウシアンを用いて焼きこまれている。光や影があるべきところにあることに注目する。このシーンは、シャドウとハイライトが混ざっているので、より興味深いものになっているように見える。

# スペキュラの焼き込み[Baking Specular]

このシーンでは、球面ガウシアンライティングを無効化した。

<!-- p.24 -->

- 複数の光源が適切にライトマップにキャプチャされる。
- キューブマップによるエイリアシングがない(追加のおまけ)。

再び有効化するときは、ライト周りのホットスポットに注目する。各光源の周りに多くのキューブマップを配置する必要があるので、この種のライティングをキューブマップでキャプチャするのは非常に困難だろう。

<!-- p.25 -->

このシーンは非常に暗い --- 多くのスペキュラを付け損なっている。この例では、アーティストはキューブマップを十分に持っていなかった。なので、このエリアにひとつでもキューブマップを置けば、おそらく多少は良くなっただろう。しかし、このレベルではメモリの制約によりそれをしなかった。このレベルはとても大きく、膨大な量のゲームプレイエリアがあったので、すべてのスポットで十分なキューブマップを得ることは実行可能な選択肢ではなかった。

<!-- p.26 -->

- 引き伸ばされた[stretched]ハイライト
    - キューブマップは等方的なPhongハイライトのみを持つ。
    - SGは長く引き伸ばされたハイライトを持つことができる。

有効化すると、このエリアのSGのエネルギーが戻ってきて、金属の梁に引き伸ばされたハイライトを得ることに注目する。キューブマップが円形ハイライトのみをサポートするのに対し、球面ガウシアンは細長い[elongated]ハイライトを可能にするBRDFに対する半角パラメータ化を用いる。

<!-- p.28 -->

この例では、2箇所が確認できる。床と木のパネルで細長いハイライトが確認できる。このエリアでキューブマップのみを用いていた場合にはジオメトリのすべてが明るく輝いていたであろう複雑なジオメトリにも気付く。

# 基本的な数学的特性[Basic Mathematical Properties]

# 球面ガウシアン[Spherical Gaussians]

$$
Ae^{\frac{1}{W}(M \cdot x - 1)}
$$

- $A$: 縦幅[amplitude]
- $W$: 横幅[Width]
- $M$: 平均[Mean]

私見では、SGは、直観的なパラメータを持つので、理解しやすい方である。

これらは等方的なので、2Dでグラフ化できる。この可視化では、真ん中で輪切りにして、X軸を平均からの角度で表している。

これは平均からの測地的な距離に基づいて減少[falloff]する関数のような指数関数的ガウシアンである。

<!-- p.31 -->

- 平均は指す方向を制御する。
- 横幅はフォールオフを制御する。
- 縦幅は高さ又は強度を制御する。

<!-- p.32 -->

平均は単純な正規化済み方向ベクトルである。望みの方向に回転するのは容易い。

<!-- p.33 -->

横幅パラメータ、または、たまにフォールオフ、周波数[frequency]、逆幅[inverse width]と呼ばれるそれは、関数がどれだけ素早く平均から減少するかを制御する。

横幅パラメータを変更すると、関数が持つエネルギーの総量を変更する。

<!-- p.34 -->

縦幅は高さを制御する。これは線形な応答を持つので、より直観的なパラメータのひとつである。例えば、関数に2をかければ、平均方向で高さが2倍になる。

しかし、高さを変更すると、関数の総エネルギー量を変更することにも注意する。故に、振幅と周波数は関数の総エネルギー量に対して結びつけられる。

<!-- p.35 -->

- SG *(演算子)* SG = SG (閉じた演算子)
    - 回転は単純な3Dベクトルの回転である。
    - 閉形式の積分
        - 畳み込み、内積
    - 閉形式の積[product]
        - 二重積[double product?]、三重積[triple product]、など

SGの実際の力はどれだけの演算と閉形式の演算をサポートするかによる。ほとんどの演算は別のSGを生成するので、多くの単純なものをつなぎ合わせ、単一のSGを得ることができる。

これはレンダリング方程式のような複雑な数式を取り、解析的に評価できるようにする。

<!-- p.36 -->

- 複雑な信号を表現するために足し合わせることができる。

SGで可能になるもうひとつの本当に興味深い演算はそれらを足し合わせることである。

左に青い壁、赤い天井、右に緑の壁のある部屋があると想像しよう。上記の図のにあるようなSGで各方向からの放射輝度を表すことができる場合、右の関数を得るために足し合わせることができる。

右の関数のサンプリングを単純化すると、その方向での放射輝度を得るだろう。

<!-- p.37 -->

- エリアライトを表現できる。

SGはエリアライトを表現できる。

<!-- p.38 -->

- …それと、様々なBRDF。

SGはBRDFを表現できる。

# SGライトマップ[SG Lightmaps]

# ライトマップデータ[Light Map Data]

- 5、6、9、12のRGBの **非負** のHDR係数
    - 係数の数は任意
    - SH4/H-Basis4を置き換えるために4を使うことができる。
- 色データのみを含む。
- BC6で圧縮されたライトマップ
- 平均方向と横幅はシェーダにハードコートされた定数である。

ライトマップに格納されるデータはHDRのRGB色のみである。持つローブの数は持つライトマップの数を指示[dictate]する。アーティストがこの概念を理解するのはとても簡単で直観的である。ライトマップはローブ方向での放射輝度を表すので、SHとは異なり各ライトマップでどうなっているかを詳しく調べ[inspect]、理解することは非常に容易である。

係数は圧縮や精度の助けになる正の値のみである。

方向と横幅はライトマップには格納されない。

# SGの焼き込まれたライティング[SG Baked Lighting]

- 各ライトマップのテクセルに焼き込まれたSGの合計として放射輝度を表現する。

ここにはライトマップの各テクセルでの球面ガウシアンの可視化がある。各半球はSGの数の合計である。見ての通り、図中の球は、右の赤の壁、上部の空、カメラや床の背後の緑の壁から来るの放射輝度を示す。

# 固定の方向[Fixed Directions]

- 球上で均等に分けた方向の固定のセット
- 5、6、9、12
- 黄金比の螺旋を用いる。

ローブ数に基づいて、黄金比の螺旋のアルゴリズムを用いて方向の一様分布を生成する。

# 固定の横幅[Fixed Widths]

- 横幅
    - 小さすぎる == 乖離
    - 大きすぎる == 過剰ブラー
    - 丁度いい

横幅は、連続的で、乖離がなく、信号を過剰にブラーするほど広すぎたりしないように、解決する必要がある。

# なぜ固定の基底か？[Why Fixed Basis?]

- 可変のスカラの数
    - 27つの色用スカラ (9 * 3)
    - 9つの横幅
    - 18つの方向用スカラ ($\theta$/$\phi$)
    - == 54
- 固定のスカラの数
    - == 27
- 固定の利点
    - 同じデータ量で2倍多い方向
    - より多い最適化の機会
    - 隣接テクセル間の補間問題がない

# SGを伴うライティング[Lighting with SGs]

- 基本のアイデア
    - SGの合計として放射輝度を表現する。
    - ひとつのSGとしてBRDFを表現する。

SGの合計として放射輝度を、ひとつのSGとしてBRDFを表現できるならば、ライティングを得るためにSGの解析的な積分演算を用いることができる。これが基本のアイデアである。

# SGの焼き込まれたライティング[SG Baked Lighting]

- 実際の実装はもっと複雑である。
    - Fresnel
    - シャドウイング
    - マスキング
    - NDFの歪曲[warping]
        - NDF SGは半角でパラメータ化される。
        - 放射輝度SGはライト方向でパラメータ化される。
        - 効率的なSGの乗算のために同じ空間にある必要がある。

<!-- p.47 -->

- NDF近似
    - Beckmann = 1つのSG
    - GGX      = 3つのSG

BeckmannのNDFの近似は1つのSGだけで極めて正確に行うことができる。GGXのBRDFは良好な長いテール[wide tail]を得るために3つのSGを必要とする。

1。しかし、アンビエントライティングでは、GGXローブのテールはパンクチュアルな光源では言うほど目立たない。なので、このスライドのようにひどくはならない。

# SGを伴うライティング[Lighting with SGs]

- NDF * 放射輝度 (不可能: 空間が異なる！)
    - NDF    = 半角空間
    - 放射輝度 = 正接空間

残念ながら、SGへの入力パラメータが異なる空間にあるため、放射輝度とNDFを解析的に積分できない。ライティング方向で積分する場合、NDFではそのライティング方向を半角方向に変換しなければならない。主なアイデアは、同じ方向を指し、その空間でNDFを最も良く表す他のSGを生成する。

このアイデアではまず、ライト方向の方向を指すようにNDFを回転する。そして、NDFのエネルギーを最も良く表すように横幅を修正する。しかし、SGは対称的に横幅を修正することしかできないが、半角パラメータ化により、他よりもある方向に実際にスケールする。このため、SGをASG(非対称球面ガウシアン)に昇格させる。これは2つの方向で個別に伸縮[stretch]することができるようになる。

<!-- p.49 -->

TODO
