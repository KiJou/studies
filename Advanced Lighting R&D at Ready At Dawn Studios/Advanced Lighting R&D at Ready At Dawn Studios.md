---
title: Advanced Lighting R&D at Ready At Dawn Studios [@Neubelt2015]
numberSections: false
---
# 焼き込み式大域照明[Baked Global Illumination]

- 目標
    - 高品質な静的GI
    - 焼き込まれた環境
    - 焼き込まれたキャラクターライティング
    - ディフューズとスペキュラ

The Order: 1886は屋内と屋外の両方の中くらいの大きさのレベルを持つリニアなゲームである。このゲームはそのライティング的にかなり静的であり、我々のプロジェクトに対して静的に焼き込まれたGIソリューションを使うのに最も理に適っている。

ディフューズライティングだけでなくスペキュラGIも同様にキャプチャするのが重要である。焼き込まれたスペキュラを強く推し進める多くの理由のひとつはキューブマップを用いることで発生する制限である(間違った場所と角度の品質で間違った反射を空間的に取得する)。

# 沢山の解決法を試した[Tried Many Solutions]

- 焼き込まれたAO
- SG(5, 6, 9, 12)
- SH(4, 9)
- 方向性ディフューズ
- PRT
- 方向性AO
- RGBディフューズ
- 透視投影補正キューブマップ
- H-Basis4/6
- H-Basis AO

我々は開発中に多くのテクニックを試したが、これらの中に我々のニーズにピタリと一致するものはなかった。いくつかのテクニックは小道具用のスペキュラおよびディフューズオクルージョンのためのH-Basis AOのような出荷する製品に残ったままになっている。

しかしながら、最終的には球面ガウス[Spherical Gaussians]を用いることになり、これに決定した理由を手短に見ていこうと思う。

# 球面調和ディフューズ[Spherical Harmonics Diffuse]

- 良い場合: 低い周波数の信号
- 悪い場合: 高い強度、方向性のライティング

注意: 信号をブラーするコストでリンギング[ringing]を減らすために窓関数を適用できる。

HDRライティングは、高い正の係数を打ち消すような非常に大きな負数になる、とあるローブを引き起こす可能性がある。これは品質や圧縮に悪影響である。

# 球面調和リンギング[Spherical Harmonics Ringing]

リンギングは我々のゲーム中には、ライティングコストを抑えるために直接光を焼き込むときに現れる。これはキャラクターを死んだ/ゾンビのような見た目にしてしまう。リンギングはライティングを、例えば前頭部では行き過ぎに、光の当たらない側では暗すぎにしてしまう。

# 球面調和スペキュラ[Spherical Harmonics Specular]

- 高周波データには大量の係数が必要
- 評価が高価
    - テクスチャルックアップ
    - SHの回転
    - 評価

我々はBungieが実装した球面調和スペキュラを試した。ルックアップ、SH回転、BRDF評価の組み合わせにより少々高価すぎた。

<!-- p.8 -->

- SH9は艶消し[matte]のように見える。

9つの係数のみではマットなルックになる。係数が16つあれば十分良好だが、そのコストは間違いなく当時では高価すぎていた。

# キューブマップスペキュラ[Cubemap Specular]

- 非局所的なサンプリングアーティファクト
<!--  -->
- ライティング信号とBRDFにより近く合致する。
- 非局所的
    - AABBの透視投影の歪み[perspective warping]を実装した。
    - 未だ完璧ではなく、正方形でない部屋を作る[author]のが難しい。
- 輝く[glowing]エッジを引き起こす。
    - オクルージョンの欠落

<!-- p.10 -->

- 局所化とオクルージョンの問題

左のスクリーンショットは我々のゲームではとても一般的な問題である。誤ったスペキュラプロブの捕捉[grabbing]は暗い所やエネルギー不足の所で輝くエッジを引き起こすだろう。

方向性オクルージョンをH-Basisに焼き込み、アーティストに距離を指定させようと試みたが、これは難しく、間違いを起こしがちであった。また、キューブマップが誤った位置にあるために、スペキュラが欲しいときに役に立たなかったり、そもそも得られなかったりもした。アーティストはキューブマップの配置の調整に多くの時間を費やした。

# 球面ガウス基底[Spherical Gaussian Basis]

ここには3つの主なテクニックの比較がある。球面ガウスでは、ハイライトの幅がパストレースの解に最も近く一致することに注目する。

# 球面ガウスGI[Spherical Gaussian GI]

# キューブマップとSH9[Cubemap and SH9]

これはキューブマップでの焼き込まれたディフューズライティングを示す古いスクリーンショットである。そのエネルギーは平坦に見え、床は得るべきでないところまでエネルギーを得ている。

# 球面ガウシアン[Spherical Gaussians]

この例では、球面ガウシアンを用いて焼きこまれている。光や影があるべきところにあることに注目する。このシーンは、シャドウとハイライトが混ざっているので、より興味深いものになっているように見える。

# スペキュラの焼き込み[Baking Specular]

このシーンでは、球面ガウシアンライティングを無効化した。

<!-- p.24 -->

- 複数の光源が適切にライトマップにキャプチャされる。
- キューブマップによるエイリアシングがない(追加のおまけ)。

再び有効化するときは、ライト周りのホットスポットに注目する。各光源の周りに多くのキューブマップを配置する必要があるので、この種のライティングをキューブマップでキャプチャするのは非常に困難だろう。

<!-- p.25 -->

このシーンは非常に暗い --- 多くのスペキュラを付け損なっている。この例では、アーティストはキューブマップを十分に持っていなかった。なので、このエリアにひとつでもキューブマップを置けば、おそらく多少は良くなっただろう。しかし、このレベルではメモリの制約によりそれをしなかった。このレベルはとても大きく、膨大な量のゲームプレイエリアがあったので、すべてのスポットで十分なキューブマップを得ることは実行可能な選択肢ではなかった。

<!-- p.26 -->

- 引き伸ばされた[stretched]ハイライト
    - キューブマップは等方的なPhongハイライトのみを持つ。
    - SGは長く引き伸ばされたハイライトを持つことができる。

有効化すると、このエリアのSGのエネルギーが戻ってきて、金属の梁に引き伸ばされたハイライトを得ることに注目する。キューブマップが円形ハイライトのみをサポートするのに対し、球面ガウシアンは細長い[elongated]ハイライトを可能にするBRDFに対する半角パラメータ化を用いる。

<!-- p.28 -->

この例では、2箇所が確認できる。床と木のパネルで細長いハイライトが確認できる。このエリアでキューブマップのみを用いていた場合にはジオメトリのすべてが明るく輝いていたであろう複雑なジオメトリにも気付く。

# 基本的な数学的特性[Basic Mathematical Properties]

# 球面ガウシアン[Spherical Gaussians]

$$
Ae^{\frac{1}{W}(M \cdot x - 1)}
$$

- $A$: 縦幅[amplitude]
- $W$: 横幅[Width]
- $M$: 平均[Mean]

私見では、SGは、直観的なパラメータを持つので、理解しやすい方である。

これらは等方的なので、2Dでグラフ化できる。この可視化では、真ん中で輪切りにして、X軸を平均からの角度で表している。

これは平均からの測地的な距離に基づいて減少[falloff]する関数のような指数関数的ガウシアンである。

<!-- p.31 -->

- 平均は指す方向を制御する。
- 横幅はフォールオフを制御する。
- 縦幅は高さ又は強度を制御する。

<!-- p.32 -->

平均は単純な正規化済み方向ベクトルである。望みの方向に回転するのは容易い。

<!-- p.33 -->

横幅パラメータ、または、たまにフォールオフ、周波数[frequency]、逆幅[inverse width]と呼ばれるそれは、関数がどれだけ素早く平均から減少するかを制御する。

横幅パラメータを変更すると、関数が持つエネルギーの総量を変更する。

<!-- p.34 -->

TODO
