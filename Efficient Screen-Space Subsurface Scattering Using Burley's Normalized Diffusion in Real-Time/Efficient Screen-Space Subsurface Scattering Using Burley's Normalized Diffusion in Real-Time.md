---
title: Efficient Screen-Space Subsurface Scattering Using Burley's Normalized Diffusion in Real-Time [@Golubev2018]
---
# Efficient Screen-Space Subsurface Scattering Using Burley's Normalized Diffusion in Real-Time

# 表面下散乱とは？

- 表面下の関与媒質内部での光輸送

表面下散乱とは何かを理解しようとするところから始めよう。

定義により、それは表面下の関与媒質内部での光輸送である。

光は誘電体の境界で屈折して…

# 表面下散乱とは？

…関与媒質内部で複数回散乱して…

# 表面下散乱とは？

…再び外へ屈折する。

# 表面下散乱とは？

- BSSRDF: $f_{ss}(p_{entry}, p_{exit}, l, v) = c F_t(p_{entry}, l) R(\| p_{entry} - p_{exit} \|) F_t(p_{exit}, v)$

散乱は一般的に等方的であると仮定され(これは多重散乱に対して理に適った仮定である)、故に、放射対称な拡散プロファイルによってモデル化される[@Jensen2001]。

これは以下のBidirectional Subsurface Scattering Reflectance Distribution Function(縮めてBSSRDF)の定義をもたらす。ここで、$R$は拡散プロファイルであり、$F_t$はフレネル透過率であり、$C$は正規化定数である。

# 表面下散乱とは？

実践においてこれの意味する所は、肌のようなマテリアルが一般にプラスティックのようではなくなめらかで有機的[organic]であるように見えることである。<ここにあるのはリアルタイムにHDRPでレンダリングした肌と眼の表面下散乱を示しているモデルの例である。>

照明が唐突に変化するエリアの周りでいくらかの色にじみ[color bleeding]があったりもする。

SSSを使うとすべてのシャドウ境界の近くで色にじみを目立たせてしまう[get pronounced]というある誤解が存在するように思われる。実際、シャドウがソフトであるならば、それは非常に微妙なものである。

# リアルタイム表面下散乱

- オリジナル: テクスチャ空間、4つの計測データへのガウシアンのあてはめ[@dEon2007]
- 動機: ガウシアンの畳み込みは可分[separable]→高速
- ゲーム: スクリーンスペースのアルゴリズム
- 拡散プロファイルのモデル:
    - 1つのガウシアンとディラックのデルタ[@Mikkelsen2010]
    - 2つのガウシアン[@Jimenez2014]

表面下散乱は一般的にどうやって実装されるか？

最初のリアルタイムSSSアプローチはEugene d'Eonによって提案され、計測された拡散プロファイルに対する数値的なあてはめを生成するために(具体的には4つの)ガウシアンの混合[mixture of Gaussian]を用いた。

ガウシアンはいくつかの理由により選ばれた:

- ガウシアンの混合は数値的なあてはめにとって便利な対象である。
- 加えて、ガウシアンでの畳み込みは可分であり、すなわち、サンプル数に(二乗ではなく)線形な複雑さを持つ。
- そして最後に、"小さな"ガウシアンでの反復した畳み込みは"大きな"ガウシアンでの単一の畳み込みと等価である。

このアプローチは素晴らしい[fantastic]結果を生み出すが、ゲーム用には依然として、こんにちでさえも、高価すぎる。故に、リアルタイム制約はスクリーン空間でSSSを実装することを強制する。

そのフィルタは通常1または2つのガウシアンとディラックのデルタ関数から成る。これは実践においてオリジナル画像とブラーされた画像の間を補間することを意味する。

# 可分な表面下散乱での問題

- 動機: ガウシアンの畳み込みは可分であり、それ故に、高速である
    - 平面上でフィルタリングするときにだけ可分である
- バイラテラルフィルタリングは畳み込みを"偽の可分"にする
    - 結果は見た目にもっともらしい
- 混合ガウス[Gaussian mixture]の定式は、ガウシアンごとに2つの畳み込みパスを行わない限り、明らかに不可分である
    - コンテンツ側で修正しなければならないようなアーティファクトを引き起こすかもしれない、*いくらか可分な[somewhat separable]スクリーンスペースSSS(SSSSSSS)*を引き起こし得る
    - 2つのガウシアンに対して4つのパスを処理するのは実践において高価すぎる

# 可分な表面下散乱での問題

- 2つのガウシアンでは計測データに対する部分的なあてはめをもたらすのみである[@Burley2011]

単一のガウシアンは多重散乱の近似ではかなり良い仕事をする。
しかし、2つのガウシアンの混合でさえ単一および多重散乱の組み合わせを正確に表現するのに苦戦する。

画像では、リファレンス結果を白色に、2重のガウシアン近似を赤色に確認できる。

# 可分な表面下散乱での問題

- 混合ガウスはアーティストフレンドリーではない
    - ガウシアンは単なる数学的な概念である
    - アーティストは計測データを用いるか、数値あてはめを"目測[eyeball]"するかのいずれかを強制される
        - 多すぎる自由度(7)
        - 多くの組み合わせは無意味である

混合ガウスモデル[Gaussian mix model]を実装した後、我々はもうひとつの問題に遭遇した --- アーティストフレンドリーではない。

ガウシアンは単なる数学的な概念であり、SSSの文脈において物理的な意味を持たない。そして、lerpパラメータとそれらの内の2つがあるとき、その自由度は7になり、結果の組み合わせが理にかなうようにこれらをセットアップする方法は必ずしも明らかではない。

触れておくべきこととして、熟練のアーティストは依然として混合ガウスモデルで素晴らしい結果を達成することができる。しかし、これは、Unityに上手く合致しない、長々しく複雑なプロセスとなり得る。

# でも、不可分な畳み込みは遅いんでしょ？

- ともかく、試してみよう :-)

# Burleyの正規化済み拡散モデル

- "DisneyのSSS"として知られる
- Brent BurleyとPer Christensenによって開発される[@Burley2015]
- リファリンスのMCデータに対する曲線あてはめ[@Wang1995]
- 関与媒質内部での単一および多重散乱の両方を計算に入れる

では、より良い解法はあるのか？まあ、このトークのタイトルにあるけど。 :-)

我々は、我々がDisneyのSSSと呼ぶ、Burleyの正規化済み拡散モデルを実装した。

これはモンテカルロシミュレーションを用いて得られたリファレンスデータに対する正確なあてはめをもたらす。
必然的に[naturally]、これは単一および多重散乱の両方を計算に入れることを意味する。

# Burleyの正規化済み拡散モデル

$$
R(r) = As \frac{e^{-sr} + e^{-sr/3}}{8 \pi r}
$$

これは2つのパラメータのみを持つ: ボリュームのアルベド$A$と形状パラメータ$s$。両方とも色のように補間することができる。
形状パラメータは散乱距離に反比例[inversely proportional]する。また、これはUIに開示しているものである。

結果のプロファイルのグラフを見ると、2つのことが明らかとなる:

1. 鋭いピークと長いテールは単一のガウシアンではモデル化できない
2. 結果のフィルタは明らかに不可分である

# Burleyの正規化済み拡散モデル

- 拡散プロファイルは正規化され、PDFとして使うことができる

$$
\int_0^{2\pi} \int_0^{\infty} rR(r) dr d\phi = A \\
p(r) = \frac{rR(r)}{A}
$$

その拡散プロファイルは正規化され、確率密度関数(縮めてPDF)として直接使うことができる。これは、すぐに分かるであろうが[as we'll see in a bit]、モンテカルロ積分に対して有用な特性である。

# 表面下散乱の実装

- ディフューズBRDFはSSSの遠距離場[far-field]の近似である
    - ディフューズ透過の振る舞いを定義するためにDisneyのディフューズBRDFの定式を使う[@Burley2015]
        - 物理的にもっともらしくないが、ランバート分布を仮定するより良好である

$$
f_d(l, v) = \frac{A}{\pi} F_{dt}(l) F_{dt}(v) + f_{rr} \\
F_{dt}(x) = 1 - 0.5(1 - |n \cdot x|)^5
$$

ディフューズBRDFは散乱距離がピクセルのフットプリントの内にあるときにSSSを近似する。
これの意味する所は両方のシェーディングモデルがある距離を越えた所で同じビジュアルを持つ必要があるということである。

これを達成するため、我々は誘電体の境界でディフューズ透過の振る舞いを定義するためにDisneyのディフューズBRDFの定式を用いる。
GGXモデルによって定義される透過と合致しないが、ランバート分布を仮定するよりかは依然として良好である。

# 表面下散乱の実装

- スペキュラ透過のサポートがない(単一および多重散乱のみ)

我々はスペキュラ透過をモデル化せず、我々のモデルはガラスのようなアルベドの低いマテリアルに対して一般化しない。

*注: 透過は紛らわしい項であるかもしれない。スペキュラ透過はなめらかな誘電体の境界でのフレネル透過を指す。
　  ディフューズ透過は粗い誘電体の境界を通る透過をモデル化し、一般に大きな多重散乱の量を仮定する。しばしば、これは単なるランバート項である。*

# 表面下散乱の実装

- ディフューズBRDFはSSSの遠距離場の近似である
    - ボリュームアルベドとして表面のアルベドを使う
        - 2つのテクスチャリングの選択肢を提供する[@dEon2007]
            - 散乱後[post-scatter]テクスチャリング: 脱出[exit]位置でのアルベド
            - 散乱前および後[pre- and post-scatter]テクスチャリング: 侵入[enter]および脱出の両方での$sqrt(albedo)$

ビジュアル上の無矛盾性[consistency]を強制するため、我々はボリュームアルベドとして表面のアルベドを直接的に用いることも行う。

我々は2つのアルベドテクスチャリングの選択肢を提案する:

1. 散乱後テクスチャリングはアルベドテクスチャがすでにSSS由来の色にじみを含むときに使うべきである。これはスキャンや写真の場合に使われる。このモードでは、脱出位置で、一度だけアルベドを適用する。
2. 散乱前および後テクスチャリングはアルベドを事実上ブラーする。これは、ある場合に望ましい、よりソフトでより自然に見える結果をもたらし得る。

# 表面下散乱(無効)

両方のテクスチャリングモードの例をいくつか見ていこう。
WikiHumanプロジェクトで親切にも共有されている[kindly shared]Emilyのオリジナルモデルから始めたい。

この画は明らかにいくらかのSSが必要である…

# 表面下散乱(散乱後)

さて、これが、散乱後テクスチャリングを有効化したものである。

(行ったり来たりする)

思った通り、散乱後のオプションがディテールを維持することではより良い仕事をこなしていることに気付くかもしれない。
その差は微妙であるので、後に良いディスプレイ上でスライドを見ることをオススメする。

# 表面下散乱(散乱前および後)

そして、これが散乱前および後テクスチャリングである。

(行ったり来たりする)

思った通り、散乱後のオプションがディテールを維持することではより良い仕事をこなしていることに気付くかもしれない。
その差は微妙であるので、後に良いディスプレイ上でスライドを見ることをオススメする。

# 表面下散乱の実装

- 拡散プロファイルは正規化される
    - これは実質的に幾何表面に沿ったエネルギー保存的ブラーである
- スクリーン空間におけるバイラテラルフィルタで近似する[@Mikkelsen2010]

Burleyの拡散プロファイルは正規化されているので、SSSはエネルギー保存的なブラーフィルタとして実装できる。
周囲の表面に渡って侵入点から再頒布される光のエネルギーをイメージできる…

以前のアプローチと同様に、我々はスクリーン空間で畳み込みを行い、表面ジオメトリを計算に入れた深度バッファを用いる。

# 表面下散乱のアルゴリズム

アルゴリズム全体のビジュアル的な概要を教えましょう。

ライティングパス:
表面の侵入点で入射する放射輝度を計算する
光の方向から表面へのディフューズ透過を処理する
テクスチャリングモードに依存して侵入点のアルベドを適用する
レンダターゲットに透過した放射輝度を記録する


# 表面下散乱のアルゴリズム

SSSパス:
脱出点の周りの拡散プロファイルで放射輝度バッファのバイラテラルフィルタリングを処理する
テクスチャリングモードに依存して脱出点のアルベドを適用する
ビュー方向における表面の外側のディフューズ透過を処理する

# 表面下散乱のアルゴリズム

理想的には、オブジェクトの表面を直接サンプリングすべきである(注)が、リアルタイムアプリケーションでは高価すぎる。
代わりに、我々はオフラインで事前計算し、(概念的に)円板上に配置するサンプルのセットを用いる。ここでは緑の破線で描かれる。
ほぼ間違いなく[arguably]より悪いことは、円板から表面へのサンプルの投影が距離を歪ませるので、投影されたサンプルは最終的に異なる分布内となる。我々はこれについてなにかを行わなければならないが、まずは…

注:これは基本的にフォトンマッピングを用いるSSSである。

# 拡散プロファイルのサンプリング

- 拡散プロファイルに従って円板サンプリングを処理する
    - 良いサンプル分布が欲しい
        - パフォーマンス上の理由から、少ないサンプルのひとつひとつを有意義に使う！[few samples make each and every one of them count]

…円板サンプリングについて話そう。
我々はパフォーマンス上の理由から少数のサンプルのみを取ることができる。つまり、我々はそのひとつひとつを有意義に扱う必要がある。

# 拡散プロファイルのサンプリング

- 拡散プロファイルに従って円板サンプリングを処理する
    - 重点サンプリングを行う --- PDF$p(r)$に従って$r$を分布させる
        - PDF: $p(r) = \frac{s}{8\pi}(e^{-sr}+e^{-sr/3})$
        - CDF: $P(r) = 1 - \frac{1}{4} e^{-sr} - \frac{3}{4} e^{-sr/3}$
        - $s$はスペクトル値であり、$(1/s \propto 散乱距離 \propto \sigma^2)$^[$\propto$は比例関係を表す]であり、$s$の最小値で色チャネルを重点サンプリングする

それ故に、我々はradial distanceを重点サンプリングする --- 拡散プロファイルのPDFに従ってこれらを分布させる。

形状パラメータ$s$はスペクトル値であり、散乱距離に反比例する。それ自体は分散に比例する。できる限りの最良の分散低減を達成したいので、我々は最長の散乱距離に対応する色チャネルを重点サンプリングすることを選ぶ(肌では赤チャネル)。

# 拡散プロファイルのサンプリング

- 拡散プロファイルに従って円板サンプリングを処理する
    - 重点サンプリングを行う --- PDF$p(r)$に従って$r$を分布させる
        - CDF$P(r)$は解析的に可逆でない
        - Halley法を用いてnumerical inversionを行う[@Press2007]
            - $s$と$x$を与えて、$P(r, s) = x$を解く
            - ニュートン法に似ているが、2つの微分が必要
            - 2〜4回の反復でフル浮動小数点精度に収束する

重点サンプリングでは、累積分布関数(CDF)を逆にする必要がある。
残念ながら、そのCDFは解析的に逆にできないので、Halley法を用いてnumerical inversionという最終手段に手を出す[resort]。これは、そうは言っても、実践においてかなり効率的である。

*注:Halley法は、ニュートン法に続く、Householder法に分類される2つ目のアルゴリズムである。*

# 拡散プロファイルのサンプリング

- 拡散プロファイルに従って円板サンプリングを処理する
    - フィボナッチ数列を用いて角度$\varphi$を一様にサンプリングする[@Hannay2004]
        - 球や円板に分布する他の低食い違い数列より優れて一般に処理する[@Marques2015]
        - さすれば、拡散プロファイルでの畳み込みは単なるサンプル値と重みの内積である:

$$
I \approx \frac{2\pi}{n} \sum_{i=1}^{n} \frac{R(r_i)}{p(r_i)} L(r_i, \phi_i) = \sum_{i=1}^n w_i L(r_i, \phi_i)
$$

最後に極角[polar angle]を一様にサンプルするためにフィボナッチ数列を用いる。これは球や円板上に良いサンプル分布を生み、反射プロブフィルタリングのような、多くの文脈で有用である。

我々は円板に渡って畳み込みを行うためにモンテカルロ積分法を用いる。これはとどのつまりサンプル値と重みの内積になる。

# 拡散プロファイルのサンプリング

重点サンプリング処理は結果としてこのように見え得る事前計算されるサンプルパターンをもたらす。

エネルギーのほとんどがそこに集中しているので、原点近くをより密にサンプルすることに注意してほしい。

# バイラテラルフィルタリング

TODO
