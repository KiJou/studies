---
title: Efficient Screen-Space Subsurface Scattering Using Burley's Normalized Diffusion in Real-Time [@Golubev2018]
---
# Efficient Screen-Space Subsurface Scattering Using Burley's Normalized Diffusion in Real-Time

# 表面下散乱とは？

- 表面下の関与媒質内部での光輸送

表面下散乱とは何かを理解しようとするところから始めよう。

定義により、それは表面下の関与媒質内部での光輸送である。

光は誘電体の境界で屈折して…

# 表面下散乱とは？

…関与媒質内部で複数回散乱して…

# 表面下散乱とは？

…再び外へ屈折する。

# 表面下散乱とは？

- BSSRDF: $f_{ss}(p_{entry}, p_{exit}, l, v) = c F_t(p_{entry}, l) R(\| p_{entry} - p_{exit} \|) F_t(p_{exit}, v)$

散乱は一般的に等方的であると仮定され(これは多重散乱に対して理に適った仮定である)、故に、放射対称な拡散プロファイルによってモデル化される[@Jensen2001]。

これは以下のBidirectional Subsurface Scattering Reflectance Distribution Function(縮めてBSSRDF)の定義をもたらす。ここで、$R$は拡散プロファイルであり、$F_t$はフレネル透過率であり、$C$は正規化定数である。

# 表面下散乱とは？

実践においてこれの意味する所は、肌のようなマテリアルが一般にプラスティックのようではなくなめらかで有機的[organic]であるように見えることである。<ここにあるのはリアルタイムにHDRPでレンダリングした肌と眼の表面下散乱を示しているモデルの例である。>

照明が唐突に変化するエリアの周りでいくらかの色にじみ[color bleeding]があったりもする。

SSSを使うとすべてのシャドウ境界の近くで色にじみを目立たせてしまう[get pronounced]というある誤解が存在するように思われる。実際、シャドウがソフトであるならば、それは非常に微妙なものである。

# リアルタイム表面下散乱

- オリジナル: テクスチャ空間、4つの計測データへのガウシアンのあてはめ[@dEon2007]
- 動機: ガウシアンの畳み込みは可分[separable]→高速
- ゲーム: スクリーンスペースのアルゴリズム
- 拡散プロファイルのモデル:
    - 1つのガウシアンとディラックのデルタ[@Mikkelsen2010]
    - 2つのガウシアン[@Jimenez2014]

表面下散乱は一般的にどうやって実装されるか？

最初のリアルタイムSSSアプローチはEugene d'Eonによって提案され、計測された拡散プロファイルに対する数値的なあてはめを生成するために(具体的には4つの)ガウシアンの混合[mixture of Gaussian]を用いた。

ガウシアンはいくつかの理由により選ばれた:

- ガウシアンの混合は数値的なあてはめにとって便利な対象である。
- 加えて、ガウシアンでの畳み込みは可分であり、すなわち、サンプル数に(二乗ではなく)線形な複雑さを持つ。
- そして最後に、"小さな"ガウシアンでの反復した畳み込みは"大きな"ガウシアンでの単一の畳み込みと等価である。

このアプローチは素晴らしい[fantastic]結果を生み出すが、ゲーム用には依然として、こんにちでさえも、高価すぎる。故に、リアルタイム制約はスクリーン空間でSSSを実装することを強制する。

そのフィルタは通常1または2つのガウシアンとディラックのデルタ関数から成る。これは実践においてオリジナル画像とブラーされた画像の間を補間することを意味する。

# 可分な表面下散乱での問題

- 動機: ガウシアンの畳み込みは可分であり、それ故に、高速である
    - 平面上でフィルタリングするときにだけ可分である
- バイラテラルフィルタリングは畳み込みを"偽の可分"にする
    - 結果は見た目にもっともらしい
- 混合ガウス[Gaussian mixture]の定式は、ガウシアンごとに2つの畳み込みパスを行わない限り、明らかに不可分である
    - コンテンツ側で修正しなければならないようなアーティファクトを引き起こすかもしれない、*いくらか可分な[somewhat separable]スクリーンスペースSSS(SSSSSSS)*を引き起こし得る
    - 2つのガウシアンに対して4つのパスを処理するのは実践において高価すぎる

# 可分な表面下散乱での問題

- 2つのガウシアンでは計測データに対する部分的なあてはめをもたらすのみである[@Burley2011]

単一のガウシアンは多重散乱の近似ではかなり良い仕事をする。
しかし、2つのガウシアンの混合でさえ単一および多重散乱の組み合わせを正確に表現するのに苦戦する。

画像では、リファレンス結果を白色に、2重のガウシアン近似を赤色に確認できる。

# 可分な表面下散乱での問題

- 混合ガウスはアーティストフレンドリーではない
    - ガウシアンは単なる数学的な概念である
    - アーティストは計測データを用いるか、数値あてはめを"目測[eyeball]"するかのいずれかを強制される
        - 多すぎる自由度(7)
        - 多くの組み合わせは無意味である

混合ガウスモデル[Gaussian mix model]を実装した後、我々はもうひとつの問題に遭遇した --- アーティストフレンドリーではない。

ガウシアンは単なる数学的な概念であり、SSSの文脈において物理的な意味を持たない。そして、lerpパラメータとそれらの内の2つがあるとき、その自由度は7になり、結果の組み合わせが理にかなうようにこれらをセットアップする方法は必ずしも明らかではない。

触れておくべきこととして、熟練のアーティストは依然として混合ガウスモデルで素晴らしい結果を達成することができる。しかし、これは、Unityに上手く合致しない、長々しく複雑なプロセスとなり得る。

# でも、不可分な畳み込みは遅いんでしょ？

- ともかく、試してみよう :-)

# Burleyの正規化済み拡散モデル

- "DisneyのSSS"として知られる
- Brent BurleyとPer Christensenによって開発される[@Burley2015]
- リファリンスのMCデータに対する曲線あてはめ[@Wang1995]
- 関与媒質内部での単一および多重散乱の両方を計算に入れる

では、より良い解法はあるのか？まあ、このトークのタイトルにあるけど。 :-)

我々は、我々がDisneyのSSSと呼ぶ、Burleyの正規化済み拡散モデルを実装した。

これはモンテカルロシミュレーションを用いて得られたリファレンスデータに対する正確なあてはめをもたらす。
必然的に[naturally]、これは単一および多重散乱の両方を計算に入れることを意味する。

# Burleyの正規化済み拡散モデル

$$
R(r) = As \frac{e^{-sr} + e^{-sr/3}}{8 \pi r}
$$

これは2つのパラメータのみを持つ: ボリュームのアルベド$A$と形状パラメータ$s$。両方とも色のように補間することができる。
形状パラメータは散乱距離に反比例[inversely proportional]する。また、これはUIに開示しているものである。

結果のプロファイルのグラフを見ると、2つのことが明らかとなる:

1. 鋭いピークと長いテールは単一のガウシアンではモデル化できない
2. 結果のフィルタは明らかに不可分である

# Burleyの正規化済み拡散モデル

- 拡散プロファイルは正規化され、PDFとして使うことができる

$$
\int_0^{2\pi} \int_0^{\infty} rR(r) dr d\phi = A \\
p(r) = \frac{rR(r)}{A}
$$

その拡散プロファイルは正規化され、確率密度関数(縮めてPDF)として直接使うことができる。これは、すぐに分かるであろうが[as we'll see in a bit]、モンテカルロ積分に対して有用な特性である。

# 表面下散乱の実装

- ディフューズBRDFはSSSの遠距離場[far-field]の近似である
    - ディフューズ透過の振る舞いを定義するためにDisneyのディフューズBRDFの定式を使う[@Burley2015]
        - 物理的にもっともらしくないが、ランバート分布を仮定するより良好である

$$
f_d(l, v) = \frac{A}{\pi} F_{dt}(l) F_{dt}(v) + f_{rr} \\
F_{dt}(x) = 1 - 0.5(1 - |n \cdot x|)^5
$$

ディフューズBRDFは散乱距離がピクセルのフットプリントの内にあるときにSSSを近似する。
これの意味する所は両方のシェーディングモデルがある距離を越えた所で同じビジュアルを持つ必要があるということである。

これを達成するため、我々は誘電体の境界でディフューズ透過の振る舞いを定義するためにDisneyのディフューズBRDFの定式を用いる。
GGXモデルによって定義される透過と合致しないが、ランバート分布を仮定するよりかは依然として良好である。

# 表面下散乱の実装

- スペキュラ透過のサポートがない(単一および多重散乱のみ)

我々はスペキュラ透過をモデル化せず、我々のモデルはガラスのようなアルベドの低いマテリアルに対して一般化しない。

*注: 透過は紛らわしい項であるかもしれない。スペキュラ透過はなめらかな誘電体の境界でのフレネル透過を指す。
　  ディフューズ透過は粗い誘電体の境界を通る透過をモデル化し、一般に大きな多重散乱の量を仮定する。しばしば、これは単なるランバート項である。*

# 表面下散乱の実装

TODO
