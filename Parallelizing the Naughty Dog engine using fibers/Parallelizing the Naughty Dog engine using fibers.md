# Parallelizing the Naughty Dog engine using fibers, GDC 2015

http://www.gdcvault.com/play/1022186/Parallelizing-the-Naughty-Dog-Engine

## PS3時代のエンジン

### 構成

- 30Hzのシングルスレッド。
    - ゲームロジックを処理してからコマンドバッファをセットアップしていた。
- SPUはワーカースレッドとして使っていた。
    - エンジンシステムのほとんどはSPU上で処理していた。
- SPU上で動作するgameplayコードはごくわずか。

### 問題点

- ジョブは返すものがなくても完了を待たなければならない。
    - アトミックな単位が決まっている。
- メモリ管理はユーザーがやらなければならない。
    - ジョブを定義したり、メモリの寿命を気にしたりする手間が大きい。
- ジョブリストの状態が煩わしい。
    - ジョブリストが実行中か停止中かを気にしなければならない。
- ジョブ配列を指すマーカーインデックスによるジョブ同期。
    - インデックスは再利用されうるため、使っていないときにリセットしなければならない。

## 新しいジョブシステムのデザインゴール

- SPUに移せなかったコードもジョブ化できるようにする。
- ジョブの実行途中でも追加のジョブを生成できるようにする。
- gameplayプログラマーにも扱いやすいAPI。
- ユーザーがメモリ管理しない。
- 1つのシンプルな方法でジョブの同期や連鎖を行う。
- APIの使いやすさのためなら、パフォーマンスは二の次。

## Fibers

- 個別のスタック空間を持ち、実行状態を保存する。
- 単一のスレッドで実行される。
- 明示的に呼び出す以外で、割り込みが発生しない。
- オーバーヘッドは小さい。
    - ファイバーの付け替えはレジスタの保存と復元のみ行うので、スレッドのコンテキスト切り替え(context switching)が発生しない。

## ジョブシステム

- 各コアに対応させた、6つのワーカースレッド。
- スレッドが実行単位、ファイバーがコンテキスト。
- ジョブは必ずファイバーのコンテキスト内で実行される。
- 同期にはアトミックなカウンターを使う。
- ファイバーを使う。
    - スタックサイズが、64KiBものが128、512KiBのものが32の、計160
- 優先度別の3つのグローバルなキューを持つ。
    - job stealing無し。

### 詳細

- ワーカースレッドはコアに固定される。
    - 無用なスイッチングを避けるため。
- WaitForCounter
    - ジョブをファイバーごと待機させる。
- "The Last of Us: Remastered"では、1フレームに最大800から1000のジョブを処理する。

I/O処理はシステムスレッドで行われるので、そこだけ例外的にデータの読み出しとジョブの発行を行うハンドラで処理する。それ以外はすべてジョブ化されている。

### 利点

- 既存のgameplay更新処理を簡単にジョブ化できる。
- ジョブを待機させるのが簡単。
- ファイバー切り替えが超軽量。

### 欠点

- ミューテクスやセマフォなどのシステムの同期プリミティブが利用できなくなる。
- 同期はハードウェアレベルでやらなければならない。
    - アトミックなスピンロックが至るところで使われている。
    - ロックが長引く場合には特殊なジョブ用ミューテクスを使う。

### ファイバーのサポート

- 基本的にはスレッドと同様にスタックトレースできるしダンプも吐くことができる。
- 寝ているファイバーを異なるスレッドで起こすと、キャッシュされた前のTLSアドレスにアクセスすることがある。
    - コンパイラに"Fiber-Safe TLS"オプションがあれば使う。
    - ないなら、TLSアクセスを毎度キャッシュせずに行うよう、翻訳単位を分ける。
- ジョブシステムではadaptive mutexを使う。
    - システムコールを行う前にスピンロックでどうにかしてみる方法。
    - 優先順位の逆転(priority inversion)によるデッドロックを解決する。
    - 初回のスピンで大抵のシステムコールを回避できる。

## 他のジョブシステム

- 有名所、Intel TBB
- 依存性解決できるが、すべてのジョブの完了を待たなければならない。
- ジョブを待機させると、ネストさせることができる。
    - 子ジョブが完了しない限り親ジョブを再開できない。
