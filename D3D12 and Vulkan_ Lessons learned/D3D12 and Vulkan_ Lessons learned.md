# D3D12 and Vulkan: Lessons learned

## バリア制御(Barrier control)

- バリアはD3D12/Vulkan世代の新しいコンセプト。
- 残念ながら、**みんな** 間違っている。
- 2つの失敗ケース
    - 多すぎ(too many) or 広すぎ(too broad): **パフォーマンスの低下**
    - バリア欠落: **データ破壊(corruptions)**
- D3D11ドライバはその傘の下でうまくこれをこなしている。

## つまるところのバリアとは？(What's a barrier, anyway?)

- レンダターゲットをテクスチャにするとき。
    - decompressionが必要になるかもしれない。

- UAVをリソースにするとき。
    - 誤って行えば、コストがかかる。 -- flushやアイドル待ち
    - 正しく行えば、トランジションが実質タダに。

## バリアが欠落していると(Missing barriers)

- フォーマット問題。 -- GPUやドライバ特有のcorruption。
- 同期問題。 -- 時間依存のcorruption。

## サブリソース(Subresources)

- 個別に追跡する必要がある。
    - ダウンサンプリング。
    - シャドウマップアトラス。
- すべてのサブリソースをトランジションするなら、１つ１つやらずに`D3D12_RECOURCE_BARRIER_ALL_SUBRESOURCES`を使う。

## Placedリソースと初期ステート(Placed resoruces & initial states)

- placedリソースなどとして作成したレンダターゲットは使う前に **必ず** クリアする。
- Go into **clear state directly**, ランダムなステートやトランジションで始めない。

## 不必要なトランジション(Unnecessary transitions)

- 間違った型へのトランジション。
    - 普通はないが、時折起こる。
    - バリデーションレイヤで必ず確認する。

- 読み込みから読み込みへのトランジション。
    - 例えば、インデックスバッファからシェーダリソースへ。
    - 今後に必要なすべてのステートにまとめる。
        - UAV -> IB -> SRVなら、UAV -> IB|SRVにまとめる。

## 高価なトランジション(Costly transitions)

- `COMMON`はコピー/表示のためであり、一般的な"全部入り"ステートではない。
- 通常にシェーダアクセスがしたいなら、
    - D3D12: `PS_RESOURCE | NON_PS_RESOURCE`
    - Vulkan: `VK_ACCESS_SHADER_READ_BIT`

## バリア制御 - 最悪のケース#1(Barrier control - Worst case #1)

- 最悪のケースのバリアシステム - バリア多すぎ。
    - マテリアルシステムが間違いを犯す。
    - ステージ毎に行うと、最大ダメージ。

- "late binding"かドロー毎リソースを固定する。

```
for (stage in stages)
    for (resource in resources)
        RsourceBarrier(1, &resource.Barrier)
```

- 理想的なフロー: 書き込み -> バリア -> ドロー -> ドロー -> ドロー -> ドロー -> ドロー
- マテリアル/ステージ毎アンチパターン
    - ステージ毎リソース毎にバリア1つ。
    - バリアがコマンドリストのあらゆる場所に散らばる。
    - 書き込み -> バリア -> バリア -> バリア -> バリア -> ドロー -> バリア -> バリア -> バリア -> ドロー -> バリア -> ...
- 最悪のケースでは、ことあるごとに複数のアイドル待機が起こる。

## バリア制御 - 最悪のケース#2(Barrier control - Worst case #2)

- "Base state"、または、冗長なトランジション。
- リストアに続きターゲットステートに遷移する。

## おもしろバリア(Funny barriers)

- ResourceBarrier(0, nullptr)
    - なにもしない。
    - ステートのトラッキングが間違ったことをしていることを示す。
- 以前のステートが次のステートと同じ。
    - 考えている以上のことが起こる、ことはない。
- ドライバは**あなたが最適なことをやってくれると思っている**し、**いかなる** 試行錯誤(heuristic)も経ないことを常に念頭に置く。

## 未来のために準備する(Get ready for the future)

- すべてのリソースステートを追跡しなければならない**わけではない**。
- 99%のリソースはイミュータブル。
- "トランジション"ポイント--いつパスが終わるかを見つける。
    - バッチバリアはここ。
    - 必要なトランジションのみ。
    - Gバッファ -> シャドウマップ -バッチトランジション-> シェーディング -バッチトランジション-> ポストエフェクト -バッチトランジション->

## バリアのデバッギングtips

- リード/ライトのビットを持つ。
- すべてのトランジションを記録する。
    - grepやスプレッドシートはともだち。
    - トランジション数やタイプなどをチェックする。
- トランジション数は書き込み可能なリソースの数の順にすべき。
    - 9000以上だったら、何かがおかしい。

- 全部バリアするモードを持つ。
    - 最悪のケースと同じような状態。
    - デバッグ用。
- リソースがフレーム毎に少なくとも1度は既知の状態にあることを保証する。
    - 例えば、フレームの終わりや始まり。
    - TAAやシャドウアトラスの破損のような問題を解決するため、すべてを既知のステートに遷移する。

## その先へ(Going forward)

- より良い、イベント的に。
    - トランジションを扱うドライバ時間を与える。
    - D3D12では"Split barrier"
    - vkCmdSetEvent + vkCmdWaitEvents

## まとめ: バリア

- 必要とするリソースすべてをトランジションすることを確かめる。(それ以上はしていないことも確かめる。)
- できる限り最大限特有のステートに移行する。
- 様々なステートを組み合わせることができることを忘れない。
