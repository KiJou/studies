---
title: Stupid Spherical Harmonics (SH) Tricks [@Sloan2008]
numberSections: false
---
# 要約

この論文は同名のGDC 2008の講義の手引である。これは、球面調和関数(SH)[Spherical Harmonics]の簡潔な概要を提供し、インタラクティブグラフィクスにおいて使用可能ないくつかの方法と発生するかもしれない問題を議論する。特に、「SHを用いて効率的にライティングモデルを求める方法」、「"リンギング[ringing]"とは何か、そして、それについてできることは何か」、「SH積の効率的な求め方とそれが使われる所」、といった問題に焦点を当てる。最新バージョンは[http://www.ppsloan.org/publications](http://www.ppsloan.org/publications)で入手できる。

# はじめに

ラプラス方程式[Laplace's equation][@2]の解である調和関数[harmonic functions]は様々な分野で広く用いられる。球面調和関数は球に制限したときの解である^[これらは球座標における解の角度部分である。]。これは物理学において熱方程式[heat equation] (時間上の温度変化のモデル化[@5; @25])、重力場や電場[@9]のようなポテンシャルの問題を解くために使われてきた。量子化学や量子力学では原子の電子配置[electron configuration]や量子角運動量[quantum angular momentum]をモデル化するためにも用いられてきた[@16; @51]。グラフィクスに近い所では、散乱現象をモデル化するために使われてきた。コンピュータグラフィックスにおいて、これは広く使われてきた。初期には、ボリューメトリック散乱効果[@18]、大局的な影を持たないマイクロファセットBRDFのための環境反射[@6]、ディフューズでないオフライン光輸送シミュレーション[@40]、BRDF表現[@53]、画像の再ライティング[@28]、制御可能なライティングを伴う画像ベースレンダリング[@54; @55]、光源発光のモデル化[@8]、といった所で使われた。時代が下ると、異方性散乱[@50]やコンピュータビジョン[@3]における研究が増えてくる。

本論の中心はインタラクティブグラフィクスに関連する技術にある。ゲームにおいて広く使われてきた最初の論文は効率的に球面調和関数を用いて放射照度環境マップを表現することで対処する[@35]ものであり、遠方の照明の下にあるディフューズオブジェクトのインタラクティブレンダリングを可能にする。これは同じ制約を持つ制限されたBRDFの種類を扱うために拡張された[@36]。Precomputed Radiance Transfer(PRT)[@41 @20; @24]はライティング環境への静的なオブジェクトやシーンの反応をモデル化するものであり、しばしばSHを用いて表現され、ソフトシャドウやディフューズと単純な艶やかな[glossy]マテリアルとの相互反射のような複雑な大域照明効果を含む。これは、より一般的なBRDFモデルを扱うため[@20; @23; @42]、表面下散乱を組み込むため[@42]、機械学習による圧縮技術を通じてレンダリング効率を大幅に改善するため[@42]、表面の詳細のような"局所的"なテクスチャをモデル化する様々な技術を扱うため[@43; @44; @45]に拡張された。SHは遠方のライティング環境による単一散乱をモデル化するために使われてきた[@49]。他には、遠方のライティング仮定を持ち上げる[lift]ために勾配を用いるとき[@1]、相互反射のサポート[@46; @33]を含めた動的オブジェクトに対処するいくつかの技術において[@56; @37]、一般的なBRDFモデルを持つオブジェクトのシャドウイングをモデル化するための可視性の表現として[@12]、変形可能なオブジェクトからの影をモデル化するためにスケーリング操作を用いるとき[@52]、屈折のパラメータ化として[@11]、法線マップによるLevel of Detailの問題に対処するための技術として[@15]用いられる。

より実践的な論文には、PRTの実装の詳細をカバーするもの[@13]、エンジンにこれらの技術を統合する方法[@30]、放射照度ボリュームに対してSHと勾配を使う方法[@31; @32]、投影に関する実践的な問題とSH係数を効率的に量子化する方法[@21]、解析的なスカイライトモデル[@34]をSHに投影して、モデルのパラメータの関数としてSHライトプロブを求めるために大局的多項式フィッティング[global polynomial fit]を用いる良い論文[@14]が含まれる。また、SHを用いて半球上に定義されるよりロバストな投影関数の計算技術[numerical techniques]も調査されてきた[@22]。

リアルタイムグラフィクスでの多くは、可視性、ライティング、反射率として、単に球面関数を表現する便利な方法として用いられる。他に、ウェーブレット[@39]、キューブマップ上のウェーブレット[@27]、球面放射基底関数[spherical radial basis functions][@9]、など[@26]の使用可能な基底関数が多く存在するが、球面調和関数はこの文書で述べられるであろういくつかの素晴らしい特性を持つ。これらのその他の基底関数がより適切となるシナリオが存在することを強調することは重要である。

球面調和関数は幾分手強そうに見えるかもしれないが、実のところ素直である。これは単位円上のFourier基底に類似した球上のソレであり、数値的に計算し易い。信号処理において用いられるFourier基底のように、発生し得る"リンギング"アーティファクトを最小限にするため、(ビデオゲームでは常に行われるであろう)級数の打ち切りを行うときには気を付けなければならない。本論は、球面調和関数を用いて効率的に光を計算および表現する方法、SH表現から従来の光を取り出す方法、"リンギング"の説明とその影響を最小限にする軽減技術、球面調和関数を用いる関数の積の調査を述べる。そこで述べられるのは、これが有用である点と、最適化する価値がある特殊ケースについてである。

# 背景

#### 定義

球面調和関数は球$S$上の正規直交^[正規直交基底は、$\int f_i f_j = \delta_{ij}$が$i = j$のとき$1$、それ以外のとき$0$となる特性を持つものである。]基底を定義する。用いるパラメータは以下となる。

$$
s = (x, y, z) = (\sin\theta\cos\varphi, \sin\theta\sin\varphi, \cos\theta)
$$

ここで、$s$は単純に単位球上の位置[locations]である。この基底関数は以下のように定義される。

$$
Y_l^m(\theta, \varphi) = K_l^m e^{im\varphi} P_l^{|m|}(\cos\theta), l \in \boldsymbol{N}, -l \le m \le l
$$

ここで、$P_l^m$はLegendre陪多項式[associated Legendre polynomials]であり、$K_l^m$は以下の正規化定数である。

$$
K_l^m = \sqrt{\frac{(2l + 1)(l - |m|)!}{4\pi(l + |m|)!}}
$$

上記の定義は(グラフィクスでない界隈で最も一般的に使われる)複素形式によるものであり、実数値基底[real valued basis]は以下の変換によって求められる。

$$
y_l^m = \left\{ \begin{array}{c}
    \sqrt{2}\text{Re}(Y_l^m) & m > 0 \\
    \sqrt{2}\text{Im}(Y_l^m) & m < 0 \\
    Y_l^0 & m = 0
\end{array} \right. = \left\{ \begin{array}{c}
    \sqrt{2}K_l^m \cos m\varphi P_l^m(\cos\theta) & m > 0 \\
    \sqrt{2}K_l^m \sin |m|\varphi P_l^{|m|}(\cos\theta) & m < 0 \\
    K_l^0 P_l^0(\cos\theta) & m = 0
\end{array} \right.
$$

添字$l$は"バンド[band]"を表す。各バンドは多項式の次数[degree]と等価であり(すなわち、0は単なる定数関数、1は線形、など)、与えられたバンドには$2l+1$個の関数が存在する。球座標は積分を計算するときに便利であるが、これらを求めるときに一般的に行われるように、多項式を用いて表現することもできる(詳細は[@sec:A1]と[@sec:A2]を参照)。次数[order][^degree_and_order]$n$のSH展開は次数[degree]$n-1$までのすべての基底関数を用いる。

[^degree_and_order]: 訳注:本文書では、SHに対する"order"は「次数」とし、多項式に対する"degree"は注記付きで「次数[degree]」とする。

![](assets/SH_vis.png)

球面調和関数はいくつかの方法で可視化できる。ある標準的な方法では、関数の絶対値で同心円状に各点をスケーリングして、符号に基づいて(正なら赤に、負なら青に)色付けすることで、単位球を歪ませる。上の図はこの技術を用いた最初の3つのバンドの画像である。

中央の列($l = 0$)にある関数はZonal Harmonics(ZH)と呼ばれ、後に述べれれるだろうが、これらの関数はZ軸周りに回転対称性を持ち、そのゼロ(関数が0となる位置)はXY平面に並行な球上の輪郭[contours]である。($l = |m|$)にある関数はSectorial Harmonicsと呼ばれ、そのゼロはリンゴのスライスのような領域を定義する。

代替案として、平面に展開したキューブマップのパラメータ化を用いて描画して可視化する方法がある。キューブマップの展開は以下のようになる。

![](assets/cubemap_unfolding.png)

ここでは、大きさ[magnitude]は色(正は赤、負は青、ゼロは緑)にエンコードされ、等強度線[iso-intensity contours]は関数の勾配に対するさらなる直観を得るために(白で)均等に配置されている(間隔が狭いと関数が素早くに変化する、など)。

#### 投影と再構築

SH基底は正規直交であるので、$S$上に定義されるスカラ関数$f$の最小二乗投影[least squares projection]は基底関数に対して投影したい関数$f(s)$を単純に積分することで行われる(証明は[@sec:A6])。

$$
f_l^m = \int f(s)y_l^m(s) ds
$$

これらの係数は関数$f$の近似を再構築するために使用できる。

$$
\tilde{f}(s) = \sum_{l = 0}^n \sum_{m = -l}^l f_l^m y_l^m(s)
$$

これは、バンド数$n$を増やすごとにますます正確になる。本論は$f$への低周波近似に専念するため、より高い周波数表現では他の基礎の方が良い仕事をする傾向にある。$n$次への投影は$n^2$個の係数を生成する。以下を介して投影係数と基底関数の両方に対する単一の添字[index]を用いることはしばしば便利である。

$$
\tilde{f}(s) = \sum_{i = 0}^{n^2} f_i y_i(s)
$$

ここで、$i = l ( l + 1) + m$である。この方程式は近似関数の方向$s$での計算が$n^2$個の係数ベクトル$f_i$と求めた基底関数$y_i(s)$の内積であることを明確にする。第1係数($f_0^0$または添字付けに依存する$f_0$)は球上の関数の平均値を表現し、DC項と時折呼ばれる。

#### 基本的な特性

SHの重要な特性のひとつは投影がとのように回転と相互作用するかということである。回転行列$Q$によって回転された$f(s)$を表現する関数を$g(s)$とすると、すなわち、$g(s) = f(Q(s))$であり、$g$の投影は$\tilde{f}$を回転して再投影することに等しい。この回転不変性[rotation invariance]はFourier変換における並進不変性[translational invariance]に似ている。これは、例えば、ライティングが回転に対して安定となるであろうこと、すなわち、エイリアシングアーティファクトや光源の"ぐらつき[wobbling]"が起こらないであろうことを意味する。下図は方向光源によって照らされる球の画像であり、上段はSHを用い、下段はValveによるアンビエントキューブ基底^[この基底はSHを求めるより効率的であり、6つの基底関数のうち任意の球上の点で非ゼロとなるのは3つのみである。]を用いている。この基底は[@sec:A9]でより詳細に述べられる。これは球上に定義される他の任意の基底である程度発生するだろう。SH基底の正規直交性により、$a$、$b$を任意のSH関数とすると、積の積分は係数ベクトルの内積である。すなわち、$\int \tilde{a}(s) \tilde{b}(s) = \sum_{i = 0}^{n^2} a_i b_i$である。

#### 畳み込み

円対称性を持つカーネル関数を$h(z)$とすると、このカーネルと元の関数$f$との畳み込みの結果として新しいSHを生成できる。$h$は、回転群[rotation group]$SO(3)$ではなく球$S$上でも表現されるようにするため、畳み込みの結果に対して円対称性を持たなければならない。畳み込みは以下の数式を用いて周波数領域で直接行うことができる。

$$
(h * f)_l^m = \sqrt{\frac{4 \pi}{2l + 1}} h_l^0 f_l^m
$$

これは$h$の対応する$m = 0$項によって$f$の各バンドを単純にスケーリングすることに等しい。

#### 回転

前述した通り、SHは回転に対して閉じている。SH回転行列はブロック構造にあり、そのとき、各バンドは回転に対して独立であり、密な$(2l+1) \times (2l+1)$の部分行列[submatrix]を持つ。この回転行列を計算する方法はいくつかあり、非常に低次(二次以下)では記号的に[symbolically]行うことが最も効率的であるが、それより高次では回転行列をZ-Y-Z系のEuler角に分離する方がより効率的であるように思われる[@19]。

#### Zonal Harmonics

ある軸の周りに回転対称性を持つ関数を球面調和関数に投影したものはZonal Harmonics(ZH)と呼ばれる。それが配向している、すなわち、この軸がZ軸であるならば、関数のゼロは一定の緯度線を形成し、その関数は$\theta$のみに依存するだろう。この配向性における係数ベクトルはバンドあたりの非ゼロがひとつだけであるので、$n$次の関数は$n^2$個ではなく$n$個の係数を持つ。Zonal Harmonicsは輸送[transfer]を近似するのに使われ[@44]、そして、散乱理論における位相関数の一般的な表現であり[@7; @17]、これは本論において光源をモデル化するときに広範囲に使われるだろう。Zonal Harmonicsの回転は一般的なSHより単純であり、事実上[effectively]対角行列であるもので行われることができ、新しい方向$d$におけるSH基底関数を求めることのみを要求する。(SH投影の$m = 0$項のみの)関数のZH係数を$z$とすると、以下の式を用いて新しい方向$d$へ回転させることができる。

$$
f(s) = \sum_l z_l \sqrt{\frac{4 \pi}{2l + 1}} \sum_m y_l^m(d) y_l^m(s)
$$

すなわち、SH係数は以下のようになる。

$$
f_l^m = \sqrt{\frac{4 \pi}{2l + 1}} z_l y_l^m(d)
$$

#### SH積

SHに投影された$n$次のSHを用いて表現される2つの関数$f$と$g$の積の$k$番目の係数は以下の形式を持つ。

$$
p_k = \int y_k(s) \left( \sum_{i = 0}^{n^2} f_i y_i(s) \right) \left( \sum_{j = 0}^{n^2} g_j y_j(s) \right) ds = \sum_{ij} \Gamma_{ijk} f_i g_j
$$

ここで、$\Gamma$は三重積のテンソル[triple product tensor]である。

$$
\Gamma_{ijk} = \int y_i(s) y_j(s) y_k(s) ds
$$

これは階数[order]3の疎な対称テンソルである。SHは多項式であるので、多項式の積は最大次数[maximal degree]$2n-2$を持つだろう。このとき、次数$2n-1$までの非ゼロの係数を持つであろうことを意味する。これは乗算されている関数の数が増えるにつれて扱いづらくなるので、早期に積を切り詰める[truncate]のが一般的である[@56; @37]。$n$の関数としての非ゼロの係数の数はかなり大きい[@47; @37]ので、効率的なコードを生成するときには注意するしなければならない。ある特殊な場合では[One special case that is useful to point out is that]、$f$が固定される(すなわち、遠方のライディングである)ならば、そのコストを大幅に削減するであろう"積の行列[product matrix]"$M_f$を計算することができる。この行列は対称であり、以下の式を用いて作られる。

$$
(M_f)_{ij} = \sum_k \Gamma_{ijk} f_k
$$

この場合における関数$g$との積の計算は単純な行列とベクトルの積となる。

# 放射照度環境マップ

放射照度環境マップ[irradiance environment map]はライトプロブとクランプされたコサイン関数との畳み込みによって生成される。これは放射輝度を表すために$\pi$で除算して正規化されるべきである。この畳み込みはSHを用いて効率的に行われることができ[@35]、同様に、直接的にSHから効率的にレンダリングされるのに十分な正確さを持つ。次数3のSHはこのカーネルを近似するのに良い働きをするが、HDR光源を用いているならば、次数5の使用を検討したくなるだろう(次数4のZHの係数はゼロなので、そのバンドは省略できる)。下図はクランプされたコサイン関数と次数3のSH近似の画像であり、赤の曲線がSH近似を示す。左側の図は$\theta$の関数としてのプロットであり、右側の図は関数の絶対値でスケールした極座標プロットである。

![](assets/sh3_plot.png)

下図は次数5の投影(青)も含めたプロットである。

![](assets/sh5_plot.png)

次数3のSH近似は$\theta = 0$(北極)で$\frac{1}{16}$だけ過剰推定し、南極に大きさ$\frac{1}{16}$を持つ不要なローブ[spurious lobe]を持つ。17の値を反射する方向光源は、法線がその方向を指すとき、反対方向に向かって1の値を反射するだろう(0を反射しているべきなのに)。次数5の近似は、同様の方向を指す法線で31を反射する方向光源では-1を反射するであろう、負のローブを持つ。これらの近似は正確であるが、特に非常に明るい光源を用いている場合、誤差を引き起こし得る。

[@sec:A10]は放射照度環境マップを効率的に求めるためのシェーダおよびCPUコードを含む。

# ライティングモデル

SHにはライディングを表現する方法が様々存在する。最も簡単なものとして単にキューブマップから投影する方法があるが、計算が高価でなく、アーティストへ公開するものとして有用である可能性を秘めた解析モデルも存在する。最近の論文[@14]では実用的なスカイライトモデル[@34]をSHに投影し、そのモデルのパラメータ空間上でSH係数の大局的多項式フィッティングを行う。

## キューブマップからの投影

キューブマップから投影するためには、キューブマップに対してSH基底関数を積分する必要がある。これは各テクセルの中心の方向においてSH基底関数を求めて、そのテクセルに対する微分立体角[differential solid angle]で重み付けして、その結果を正規化することで数値的に行われることができる。以下はその擬似コードである。

```pseudo
float f[], s[];
float fWtSum = 0;
Foreach(cube map face)
    Foreach(texel)
        float fTmp = 1 + u^2 + v^2;
        float fWt = 4 / (sqrt(fTmp) * fTmp);
        EvalSHBasis(texel, s);
        f += t(texel) * fWt * s; // ベクトル
        fWtSum += fWt;
f *= 4 * Pi / fWtSum; // 球の面積
```

上記のコードにおいて、`u`と`v`は+1または-1^[すなわち、+X面上では、yとzになるだろう。]でない与えられた面上の2つの座標を表し、`t(text)`はテクセルの色である。`EvalSHBasis`は(キューブ面での)入力座標を正規化する必要があり、その方向におけるSH基底関数を計算する。(特に低解像度のキューブマップを用いるときに)多少ずれる傾向はあるが、微分立体角の正規化された合計は$4\pi$となるはずなので、最後の正規化は省略できる(代わりに、サンプル数で割ることができる)。

下図はHDRライトプロブを次数1から6の球面調和関数に再構築した画像である。最終的に、画像は投影されたライトプロブとなる。

## 解析モデル

方向光の計算は自明であり、与えられた方向にSH基底関数を求めて適切にスケールするだけで良い([@sec:Normalization]を参照)。球光源はZonal Harmonicsを用いて効率的に求めることができる。下図はシーンの例を示す図であり、レシーバ[receiver]の位置$P$での入射する放射輝度、球関数を計算したい。中心$C$、半径$r$の球光源があるとすると、$d$だけ離れている点$P$に到達する放射輝度は幾らか？光源のなす半角のサインは$\frac{r}{d}$であるので、球の適切な部分に対する[subtend]光源を計算する必要がある。ZH係数はこの角度の関数として閉形式で計算できる。すなわち、$\int_{\theta = 0}^a \int_{\phi = 0}^{2\pi} y_l^0 d\phi d\theta$である。ここで、$a$はそのなす半角である。次数6までの式については[@sec:A3]を参照。

![球光源](asserts/spherical_light_source.png){#fig:1}

球での技術は一定の放射[emission]を持つ円錐(無限大にある円板として考える)をモデル化するのにも使用できる。より柔らかい円錐は可視部分で滑らかな減衰[fall-off]を持つようにモデル化できる^["ease spline"が用いられる。これは制約$f(0) = 1, f'(0) = 0, f(a) = 0, f'(a) = 0$を持つ三次多項式$f(x)$であり、一意に定まる三次多項式は$f(x) = \frac{2x^3}{a^3} - \frac{3x^2}{a^2} + 1$である。] --- 式は[@sec:A4]を参照。

列は次数4と6のものを表し、上段は円錐の投影を、下段は滑らかな減衰を持つ円錐を表す。角度は90°(緑)、45°(赤)、30°(青)、12.5°(黒)である。破線は実際の関数を表し(重ならないようにちょっとだけ円錐に対してずらしてある)、実線はSH近似を表す。一般に、柔らかい円錐のほうが行儀が良い。投影おいて発生するアーティファクトに対処する方法は以下の[@sec:Ringing]の主題である。

### 正規化 {id="sec:Normalization"}

[0, 1]のライティングが用いられているならば、光源を直接指す法線を持つ影に隠れていない[unshadowed]レシーバに対して反射した放射輝度が1.0になるだろうから、放射輝度ベクトルを正規化するのに便利である。数学的にスケールファクタ$c$を計算したいとする。これは、ライティングベクトル$L$で乗算してベクトル$T$に対して積分すると反射した単位放射輝度になり、遮蔽されていないクランプされたコサインローブを表す(正規化されたクランプしたコサインのSHへの投影)。すなわち、以下となる。

$$
1 = \int c L(s) T(s) ds \xrightarrow{yields} c = \frac{1}{L \cdot V}
$$

正規化ファクタを計算するときは、レンダリングで使用したいバンドのみを使うべきである。$T$を$+Z$と並行にすると、単純な解析式[analytic formula]が得られる。ここでは最初の6つのバンドに対する$T$の係数を示す。

$$
\frac{1}{2 \sqrt{\pi}}, \frac{\sqrt{3}}{3 \sqrt{\pi}}, \frac{\sqrt{5}}{8 \sqrt{\pi}}, 0, \frac{-1}{16 \sqrt{\pi}}, 0
$$

解析的な光では解析的な正規化項を用いることができ、角度$a$の円錐光では以下になる。

$$
\frac{1}{\sin^2 a}
$$

しかし、クランプしたコサイン関数と光源の両方の投影誤差が考慮されていないので、結果の光は単位放射輝度を反射しない。方向光^[これは4次より大きいライティングを仮定していない。5次および6次では正規化ファクタは$\frac{32\pi}{31}$となる。]では正規化ファクタは$\frac{16\pi}{17}$となり、"アンビエント"光では$2\sqrt{\pi}$となる。

## SHからの従来の光の抽出

SHのライティングベクトルを仮定すれば、単一の方向光源とアンビエント光源として近似することができる。これは頂点シェーダをサポートしないハードウェア上で使われていた。数学的に、反射した放射輝度の二乗誤差が任意の表面法線($N$)に対して最小化するように、方向光の強度($c$)とアンビエント光の強度($a$)を計算したいとする。光源に対する固定の距離($d$)を仮定すると、最小化したい誤差関数は以下のようになる。

$$
E(c, a) = \int \left( cH_N(d) + a - \int L_e(s) H_N(s) ds \right)^2 dN
$$

ここで、$H_N(x) = \text{max}(\frac{N \cdot x}{\pi}, 0)$は正規化されたクランプしたコサインである。ライティング$L_e(s)$がSHで表されるならば、これは単純な解を持つ。新しいライティング環境で表される放射照度環境マップはできるだけ入力の放射照度環境マップに近くあるべきである --- これら2つの環境マップの二乗誤差を最小化することはすべての法線で反射した放射輝度を最小化することと等価である。

$$
E(c, a) = \int (cL_d(s) * H_N(s) + aL_a(s) * H_N(s) - L_e(s) * H_N(s))^2 ds
$$

ここで、$L_d(s)$は方向$d$における正規化されたSHの方向光であり、$L_a(s)$は正規化されたSHの定数光である(単にDCに依存する)。$a$と$c$の最適な値は以下となる。

$$
\begin{array}{ccl}
    c & = & \frac{867}{316\pi} \text{dot}(\hat{L}_d, \hat{L}_e) \\
    a & = & \left( \hat{L}_e[0] - c \frac{8\sqrt{\pi}}{17} \right) \frac{\sqrt{\pi}}{2}
\end{array}
$$

上記のライティングベクトルはすべて正規化されたクランプしたコサインカーネルとの畳み込みによって放射照度環境マップに変換される。上記の内積はDC項を無視し、$\hat{L}_e[0]$はライティング環境のDC項である。上記は既知の方向を仮定する。その候補となる方向は"最適線形[optimal linear]"な方向[@44]であり、ベクトル$(-\hat{L}_e[3], -\hat{L}_e[1], \hat{L}_e[2])$を正規化することで形成される。これは、ライティング環境の線形な係数である。

## 複数の光の抽出

SHライトプロブから複数の光を抽出することもできる。これは、(解析的な光は負のローブを持たないので)リンギングに対抗するため、(この方法で取り出される光源による)艶やかな[glossy]反射をモデル化するため、少数のシャドウZバッファを用いる(BRDFの拡散と光沢[glossy]の両部分のために光を取り出す)ために行われるかもしれない。最適線形な方向はライトプロブが単一の光源によって支配されるときに正常に動作する。そうでないには、方向と強度は何らかの方法で最適化される必要がある。これを行う方法のひとつに、関数の極大[local maxima]を見つけるために"上り坂[up hill]"を登ることがある。SHの滑らか具合が与えられたとき、与えられた次数に対して有限の距離が存在し、そこでは、明確な[distinct]ピークから遠ざかる任意の点が最急上昇法[gradient ascent]を用いてその点に到達することが保証される[Given how smooth SH are, for a given order there is a finite distance where any point that distance from a distinct peak is guaranteed to reach the point using gradient ascent.]。点の集合はそのVoronoi^[球上の点の集合を$X$とすると、与えられた点$x_i$のVoronoi cellはその集合における他のいかなる点より$x_i$に近い球上のすべての点を含む。] cellの中心から最も遠い球上の点がこの距離より小さいという特性によって生成できる。これらの点のそれぞれから探査を始めるならば、極大点のすべてを見つける必要がある。これらの距離は、デルタ関数の投影を調べて、ピークとゼロとの角距離[angular distance]を計算することで見つけることができる。この半径の$\frac{2}{3}$の控えめな推定[conservative estimate]を用いると、次数ごとに必要となる点の数は最初の6つの次数では{1, 3, 6, 10, 15, 22}となる。

この点の集合はシミュレーションを計算することで計算できる。すなわち、すべての点が他のすべての点に作用するある減衰(例えば$1/d^2$、$d$はそれらのユークリッド距離)を伴う力を持つとする。各点で作用する合力[net force]を生成し、(これは単なる接線力[tangential force]なので)垂直成分[normal component]を差し引いて、重み$w$と一緒にこの力によって点を移動する。合力の合計が増加するならば、$w$を半分に減らして再度行い、減少するならば、$w$を倍にして再度行う。これはelectrostatic chargesの合計を最小化する電子の集合を解いている。

SHライティング環境を$L(s)$として、極大となる球上の点を見つけたいとする。これは、$-L(s)$の極小[local minima]を見つけることと同じことである。これは非線形最適化問題であり、経験上BFGS法の反復をいくらか行えばそのピークに収束する。基底関数の勾配は最適化手法を用いるときに計算される必要がある。球上の点に対して、多項式の微分は自明であるが、その点が直線探索[line search]を行うときに球を離れられるようにする必要がある。そのため、係数を正規化する記号的な入力を用いたい(すなわち、$f(x, y, z)$の代わりに$f(\frac{x}{\sqrt{x^2 + y^2 + z^2}}, \frac{y}{\sqrt{x^2 + y^2 + z^2}}, \frac{z}{\sqrt{x^2 + y^2 + z^2}})$)。これは正規化された位置での勾配を計算して以下の正規化関数のヤコビアンで乗算することで行われる。

$$
\left[ \begin{array}{ccc}
    \frac{L^2 - x^2}{L^3} & \frac{-xy}{L} & \frac{-xz}{L} \\
    \frac{-xy}{L} & \frac{L^2 - y^2}{L^3} & \frac{-yz}{L} \\
    \frac{-xz}{L} & \frac{-yz}{L} & \frac{L^2 - z^2}{L^3}
\end{array} \right]
$$

ここで、$L$は$\sqrt{x^2 + y^2 + z^2}$である。

![](assets/multiple_lights.png)

上図は3個、2個、1個の方向光とアンビエント光で近似したときの放射輝度(上段)および放射照度(下段)ライティング環境の比較画像である。$N$個の(大きさの観点で)最重要なピークがあるとすると、これは最小二乗的に方向およびアンビエント強度を解く。

2つのローブに対する光の強度を計算するための式は以下となる。

$$
\left[ \begin{array}{c}
    c_0 \\
    c_1
\end{array} \right] = \left[ \begin{array}{cc}
    \frac{A}{A^2 - B^2} & \frac{-B}{A^2 - B^2} \\
    \frac{-B}{A^2 - B^2} & \frac{A}{A^2 - B^2}
\end{array} \right] \left[ \begin{array}{c}
    L_e \circ L_{d0} \\
    L_e \circ L_{d0}
\end{array} \right]
$$

ここで、$A = L_{d0} \circ L_{d0}, B = L_{d0} \circ L_{d1}$である。

そのアンビエント項は以下である。

$$
a = (L_e[0] - (c_0 L_{d0}[0] + c_1 L_{d1}[0])) \frac{\sqrt{\pi}}{2}
$$

3つの光に対して、その強度は以下となる。

$$
\left[ \begin{array}{c}
    c_0 \\
    c_1 \\
    c_2
\end{array} \right] = \left[ \begin{array}{ccc}
    \frac{A^2 - D^2}{E} & \frac{CD - AB}{E} & \frac{BD - AC}{E} \\
    \frac{CD - AB}{E} & \frac{A^2 - C^2}{E} & \frac{BC - AD}{E} \\
    \frac{BD - AC}{E} & \frac{BD - AD}{E} & \frac{A^2 - B^2}{E} \\
\end{array} \right] \left[ \begin{array}{c}
    L_e \circ L_{d0} \\
    L_e \circ L_{d1} \\
    L_e \circ L_{d2}
\end{array} \right]
$$

ここで、$C = L_{d0} \circ L_{d2}, D = L_{d1} \circ L_{d2}, E = 2BCD + A(A^2 - B^2 - C^2 - D^2)$である。

この行列は対称であり、そのアンビエント係数は以下である。

$$
a = (L_e[0] - (c_0 L_{d0}[0] + c_1 L_{d1}[0] + c_2 L_{d2}[0])) \frac{\sqrt{\pi}}{2}
$$

これらの式の導出は[@sec:A5]にある。

自由度(方向と強度)のすべてを追加して非線形ソルバを用いると、初期の推測として上記の技術を用いるとすれば、より高品質な結果を生成するだろう。

# リンギング {id="sec:Ringing"}

リンギングは、Gibbs現象とも呼ばれ、信号処理における一般的な問題である。不連続性[discontinuity]を持つ信号が(連続的な関数のみを表現できる)有限のFourier基底に投影されるとき、オーバーシュート[overshoot]やアンダーシュート[undershoot]がその不連続性の周囲に発生する。不連続性を持たない関数でも投影が切り詰められる[truncated]場合に同様の挙動を示す可能性がある。我々は、ライティングモデルを調査するとき、そして、放射照度環境マップの表現(クランプしたコサイン関数の投影)において、これらの問題をすでに確認していた。同様の問題は表面設計[surface design]において発生する。ここでは、一連の幾何的制約を満たそうとするとき、望ましくない振動[oscilations]が発生する可能性がある。これらの問題には2つの一般的な解法が存在する。

1. 切り詰めた投影係数にシグマファクタを用いて窓を掛ける[windowing]方法。これは信号処理において最も一般的な解法であり、球面調和関数で自明に使用できる[@8; @41; @37]。
2. 標準の最小二乗誤差ではなく、変分関数[variational function]のいくつかの形式を最小化する方法(例えば、曲率の大きさを最小化する)。これはコンピュータを利用した幾何的設計[computer aided geometric design]において一般的に行われるが、球面調和関数を用いて効率的に行われることもできる[@38]。

## 窓掛け[^windowing]

[^windowing]: 信号処理における"窓を掛ける[windowing]"という用語は空間領域においてより一般的に使用される。例えば、画像をフィルタリングするときにフィルタの空間的な大きさが"窓掛け"され、1Dの信号のFFTを取るときにその信号は周期的にするためにスケールされるかもしれない。本論において、これらは周波数領域において行われている。

リンギングアーティファクトを最小化する方法のひとつに、カットオフ周波数に近づくにつれてゼロに漸減[taper]する投影係数を持つカーネルを周波数領域において乗算する方法がある。この関数は切り詰めた周波数帯でゼロに到達するように引き伸ばされたsinc関数[^sinc]であり、Lanczosのシグマファクタ[^Lanczos_sigma_factors]を用いる、と言われる。直観的に、(1Dで)これが行っていることは、その関数を過度な[excessive]リンギングなしで表現されるのに十分な滑らかさにするための、空間領域におけるタイトなボックス関数との畳み込みである。Gibbs現象に対抗するより洗練された方法[@10; @4]が存在するが、これらはゲーム用として便利ではないであろう区分的な解析関数を生成するのにSH係数を用いる。

[^sinc]:<!-- HACK -->$\text{sinc}(x) = \frac{\sin x}{x}$であり、$x = 0$のとき最大値$1$となる。

[^Lanczos_sigma_factors]: 時折シグマファクタはGibbs現象をより積極的に減らすために持ち上げられる[be raised to a power]だろう。これは、その信号を繰り返し畳み込むのと同等である。

![](assets/window_functions.png)

経験上、窓関数の選択はリンギングとブラーリング[blurring]の間をトレードオフするために柔軟性を持つことほど重要ではない。左の画像は6次のSH用にスケールされた2つの窓関数(赤はsinc、青はHanning窓と呼ばれるraised cosineローブ)を示している(7次のバンドではゼロに達するので、使われる最後の値は5次で求められ、その関数は整数でのみ求められるだろう)。Hanning関数はLancosz関数より速く減衰[decay]する。これは、より積極的にそれをブラーさせる^[Lancoszの二乗はHanning関数に近いが、少しだけ速く減衰する。2.25の高さとなるデルタ関数の再構築では、Hanning関数は大きさ12.0105の窓を必要とし、Lancoszは大きさ9.8725の窓を必要とする。その結果は見た目には区別できないように見える。]。

![](assets/sigma_factors.png)

上図はLanczosおよびHanningのシグマファクタを用いた結果を示す。投影されている信号は次数6のデルタ関数である。これは、SHに投影できる"最大ピークの[peakiest]"信号であり、リンギングアーティファクトを示す。デルタ関数の投影はZHでありので、これらは球の断面[cross section]を示し、$\phi$は固定される。放射状の大きさがプロットされ、ローブの符号は互い違いになる。

すべてのグラフを一緒に見ると(赤はデルタ関数のそのままの投影を示す)、窓掛けがどれだけ信号をブラーしつつ、リンギングを除去しているかを確認できる(図の原点近くに見られる)。

![](assets/all_sigma_factors.png)

## 汎関数[functional]の最小化

代わりのアプローチとして、二乗近似誤差に加えていくつかの関数を最小化することを試みる。これを行う方法のひとつに、一連の制約を満たし(例えば、少数の点での厳密な再構築)、そして、いくつかの誤差汎関数[error functional]を最小化するために(十分な自由度があると仮定して)余りの"スラック[slack]"変数を用いる方法がある[@38]。ゲームやグラフィクスでしばしば用いられる低いSH次数であれば、このアプローチは実践的であるように思えないので、これ以上の時間を費やすことはないだろう。代替案として、大きな振動に不利となるノルムを最小化することを試みる。これは素直なやり方で球面調和関数で行われることができる。Laplace作用素[operator]、または、Laplacianはスカラ関数の勾配の発散[divergence]であり、非混合偏微分[unmixed partial derivatives]の和と等価である。

$$
\Delta f = \frac{\partial^2 f}{\partial x^2} + \frac{\partial^2 f}{\partial y^2} + \frac{\partial^2 f}{\partial z^2}
$$

単位球上の球面座標では、これは以下のようになる。

$$
\Delta f = \frac{1}{\sin\theta} \frac{\partial}{\partial\theta} \left( \sin\theta \frac{\partial f}{\partial\theta} \right) + \frac{1}{\sin^2 \theta} \frac{\partial^2 f}{\partial \phi^2}
$$

二乗Laplacianの積分は球上で用いられる曲率の大きさである[@38]。その最小化したい関数は以下となる。

$$
E(c) = \int \left( \tilde{f}(s) - f(s) \right)^2 ds + \lambda \int \left( \Delta \tilde{f}(s) \right)^2 ds
$$

これに若干の調整を加えたい。生の投影係数$f_l^m$は既知であるので、重み付けされた二乗Laplacianを最小化しつつも、できるだけ最小二乗の結果に近い新しい係数$c_l^m$を見つけたい。これは閉形式で行われることができ([@sec:A6]参照)、$\lambda$与えられると最終的に以下の係数になる。

$$
c_l^m = \frac{f_l^m}{(1 + \lambda l^2 (l + 1)^2)}
$$

これは$\lambda$に依存する窓関数に等しいことに注意する。$\lambda$がゼロのときは最小二乗の係数が得られ、$\lambda$が無限大のときは曲率がゼロでありDC項が得られる。$\lambda$を選ぶアプローチのひとつに、固定量、例えば、半分に二乗Laplacianを減らして解く方法がある。これはいずれかの標準の求根[root finding]テクニックを用いて行われることができる。Newtons法を用いてこれを行う方法の説明は[@sec:A7]を参照のこと。下図は6次のデルタ関数を二乗Laplacianが元の10%($\lambda = 0.004209$の緑)、50%($\lambda = 0.000632$の青)になるように解いた結果である。最後のプロットはデルタ関数それ自身と合わせたものである。

![](assets/squared_laplacian.png)

TODO

# A1 {id="sec:A1"}

# A2 {id="sec:A2"}

# A3 {id="sec:A3"}

# A4 {id="sec:A4"}

# A5 {id="sec:A5"}

# A6 {id="sec:A6"}

# A7 {id="sec:A7"}

# A9 {id="sec:A9"}

# A10 {id="sec:A10"}
